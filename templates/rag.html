<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ¸¸çµ - ç©ºé—´æ„ŸçŸ¥RAGæ–‡åŒ–æ—…è¡Œè§„åˆ’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "SimHei", sans-serif;
            background-color: #f5f5f5;
            height: 100%;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #005cb2 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .back-btn {
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            color: white;
            transform: translateX(-5px);
        }
        
        .back-btn i {
            margin-right: 5px;
        }
        
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: none;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .route-day {
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e88e5;
            padding-left: 1rem;
        }
        
        .poi-item {
            border-bottom: 1px dashed #dee2e6;
            padding: 0.75rem 0;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background-color: #e3f2fd;
            color: #0d47a1;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .tag-activity {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
        
        .description {
            font-size: 0.95rem;
            color: #546e7a;
            margin-top: 0.5rem;
        }
        
        .cultural-description {
            font-size: 0.95rem;
            color: #455a64;
            padding: 0.9rem;
            background-color: #f5f5f5;
            border-left: 3px solid #1e88e5;
            margin-top: 1rem;
            border-radius: 0 5px 5px 0;
        }
        
        #theme-selector {
            background-color: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        
        .map-container {
            height: 400px;
            margin-top: 1.5rem;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .form-label {
            font-weight: 500;
            color: #455a64;
        }
        
        .form-select, .form-control {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border: 1px solid #e0e0e0;
        }
        
        .btn-primary {
            background-color: #1e88e5;
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #1976d2;
            box-shadow: 0 5px 15px rgba(30, 136, 229, 0.3);
        }
        
        /* RAGæµç¨‹å¯è§†åŒ–æ ·å¼ */
        .rag-flow-container {
            background-color: white;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .rag-flow-title {
            background-color: #f0f7ff;
            padding: 1rem;
            border-bottom: 1px solid #e1ecf9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .flow-steps {
            padding: 0;
        }
        
        .flow-step {
            padding: 1rem;
            border-left: 3px solid transparent;
            position: relative;
            margin-bottom: 0;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .flow-step.active {
            background-color: #f8f9fa;
            border-left-color: #1e88e5;
        }
        
        .flow-step.completed {
            border-left-color: #4caf50;
        }
        
        .flow-step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background-color: #e9ecef;
            color: #6c757d;
            transition: all 0.3s;
        }
        
        .step-icon.active {
            background-color: #1e88e5;
            color: white;
        }
        
        .step-icon.completed {
            background-color: #4caf50;
            color: white;
        }
        
        .step-details {
            background-color: #f8f9fa;
            padding: 0.75rem;
            border-radius: 5px;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .step-progress {
            height: 6px;
            margin-top: 0.5rem;
            border-radius: 3px;
            overflow: hidden;
            background-color: #e9ecef;
        }
        
        .step-progress-bar {
            height: 100%;
            background-color: #1e88e5;
            transition: width 0.5s ease-in-out;
        }
        
        .flow-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            background-color: #f1f1f1;
            color: #666;
        }
        
        .badge-time {
            background-color: #e0f7fa;
            color: #00838f;
        }
        
        .badge-active {
            background-color: #e1f5fe;
            color: #0288d1;
            animation: pulse 1.5s infinite;
        }
        
        .badge-completed {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        
        .badge-waiting {
            background-color: #f5f5f5;
            color: #9e9e9e;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        #keywords-cloud {
            min-height: 100px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="/" class="back-btn">
                <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
            <h1><i class="bi bi-geo-alt-fill"></i> æ™ºæ¸¸çµ</h1>
            <p class="lead mb-0">åŸºäºç©ºé—´æ„ŸçŸ¥ä¸å¤šæºæ•°æ®çš„ä¸ªæ€§åŒ–æ–‡åŒ–æ—…è¡Œè§„åˆ’ç³»ç»Ÿ</p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row">
            <div class="col-md-4">
                <div id="theme-selector">
                    <h4 class="mb-4">ä¸ªæ€§åŒ–æ—…è¡Œå®šåˆ¶</h4>
                    <form id="route-form">
                        <div class="mb-3">
                            <label for="theme" class="form-label">æ–‡åŒ–ä¸»é¢˜</label>
                            <select class="form-select" id="theme" name="theme">
                                <option value="èŒ¶æ–‡åŒ–">èŒ¶æ–‡åŒ–ä¹‹æ—…</option>
                                <option value="å†å²">å†å²æ–‡åŒ–æ¢ç´¢</option>
                                <option value="çˆ±æƒ…">çˆ±æƒ…ä¼ è¯´å¯»è¸ª</option>
                                <option value="ä½›æ•™">ä½›æ•™æ–‡åŒ–ä½“éªŒ</option>
                                <option value="å¾½å•†">å¾½å•†æ–‡åŒ–ç ”ç©¶</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="days" class="form-label">æ¸¸ç©å¤©æ•°</label>
                            <select class="form-select" id="days" name="days">
                                <option value="1">1å¤©</option>
                                <option value="2">2å¤©</option>
                                <option value="3">3å¤©</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="energy" class="form-label">ä½“åŠ›å€¼</label>
                            <select class="form-select" id="energy" name="energy">
                                <option value="é«˜">æš´èµ°æ¨¡å¼ï¼ˆé«˜ï¼‰</option>
                                <option value="ä¸­ç­‰" selected>é€‚ä¸­ï¼ˆä¸­ç­‰ï¼‰</option>
                                <option value="ä½">æ‚ é—²æ•£æ­¥ï¼ˆä½ï¼‰</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-magic"></i> ç”Ÿæˆæ–‡åŒ–æ—…è¡Œè·¯çº¿
                        </button>
                    </form>
                    
                    <hr class="my-4">
                    
                    <h5><i class="bi bi-tag-fill"></i> çƒ­é—¨æ™¯ç‚¹å…³é”®è¯</h5>
                    <div id="keywords-cloud" class="mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <!-- ç©ºé—´æ„ŸçŸ¥RAGæµç¨‹å¯è§†åŒ–åŒºåŸŸ -->
                <div id="rag-flow-visualization" class="rag-flow-container mb-4">
                    <div class="rag-flow-title">
                        <div>
                            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> ç©ºé—´æ„ŸçŸ¥RAGæ‰§è¡Œæµç¨‹</h5>
                            <p class="text-muted mb-0"><small>ç©ºé—´ä¿¡æ¯ä¸æ–‡åŒ–è¯­ä¹‰çš„èåˆè¿‡ç¨‹å¯è§†åŒ–</small></p>
                        </div>
                        <span class="badge rounded-pill bg-info" id="rag-status">ç­‰å¾…è¾“å…¥</span>
                    </div>
                    <div class="flow-steps" id="rag-flow-steps">
                        <!-- è¿™é‡Œå°†æ˜¾ç¤ºRAGæµç¨‹æ­¥éª¤ -->
                    </div>
                </div>
                
                <div id="loading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–æ–‡åŒ–æ—…è¡Œè·¯çº¿...</p>
                </div>
                
                <div id="route-results" class="d-none">
                    <div class="alert alert-success" role="alert">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill me-2" style="font-size: 1.5rem;"></i>
                            <div>
                                <h4 class="alert-heading m-0" id="route-theme-title">èŒ¶æ–‡åŒ–ä¹‹æ—…</h4>
                                <p class="mb-0" id="route-summary">æ ¹æ®æ‚¨çš„å–œå¥½ï¼Œæˆ‘ä»¬ä¸ºæ‚¨ç²¾å¿ƒè®¾è®¡äº†ä»¥ä¸‹è¡Œç¨‹ã€‚</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="routes-container"></div>
                    
                    <div class="map-container">
                        <iframe id="route-map" width="100%" height="100%" frameborder="0"></iframe>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="export-pdf" class="btn btn-outline-primary">
                            <i class="bi bi-file-earmark-pdf"></i> å¯¼å‡ºè¡Œç¨‹å•PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // RAGæµç¨‹æ­¥éª¤å®šä¹‰
        const ragSteps = [
            {
                id: 'user-input',
                title: 'ç”¨æˆ·è¾“å…¥ä¸ç©ºé—´æ„ŸçŸ¥',
                icon: 'ğŸ”',
                description: 'æ¥æ”¶ç”¨æˆ·éœ€æ±‚å¹¶åˆå§‹åŒ–ç©ºé—´æ„ŸçŸ¥æ¨¡å—',
                color: '#4285F4',
                duration: 1000
            },
            {
                id: 'spatial-retrieval',
                title: 'ç©ºé—´æ•°æ®æ£€ç´¢',
                icon: 'ğŸ“',
                description: 'æ£€ç´¢ä¸ä¸»é¢˜ç›¸å…³çš„åœ°ç†ç©ºé—´POIæ•°æ®',
                color: '#34A853',
                duration: 2000
            },
            {
                id: 'cultural-semantic',
                title: 'æ–‡åŒ–è¯­ä¹‰æ£€ç´¢',
                icon: 'ğŸ®',
                description: 'è·å–POIå…³è”çš„æ–‡åŒ–æ ‡ç­¾å’Œç”¨æˆ·è¯„è®º',
                color: '#FBBC05',
                duration: 2000
            },
            {
                id: 'multimodal-fusion',
                title: 'å¤šæ¨¡æ€èåˆæ’åº',
                icon: 'âš–ï¸',
                description: 'èåˆåœ°ç†ä½ç½®ä¸æ–‡åŒ–ç›¸å…³æ€§',
                color: '#EA4335',
                duration: 1500
            },
            {
                id: 'llm-enhancement',
                title: 'å¤§æ¨¡å‹å¢å¼ºç”Ÿæˆ',
                icon: 'ğŸ§ ',
                description: 'è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆæ–‡åŒ–è§£è¯´',
                color: '#8E44AD',
                duration: 3000
            },
            {
                id: 'route-planning',
                title: 'è·¯çº¿è§„åˆ’ä¸å¯è§†åŒ–',
                icon: 'ğŸ—ºï¸',
                description: 'æ ¹æ®æ—¶ç©ºçº¦æŸç”Ÿæˆæœ€ä¼˜è·¯çº¿',
                color: '#16A085',
                duration: 2000
            }
        ];

        // åˆå§‹åŒ–RAGæµç¨‹è§†å›¾
        function initRagFlow() {
            let flowHtml = '';
            
            ragSteps.forEach((step, index) => {
                // ä¸ºæ¯ä¸ªæ­¥éª¤åˆ›å»ºHTML
                flowHtml += `
                    <div id="${step.id}" class="flow-step d-flex">
                        <div class="step-icon me-3" style="background-color: #e9ecef;">
                            ${step.icon}
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${step.title}</h6>
                                <span class="flow-badge badge-waiting" id="${step.id}-status">ç­‰å¾…ä¸­</span>
                            </div>
                            <p class="text-muted mb-1 small">${step.description}</p>
                            <div class="step-details d-none" id="${step.id}-details"></div>
                            <div class="step-progress">
                                <div class="step-progress-bar" id="${step.id}-progress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // å°†HTMLæ·»åŠ åˆ°å®¹å™¨
            $('#rag-flow-steps').html(flowHtml);
            $('#rag-status').text('ç­‰å¾…ç”¨æˆ·è¾“å…¥');
        }

        // è¿è¡ŒRAGæµç¨‹æ¨¡æ‹Ÿ
        function runRagFlow(theme, days, energy) {
            $('#rag-status').removeClass('bg-info').addClass('bg-primary').text('æ‰§è¡Œä¸­');
            
            // æ¨¡æ‹Ÿæ­¥éª¤1ï¼šç”¨æˆ·è¾“å…¥ä¸ç©ºé—´æ„ŸçŸ¥
            updateStepStatus('user-input', 'active', `æ­£åœ¨å¤„ç†ç”¨æˆ·è¾“å…¥: ${theme}ä¸»é¢˜ï¼Œ${days}å¤©è¡Œç¨‹ï¼Œ${energy}å¼ºåº¦`);
            simulateProgress('user-input', ragSteps[0].duration, function() {
                updateStepStatus('user-input', 'completed', `æˆåŠŸæ¥æ”¶ç”¨æˆ·è¾“å…¥: ${theme}ä¸»é¢˜ï¼Œ${days}å¤©è¡Œç¨‹ï¼Œ${energy}å¼ºåº¦`);
                
                // æ¨¡æ‹Ÿæ­¥éª¤2ï¼šç©ºé—´æ•°æ®æ£€ç´¢
                updateStepStatus('spatial-retrieval', 'active', `æ­£åœ¨ä»æ•°æ®åº“ä¸­æ£€ç´¢ä¸"${theme}"ç›¸å…³çš„POIç‚¹...`);
                simulateProgress('spatial-retrieval', ragSteps[1].duration, function() {
                    updateStepStatus('spatial-retrieval', 'completed', `æˆåŠŸæ£€ç´¢åˆ°12ä¸ªä¸"${theme}"ç›¸å…³çš„POIç‚¹`);
                    
                    // æ¨¡æ‹Ÿæ­¥éª¤3ï¼šæ–‡åŒ–è¯­ä¹‰æ£€ç´¢
                    updateStepStatus('cultural-semantic', 'active', `æå–æ–‡åŒ–æ ‡ç­¾å’Œè¯„è®ºä¸­çš„è¯­ä¹‰ç‰¹å¾...`);
                    simulateProgress('cultural-semantic', ragSteps[2].duration, function() {
                        updateStepStatus('cultural-semantic', 'completed', `å…±æå–25ä¸ªæ–‡åŒ–æ ‡ç­¾å’Œ18æ¡è¯„è®ºç‰¹å¾`);
                        
                        // æ¨¡æ‹Ÿæ­¥éª¤4ï¼šå¤šæ¨¡æ€èåˆæ’åº
                        updateStepStatus('multimodal-fusion', 'active', `ä½¿ç”¨ç©ºé—´æ„ŸçŸ¥åŠ æƒç®—æ³•æ’åºPOI...`);
                        simulateProgress('multimodal-fusion', ragSteps[3].duration, function() {
                            updateStepStatus('multimodal-fusion', 'completed', `å®Œæˆç©ºé—´ä¸è¯­ä¹‰èåˆï¼Œé€‰å‡ºæœ€ä½³POIç»„åˆ`);
                            
                            // æ¨¡æ‹Ÿæ­¥éª¤5ï¼šå¤§æ¨¡å‹å¢å¼ºç”Ÿæˆ
                            updateStepStatus('llm-enhancement', 'active', `æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæ–‡åŒ–è§£è¯´...`);
                            simulateProgress('llm-enhancement', ragSteps[4].duration, function() {
                                updateStepStatus('llm-enhancement', 'completed', `æˆåŠŸç”Ÿæˆ8ä¸ªæ™¯ç‚¹çš„æ–‡åŒ–è§£è¯´ï¼Œå…±1,450ä¸ªToken`);
                                
                                // æ¨¡æ‹Ÿæ­¥éª¤6ï¼šè·¯çº¿è§„åˆ’ä¸å¯è§†åŒ–
                                updateStepStatus('route-planning', 'active', `ç»¼åˆè€ƒè™‘æ—¶é—´ã€è·ç¦»å’Œä½“åŠ›ç”Ÿæˆè·¯çº¿...`);
                                simulateProgress('route-planning', ragSteps[5].duration, function() {
                                    updateStepStatus('route-planning', 'completed', `è§„åˆ’å®Œæˆï¼Œæ€»æ¸¸è§ˆæ—¶é—´: ${days * 6}å°æ—¶ï¼Œå…±${days + 3}ä¸ªæ™¯ç‚¹`);
                                    $('#rag-status').removeClass('bg-primary').addClass('bg-success').text('æ‰§è¡Œå®Œæˆ');
                                });
                            });
                        });
                    });
                });
            });
        }

        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStepStatus(stepId, status, detailsText) {
            const $step = $(`#${stepId}`);
            const $icon = $step.find('.step-icon');
            const $status = $(`#${stepId}-status`);
            const $details = $(`#${stepId}-details`);
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            if (status === 'active') {
                $step.addClass('active');
                $icon.addClass('active').css('background-color', ragSteps.find(s => s.id === stepId).color);
                $status.removeClass('badge-waiting badge-completed').addClass('badge-active').text('æ‰§è¡Œä¸­');
                if (detailsText) {
                    $details.text(detailsText).removeClass('d-none');
                }
            } else if (status === 'completed') {
                $step.removeClass('active').addClass('completed');
                $icon.removeClass('active').addClass('completed').css('background-color', '#4caf50');
                $status.removeClass('badge-active badge-waiting').addClass('badge-completed').text('å·²å®Œæˆ');
                if (detailsText) {
                    $details.text(detailsText);
                    $(`#${stepId}-progress`).css('width', '100%');
                }
            }
        }

        // æ¨¡æ‹Ÿè¿›åº¦æ¡
        function simulateProgress(stepId, duration, callback) {
            const $progress = $(`#${stepId}-progress`);
            const startTime = Date.now();
            const interval = 50; // æ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
            
            function updateProgress() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration * 100, 100);
                
                $progress.css('width', `${progress}%`);
                
                if (progress < 100) {
                    setTimeout(updateProgress, interval);
                } else {
                    if (callback) callback();
                }
            }
            
            updateProgress();
        }

        $(document).ready(function() {
            // åˆå§‹åŒ–RAGæµç¨‹è§†å›¾
            initRagFlow();
            
            // åŠ è½½å…³é”®è¯åˆ†æ
            $.get('/api/analyze_comments', function(data) {
                let keywordsHtml = '';
                data.keywords.forEach(function(item) {
                    const fontSize = 0.8 + (item.count / 5) * 0.3; // æ ¹æ®é¢‘ç‡è°ƒæ•´å­—ä½“å¤§å°
                    keywordsHtml += `<span class="tag" style="font-size: ${fontSize}rem;">${item.keyword}</span>`;
                });
                $('#keywords-cloud').html(keywordsHtml);
            });
            
            // è¡¨å•æäº¤
            $('#route-form').submit(function(e) {
    e.preventDefault();
    
    // Show loading state
    $('#loading').removeClass('d-none');
    $('#route-results').addClass('d-none');
    
    // Get form data
    const theme = $('#theme').val();
    const days = $('#days').val();
    const energy = $('#energy').val();
    
    // Run RAG flow simulation
    runRagFlow(theme, days, energy);
    
    // Send request
    $.ajax({
        url: '/api/routes',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            theme: theme,
            days: parseInt(days),
            energy: energy
        }),
        success: function(data) {
            // Log the received data for debugging
            console.log("Received route data:", data);
            
            // Check if we have routes data
            if (!data.routes || data.routes.length === 0) {
                alert('æœªèƒ½ç”Ÿæˆæœ‰æ•ˆçš„è·¯çº¿ï¼Œè¯·å°è¯•ä¸åŒçš„å‚æ•°ï¼');
                $('#loading').addClass('d-none');
                return;
            }
            
            // Update route results
            $('#route-theme-title').text(data.theme + 'ä¹‹æ—…');
            $('#route-summary').text(`ä¸ºæ‚¨å®šåˆ¶çš„${data.days}å¤©${data.energy}å¼ºåº¦æ–‡åŒ–ä½“éªŒä¹‹æ—…ã€‚`);
            
            // Render routes
            renderRoutes(data.routes);
            
            // Generate map after routes are rendered
            setTimeout(function() {
                generateMap(data.routes);
            }, 500);
            
            // Hide loading state, show results
            $('#loading').addClass('d-none');
            $('#route-results').removeClass('d-none');
        },
        error: function(xhr, status, error) {
            console.error("Route generation failed:", error);
            alert('ç”Ÿæˆè·¯çº¿å¤±è´¥ï¼Œè¯·é‡è¯•ï¼é”™è¯¯: ' + error);
            $('#loading').addClass('d-none');
        }
    });
});           
            // æ¸²æŸ“è·¯çº¿å‡½æ•°
            function renderRoutes(routes) {
                let routesHtml = '';
                
                routes.forEach(function(dayRoute, dayIndex) {
                    routesHtml += `
                        <div class="route-day">
                            <h4>ç¬¬${dayIndex + 1}å¤©è¡Œç¨‹</h4>
                            <div class="card">
                                <div class="card-body">
                    `;
                    
                    dayRoute.forEach(function(poi, poiIndex) {
                        routesHtml += `
                            <div class="poi-item">
                                <h5>${poiIndex + 1}. ${poi.name}</h5>
                                <div>
                                    <span class="tag tag-activity">æ¸¸è§ˆçº¦${poi.visit_time}åˆ†é’Ÿ</span>
                                    ${poi.ticket_price > 0 ? `<span class="tag">é—¨ç¥¨Â¥${poi.ticket_price}</span>` : '<span class="tag">å…è´¹</span>'}
                                    <span class="tag">è¯„åˆ†${poi.rating}â˜…</span>
                                </div>
                                <div class="description">${poi.description}</div>
                                <div class="cultural-description">${poi.cultural_description}</div>
                            </div>
                        `;
                    });
                    
                    routesHtml += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                $('#routes-container').html(routesHtml);
            }
            
            // ç”Ÿæˆåœ°å›¾å‡½æ•°
            function generateMap(routes) {
    // Debug log to check what routes we're sending
    console.log("Sending routes data:", routes);
    
    // Only proceed if routes array is not empty
    if (routes && routes.length > 0) {
        $.ajax({
            url: '/api/map',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ routes: routes }),
            success: function(data) {
                if (data.error) {
                    console.error("Map generation error:", data.error);
                    alert("æ— æ³•ç”Ÿæˆåœ°å›¾: " + data.error);
                } else {
                    $('#route-map').attr('src', data.map_url);
                }
            },
            error: function(xhr, status, error) {
                console.error("Map request failed:", error);
                alert("åœ°å›¾è¯·æ±‚å¤±è´¥: " + error);
            }
        });
    } else {
        console.error("Cannot generate map: routes data is empty");
        $('#route-map').attr('src', '');
        // Optionally show a placeholder or error message
        // $('#route-map').parent().html('<div class="alert alert-warning">æ— æ³•ç”Ÿæˆåœ°å›¾ï¼šæ²¡æœ‰è·¯çº¿æ•°æ®</div>');
    }
}
            
            // å¯¼å‡ºPDFï¼ˆç¤ºä¾‹åŠŸèƒ½ï¼‰
            $('#export-pdf').click(function() {
                alert('å¯¼å‡ºPDFåŠŸèƒ½å°†åœ¨å®Œæ•´ç‰ˆä¸­å®ç°ï¼');
            });
        });
    </script>
</body>
</html>