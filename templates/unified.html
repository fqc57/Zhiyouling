<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智游灵 - 一体化旅游智能助手</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.2/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <!-- 确保 marked 在不同版本间兼容 -->
    <script>
        // 在页面加载时检查并处理 marked 兼容性
        document.addEventListener('DOMContentLoaded', function() {
            // 检测 marked 是否为对象（新版本 5.x）
            if (typeof marked === 'object' && typeof marked.parse === 'function') {
                console.log('检测到 marked 5.x，创建兼容层');
                // 保存原始 marked 对象
                const originalMarked = window.marked;
                
                // 创建兼容旧版本的函数
                window.marked = function(text) {
                    return originalMarked.parse(text);
                };
                
                // 保留 setOptions 方法
                window.marked.setOptions = originalMarked.setOptions;
                
                // 保留 parse 方法
                window.marked.parse = originalMarked.parse;
            }
        });
    </script>
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-light: #6ab7ff;
            --primary-dark: #005cb2;
            --accent-color: #ff5722;
            --text-dark: #263238;
            --text-light: #eceff1;
            --background-dark: #102027;
            --background-light: #f5f5f5;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "SimHei", sans-serif;
            height: 100%;
            background-color: var(--background-light);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            color: white;
            transform: translateX(-5px);
        }
        
        .back-btn i {
            margin-right: 5px;
        }

        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #005cb2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-container {
            padding: 1.5rem;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .unified-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1rem;
            flex: 1;
            margin-top: 1rem;
        }

        .chat-area {
            grid-column: 1;
            grid-row: 1 / span 2;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-area {
            grid-column: 2;
            grid-row: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .graph-area {
            grid-column: 2;
            grid-row: 2;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .section-header {
            padding: 1rem;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1ecf9;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .section-content {
            padding: 1rem;
            overflow: auto;
            flex: 1;
        }

        /* 对话区样式 */
        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        #prompt {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #prompt:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
            outline: none;
        }
        
        .send-button {
            padding: 0 1.5rem;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            background-color: #1976D2;
            box-shadow: 0 3px 10px rgba(30, 136, 229, 0.3);
        }
        
        .send-button i {
            margin-right: 8px;
        }

        /* 响应样式 */
        .response-container {
            background-color: rgba(245, 245, 245, 0.95);
            border-radius: 12px;
            padding: 1.8rem;
            margin-top: 1.8rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .user-message {
            background: linear-gradient(135deg, #e6f3ff 0%, #e1f5fe 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e88e5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .user-message:hover {
            transform: translateY(-2px);
        }

        .assistant-message {
            background: linear-gradient(135deg, #f5f7fa 0%, #f5f5f5 100%);
            border-radius: 18px;
            border-top-left-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #66bb6a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .reasoning-container {
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e1effe;
        }

        .reasoning-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1effe;
            cursor: pointer;
        }
        
        .reasoning-title {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #0d47a1;
            font-size: 14px;
        }
        
        .reasoning-title i {
            margin-right: 8px;
            color: #1e88e5;
        }
        
        .reasoning-content {
            padding: 15px;
            color: #455a64;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fdfdfd;
            max-height: 300px;
            overflow-y: auto;
            display: block !important;
        }
        
        .reasoning-content.collapsed {
            display: none !important;
        }
        
        .reasoning-toggle i {
            transition: transform 0.3s;
        }

        /* Markdown 样式 */
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3, 
        .markdown-content h4, 
        .markdown-content h5, 
        .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.6rem;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 0.4rem;
        }

        .markdown-content h3 { font-size: 1.4rem; }
        .markdown-content h4 { font-size: 1.2rem; }

        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .markdown-content ol, 
        .markdown-content ul {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
        }

        .markdown-content blockquote {
            border-left: 4px solid #66bb6a;
            padding-left: 1rem;
            color: #555;
            font-style: italic;
            margin: 1rem 0;
            background-color: rgba(102, 187, 106, 0.1);
            padding: 0.8rem 1rem;
            border-radius: 0 6px 6px 0;
        }

        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .markdown-content code {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content a {
            color: #1e88e5;
            text-decoration: none;
            border-bottom: 1px dashed #1e88e5;
            transition: color 0.2s, border-bottom 0.2s;
        }

        .markdown-content a:hover {
            color: #0d47a1;
            border-bottom: 1px solid #0d47a1;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        .markdown-content th, 
        .markdown-content td {
            border: 1px solid #e9ecef;
            padding: 0.6rem;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .markdown-content tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1rem 0;
        }

        /* 旅行建议卡片样式 */
        .travel-suggestion-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-left: 4px solid #ff9800;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .travel-suggestion-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
        }

        .travel-suggestion-title i {
            margin-right: 8px;
            color: #ff9800;
        }

        .poi-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .poi-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .poi-item:last-child {
            border-bottom: none;
        }

        .poi-icon {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 0.8rem;
        }

        .poi-info {
            flex: 1;
        }

        .poi-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .poi-desc {
            font-size: 0.85rem;
            color: #666;
        }

        .travel-tips {
            background-color: rgba(255, 152, 0, 0.1);
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .travel-tips-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .travel-tips-title i {
            margin-right: 8px;
            color: #ff9800;
        }

        /* 地图样式 */
        .map-container {
            height: 100%;
            width: 100%;
        }

        /* 知识图谱样式 */
        .graph-container {
            height: 100%;
            width: 100%;
            position: relative;
            background: linear-gradient(to bottom, #f7f9fc, #edf1f7);
            border-radius: 10px;
            overflow: hidden;
        }

        /* 节点样式 */
        .kg-node {
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .kg-node circle {
            transition: stroke 0.3s ease, stroke-width 0.3s ease, fill 0.3s ease, filter 0.4s ease;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }

        .kg-node.in-route circle {
            filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.5));
        }

        .kg-node text {
            transition: font-size 0.3s ease, font-weight 0.3s ease, fill 0.3s ease;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .kg-link {
            transition: stroke-opacity 0.4s ease, stroke-width 0.4s ease, stroke 0.4s ease;
        }

        /* 粒子效果 */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
        }

        /* 图谱图例样式 */
        .kg-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            z-index: 100;
            max-height: calc(100% - 20px);
            overflow-y: auto;
            border-left: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
            transition: all 0.3s ease;
        }

        .kg-legend:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        /* 图谱节点提示框 */
        .kg-tooltip {
            position: absolute;
            visibility: hidden;
            background-color: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            font-size: 12px;
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
        }

        .kg-tooltip.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .kg-tooltip h5 {
            margin-top: 0;
            font-size: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
            color: #1a237e;
        }

        .kg-tooltip p {
            margin: 5px 0;
            line-height: 1.5;
            color: #37474f;
        }

        /* 缩放控制按钮 */
        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
        }

        .zoom-controls button {
            width: 32px;
            height: 32px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #1976d2;
        }

        .zoom-controls button:hover {
            background-color: #1976d2;
            color: white;
            box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
        }

        /* 高亮节点样式 */
        .kg-node.highlighted circle {
            stroke: #ff5722;
            stroke-width: 3px;
            stroke-dasharray: 5;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.5));
        }

        .kg-node.in-route circle {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { stroke-opacity: 1; filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.5)); }
            50% { stroke-opacity: 0.7; filter: drop-shadow(0 0 12px rgba(255, 87, 34, 0.7)); }
            100% { stroke-opacity: 1; filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.5)); }
        }

        /* 响应式调整 */
        @media (max-width: 992px) {
            .unified-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .chat-area {
                grid-column: 1;
                grid-row: 1;
                height: 400px;
            }
            
            .map-area {
                grid-column: 1;
                grid-row: 2;
                height: 400px;
            }
            
            .graph-area {
                grid-column: 1;
                grid-row: 3;
                height: 400px;
            }
        }

        /* 优化助手和用户消息样式 */
        .welcome-message {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaff 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .welcome-message h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .welcome-message p {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .welcome-message ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .welcome-message li {
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .example-questions {
            background-color: rgba(255,255,255,0.7);
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .example-questions p {
            margin: 8px 0;
            color: var(--text-dark);
            font-style: italic;
        }

        .final-note {
            font-weight: 500;
            color: var(--primary-color) !important;
            margin-top: 20px;
            font-size: 15px;
        }
        
        .user-message {
            background: linear-gradient(135deg, #e6f3ff 0%, #e1f5fe 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e88e5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .user-message:hover {
            transform: translateY(-2px);
        }

        /* 推理容器样式 */
        .reasoning-container {
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e1effe;
        }

        .reasoning-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1effe;
            cursor: pointer;
        }
        
        .reasoning-title {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #0d47a1;
            font-size: 14px;
        }
        
        .reasoning-title i {
            margin-right: 8px;
            color: #1e88e5;
        }
        
        .reasoning-content {
            padding: 15px;
            color: #455a64;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fdfdfd;
            max-height: 300px;
            overflow-y: auto;
            display: block !important;
        }
        
        .reasoning-content.collapsed {
            display: none !important;
        }
        
        .reasoning-toggle i {
            transition: transform 0.3s;
        }

        /* 加载动画 */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 24px;
            margin: 10px 0;
        }

        .loading-dots div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #4CAF50;
            border-radius: 50%;
            animation: dot-pulse 1.5s infinite ease-in-out;
        }

        .loading-dots div:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dots div:nth-child(2) {
            animation-delay: 0.5s;
        }

        .loading-dots div:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes dot-pulse {
            0%, 50%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            25%, 75% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        /* 旅游路线样式 */
        .travel-route-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }
        
        .travel-route-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .travel-route-header i {
            font-size: 1.2rem;
        }
        
        .travel-route-day {
            background-color: #f8f9fa;
            padding: 12px 20px;
            font-weight: 600;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .day-badge {
            background-color: #2196F3;
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        
        .day-title {
            color: #424242;
            font-weight: 500;
        }
        
        .poi-list {
            list-style: none;
            margin: 0;
            padding: 10px 20px;
        }
        
        .poi-item {
            padding: 15px 0;
            display: flex;
            gap: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-number {
            width: 32px;
            height: 32px;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .poi-content {
            flex-grow: 1;
        }
        
        .poi-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1976D2;
            font-size: 1.05rem;
        }
        
        .poi-desc {
            color: #616161;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .desc-label {
            display: inline-block;
            color: #0277BD;
            font-weight: 500;
            margin: 4px 0;
        }
        
        .desc-label i {
            margin-right: 3px;
        }
        
        .travel-advice {
            background-color: #f5f5f5;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .travel-advice-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: #455A64;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .travel-advice-title i {
            color: #FF9800;
        }
        
        .travel-advice-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .travel-advice-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .travel-advice-item i {
            color: #43A047;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .travel-advice-label {
            font-weight: 500;
            color: #455A64;
            min-width: 60px;
        }
        
        .travel-advice-value {
            color: #546E7A;
            flex-grow: 1;
        }
        
        .travel-advice-notes {
            margin-top: 15px;
            color: #607D8B;
            font-style: italic;
            font-size: 0.95rem;
            padding: 0 8px;
        }
        
        .travel-route-footer {
            margin: 15px 20px;
            font-size: 0.95rem;
            color: #757575;
            font-style: italic;
            text-align: center;
        }
        
        /* Markdown 内容样式 */
        .markdown-content h2 {
            font-size: 1.3rem;
            color: #1e88e5;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 8px;
            margin-top: 1.5rem;
        }

        .markdown-content h3 {
            font-size: 1.1rem;
            color: #333;
            margin-top: 1.2rem;
        }

        .markdown-content strong {
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-geo-alt-fill"></i> 智游灵</a>
            <a href="/" class="back-btn ms-auto">
                <i class="bi bi-arrow-left"></i> 返回首页
            </a>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="main-container container">
        <h3 class="text-center mb-4">智能旅游一体化体验</h3>
        
        <!-- 主要内容网格 -->
        <div class="unified-grid">
            <!-- 智能对话区域 -->
            <div class="chat-area">
                <div class="section-header">
                    <span><i class="bi bi-chat-dots"></i> 深度思考旅游助手</span>
                </div>
                <div id="chatContent" class="chat-content">
                    <!-- 对话消息将在这里显示 -->
                </div>
                <div class="input-area">
                    <input type="text" id="prompt" placeholder="请输入您的旅游需求，例如：想去杭州体验茶文化，安排3天的行程..." autofocus>
                    <button id="sendButton" class="send-button">
                        <i class="bi bi-send"></i> 发送
                    </button>
                </div>
            </div>
            
            <!-- 地图区域 -->
            <div class="map-area">
                <div class="section-header">
                    <span><i class="bi bi-map"></i> 路线规划地图</span>
                    <div class="spinner-border text-primary d-none" id="mapLoading" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                <div id="mapContainer" class="map-container">
                    <!-- 地图将在这里加载 -->
                </div>
            </div>
            
            <!-- 知识图谱区域 -->
            <div class="graph-area">
                <div class="section-header">
                    <span><i class="bi bi-diagram-3"></i> 旅游知识图谱</span>
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary d-none" id="graphLoading" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </div>
                </div>
                <div id="graphContainer" class="graph-container">
                    <!-- 知识图谱将在这里显示 -->
                </div>
            </div>
        </div>
        
        <!-- 路线详情区域 -->
        <div id="routeInfo" class="route-info d-none">
            <!-- 路线信息将在这里显示 -->
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 配置Marked选项
            marked.setOptions({
                breaks: true,       // 允许换行符转换为<br>
                gfm: true,          // 使用GitHub风格的Markdown
                pedantic: false,    // 不使用严格模式
                sanitize: false,    // 不过滤HTML标签
                smartLists: true,   // 使用更智能的列表行为
                smartypants: false  // 不使用智能标点
            });
            
            // DOM元素
            const chatContent = document.getElementById('chatContent');
            const promptInput = document.getElementById('prompt');
            const sendButton = document.getElementById('sendButton');
            const mapContainer = document.getElementById('mapContainer');
            const graphContainer = document.getElementById('graphContainer');
            const routeInfo = document.getElementById('routeInfo');
            const mapLoading = document.getElementById('mapLoading');
            const graphLoading = document.getElementById('graphLoading');
            
            // 当前对话状态
            let currentReasoningContent = "";
            let currentResponseContent = "";
            let lastReasoningContainer = null;
            
            // 初始化地图和知识图谱
            initializeMap();
            initializeGraph();
            
            // 显示欢迎消息
            showWelcomeMessage();
            
            // Markdown渲染函数
            function renderMarkdown(text) {
                if (!text) return '';
                
                try {
                    // 配置Marked选项，提升渲染质量
                    marked.setOptions({
                        gfm: true,          // 使用GitHub风格的Markdown
                        breaks: true,        // 允许换行符转换为<br>
                        smartLists: true,    // 使用更智能的列表行为
                        smartypants: true,   // 使用更智能的标点符号
                        highlight: function(code, lang) {
                            // 如果有合适的代码高亮库，这里可以集成
                            return code;
                        }
                    });
                    
                    // 首先检查文本是否包含旅游路线规划格式
                    if (text.includes('## 推荐') && (text.includes('天路线') || text.includes('天行程'))) {
                        return formatTravelRoute(text);
                    }
                    
                    // 否则使用常规Markdown渲染
                    return marked.parse(text);
                } catch (error) {
                    console.error('Markdown渲染失败:', error);
                    return text; // 如果渲染失败，返回原始文本
                }
            }
            
            // 显示欢迎消息
            function showWelcomeMessage() {
                const welcomeHTML = `
                <div class="welcome-message">
                    <h2>欢迎使用智游灵 - 您的AI旅行规划大师</h2>
                    <p>我能感知您的旅行灵感，融合空间与文化，为您打造专属旅程。无论您向往西湖的诗意，渴望品味城市美食，还是想要探索历史古迹，只需告诉我您的想法。</p>
                    <p>通过先进的空间感知技术和文化语义理解，我可以：</p>
                    <ul>
                        <li>📍 根据您的兴趣提供个性化多日路线规划</li>
                        <li>🌦️ 实时天气信息与智能活动调整建议</li>
                        <li>🔍 呈现目的地的知识图谱，发现隐藏关联</li>
                        <li>🗺️ 提供清晰直观的地图导航</li>
                    </ul>
                    <p>试试这样问我：</p>
                    <div class="example-questions">
                        <p>• "计划一次西安的3天美食之旅"</p>
                        <p>• "想去杭州体验茶文化，请帮我安排两天的轻松行程"</p>
                        <p>• "帮我设计一个高强度的北京历史文化一日游"</p>
                    </div>
                    <p class="final-note">每一段旅程都是独特的故事，让智游灵助您编织难忘的旅行回忆...</p>
                </div>
                `;
                
                // 创建AI消息容器
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', 'assistant-message-container');
                
                // 设置消息内容
                messageContainer.innerHTML = `
                    <div class="assistant-message">
                        <!--div class="message-avatar">AI</div-->
                        <div class="message-content markdown-content">${welcomeHTML}</div>
                    </div>
                `;
                
                // 添加到聊天内容区域
                chatContent.appendChild(messageContainer);
                
                // 为示例问题添加点击事件
                setTimeout(() => {
                    const exampleQuestions = document.querySelectorAll('.example-questions p');
                    exampleQuestions.forEach(question => {
                        question.style.cursor = 'pointer';
                        question.addEventListener('click', () => {
                            // 提取问题文本（移除前面的•和引号）
                            const questionText = question.textContent.replace(/^•\s*"|"$/g, '');
                            // 填入输入框
                            promptInput.value = questionText;
                            // 聚焦输入框
                            promptInput.focus();
                        });
                    });
                }, 100);
            }
            
            // 格式化旅游路线为美观的HTML
            function formatTravelRoute(markdownText) {
                try {
                    // 直接返回原始markdown的标准HTML渲染，不做额外处理
                    return marked.parse(markdownText);
                    
                    /* 注释掉原有代码以便保留原始markdown效果
                    // 首先使用marked将markdown转为基本HTML
                    const basicHtml = marked.parse(markdownText);
                    
                    // 使用DOM解析器解析HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(basicHtml, 'text/html');
                    
                    // 创建结果容器，添加美化样式
                    let result = '<div class="travel-route-container">';
                    
                    // 处理标题（推荐X天路线）
                    const mainTitle = doc.querySelector('h2');
                    if (mainTitle) {
                        result += `<div class="travel-route-header">
                            <i class="bi bi-compass"></i>
                            ${mainTitle.textContent}
                        </div>`;
                    }
                    
                    // 遍历每天的行程
                    const dayTitles = doc.querySelectorAll('h3');
                    dayTitles.forEach((dayTitle, dayIndex) => {
                        // 提取日期编号，移除"第"和"天路线"等文字
                        const dayText = dayTitle.textContent;
                        let dayNum = dayText.replace(/第|天路线|天行程|天|日/g, '').trim();
                        
                        // 添加日期标题，使用更好的格式
                        result += `<div class="travel-route-day">
                            <span class="day-badge">Day ${dayNum}</span>
                            <span class="day-title">行程安排</span>
                        </div>`;
                        
                        // 寻找该日行程的所有列表项
                        let poiList = '<ul class="poi-list">';
                        let currentElement = dayTitle.nextElementSibling;
                        
                        // 收集行程点直到下一个标题或旅行建议
                        while (currentElement && 
                              !currentElement.matches('h3') && 
                              !currentElement.textContent.includes('旅行建议')) {
                            
                            // 处理数字列表项
                            if (currentElement.matches('ol')) {
                                const items = currentElement.querySelectorAll('li');
                                items.forEach((item, index) => {
                                    // 提取景点名称（强调文本）
                                    const nameMatch = item.innerHTML.match(/<strong>(.*?)<\/strong>/);
                                    const name = nameMatch ? nameMatch[1] : `景点 ${index + 1}`;
                                    
                                    // 移除强调文本，获取描述
                                    const desc = item.innerHTML.replace(/<strong>.*?<\/strong>/, '').trim();
                                    
                                    // 为描述添加图标
                                    let formattedDesc = desc;
                                    
                                    // 检测并添加美化图标
                                    const icons = {
                                        '景点类型': 'bi-tag',
                                        '推荐理由': 'bi-star',
                                        '游览时间': 'bi-clock',
                                        '地址': 'bi-geo-alt',
                                        '交通': 'bi-car-front',
                                        '门票': 'bi-ticket',
                                        '小贴士': 'bi-info-circle'
                                    };
                                    
                                    // 为描述文本添加图标
                                    for (const [key, icon] of Object.entries(icons)) {
                                        if (desc.includes(key)) {
                                            formattedDesc = formattedDesc.replace(
                                                new RegExp(`(${key})([：:])`, 'g'), 
                                                `<span class="desc-label"><i class="bi ${icon}"></i> $1</span>$2`
                                            );
                                        }
                                    }
                                    
                                    poiList += `
                                        <li class="poi-item">
                                            <div class="poi-number">${index + 1}</div>
                                            <div class="poi-content">
                                                <div class="poi-name">${name}</div>
                                                <div class="poi-desc">${formattedDesc}</div>
                                            </div>
                                        </li>`;
                                });
                            }
                            
                            currentElement = currentElement.nextElementSibling;
                        }
                        
                        poiList += '</ul>';
                        result += poiList;
                        
                        // 如果当前是旅行建议部分，处理它
                        if (currentElement && currentElement.textContent.includes('旅行建议')) {
                            result += `<div class="travel-advice">
                                        <div class="travel-advice-title">
                                            <i class="bi bi-lightbulb"></i>
                                            旅行建议
                                        </div>`;
                            
                            // 获取建议列表
                            if (currentElement.nextElementSibling && currentElement.nextElementSibling.matches('ul')) {
                                result += '<ul class="travel-advice-list">';
                                
                                const adviceItems = currentElement.nextElementSibling.querySelectorAll('li');
                                adviceItems.forEach(item => {
                                    // 处理冒号分隔的建议项
                                    const parts = item.textContent.split('：');
                                    if (parts.length > 1) {
                                        const label = parts[0].trim();
                                        const value = parts.slice(1).join('：').trim();
                                        
                                        let icon = 'bi-check-circle';
                                        // 根据不同类型选择图标
                                        if (label.includes('时间')) icon = 'bi-clock';
                                        else if (label.includes('交通')) icon = 'bi-car-front';
                                        else if (label.includes('携带')) icon = 'bi-backpack';
                                        else if (label.includes('天气')) icon = 'bi-cloud-sun';
                                        else if (label.includes('住宿')) icon = 'bi-house';
                                        else if (label.includes('餐饮')) icon = 'bi-cup-hot';
                                        else if (label.includes('预算')) icon = 'bi-wallet2';
                                        
                                        result += `
                                            <li class="travel-advice-item">
                                                <i class="bi ${icon}"></i>
                                                <div class="travel-advice-label">${label}</div>
                                                <div class="travel-advice-value">${value}</div>
                                            </li>`;
                                    } else {
                                        // 没有冒号的普通建议项
                                        result += `
                                            <li class="travel-advice-item">
                                                <i class="bi bi-check-circle"></i>
                                                <div class="travel-advice-value">${item.textContent}</div>
                                            </li>`;
                                    }
                                });
                                
                                result += '</ul>';
                                
                                // 移动到建议列表后的元素
                                currentElement = currentElement.nextElementSibling.nextElementSibling;
                            } else {
                                // 如果没有找到建议列表，移到下一个元素
                                currentElement = currentElement.nextElementSibling;
                            }
                            
                            // 添加补充说明（如果有）
                            if (currentElement && !currentElement.matches('h2, h3')) {
                                result += `<p class="travel-advice-notes">${currentElement.innerHTML}</p>`;
                            }
                            
                            result += '</div>'; // 关闭旅行建议div
                        }
                    });
                    
                    // 处理底部可能存在的附加说明
                    const lastParagraph = doc.querySelector('p:last-child');
                    if (lastParagraph && !result.includes(lastParagraph.textContent)) {
                        result += `<p class="travel-route-footer">${lastParagraph.innerHTML}</p>`;
                    }
                    
                    result += '</div>'; // 关闭旅游路线容器
                    return result;
                    */
                } catch (error) {
                    console.error('格式化旅游路线失败:', error);
                    return marked.parse(markdownText); // 出错时回退到普通markdown渲染
                }
            }
            
            // 发送按钮事件处理
            function handleSendClick() {
                const userMessage = promptInput.value.trim();
                
                if (!userMessage) {
                    return;
                }
                
                // 添加用户消息到聊天区域
                addMessage(userMessage, true);
                promptInput.value = '';
                
                // 创建响应元素容器 - 添加带推理容器的助手消息
                const messageContainer = addMessage('', false, true); // 第三个参数设为true，表示需要推理容器
                
                // 确保推理容器已正确创建
                const reasoningContainer = messageContainer.querySelector('.reasoning-container');
                if (reasoningContainer) {
                    console.log("成功创建推理容器");
                    
                    // 检查推理内容元素
                    lastReasoningContainer = reasoningContainer;
                    const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                    if (reasoningContent) {
                        // 确保不是折叠状态
                        if (reasoningContent.classList.contains('collapsed')) {
                            reasoningContent.classList.remove('collapsed');
                        }
                        console.log("推理内容容器已准备好接收数据");
                    }
                } else {
                    console.log("未能创建推理容器");
                }
                
                // 获取创建的响应元素
                const responseElement = messageContainer.querySelector('#currentResponse');
                
                // 添加加载指示器
                if (responseElement) {
                    responseElement.innerHTML = '<div class="loading-dots"><div></div><div></div><div></div></div>';
                }
                
                // 开始获取流式响应
                getStreamingResponse(userMessage);
            }

            // 处理输入框回车事件
            promptInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendClick();
                }
            });

            // 发送按钮点击事件
            sendButton.addEventListener('click', handleSendClick);
            
            // 初始化地图
            function initializeMap() {
                console.log("初始化地图底图...");
                // 创建iframe以显示基础地图
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.5s ease';
                
                // 添加iframe到容器
                mapContainer.appendChild(iframe);
                
                // 显示加载指示器
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'map-loading-indicator';
                loadingIndicator.style.position = 'absolute';
                loadingIndicator.style.top = '50%';
                loadingIndicator.style.left = '50%';
                loadingIndicator.style.transform = 'translate(-50%, -50%)';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在加载地图...</p>
                `;
                mapContainer.appendChild(loadingIndicator);
                
                // 请求简单的默认地图，无路线
                fetch('/api/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ routes: [] }) // 空路线，只加载底图
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`地图API错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // 当iframe加载完成时，显示iframe并移除加载指示器
                    iframe.onload = function() {
                        iframe.style.opacity = '1';
                        loadingIndicator.style.display = 'none';
                    };
                    
                    // 设置iframe源
                    iframe.src = data.map_url;
                })
                .catch(error => {
                    console.error('地图初始化错误:', error);
                    loadingIndicator.style.display = 'none';
                    mapContainer.innerHTML = `
                        <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                            <h5>加载地图时出错</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
            }
            
            // 初始化知识图谱
            function initializeGraph() {
                console.log("初始化知识图谱...");
                
                // 隐藏图谱加载指示器，不预加载图谱
                graphLoading.classList.add('d-none');
                
                // 显示空白提示
                graphContainer.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted" style="flex-direction: column;">
                        <i class="bi bi-diagram-3 mb-3" style="font-size: 48px; opacity: 0.3;"></i>
                        <p>与AI对话后，将显示相关景点的知识图谱</p>
                    </div>
                `;
                
                // 不预加载知识图谱，改为等待用户与AI对话后显示
                /*
                // 获取基础知识图谱数据（无高亮）
                fetch('/api/graph_data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`知识图谱API错误: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(graphData => {
                        // 创建知识图谱
                        renderGraph(graphData);
                        
                        // 隐藏加载指示器
                        graphLoading.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('知识图谱加载错误:', error);
                        graphLoading.classList.add('d-none');
                        graphContainer.innerHTML = `
                            <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                                <h5>加载知识图谱时出错</h5>
                                <p>${error.message}</p>
                            </div>
                        `;
                    });
                */
            }
            
            // 初始化页面
            initializeMap();
            initializeGraph();
            
            // 添加渲染路线信息到响应中的函数
            function appendRouteInfoToResponse(routes, theme) {
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) return;
                
                let routeHTML = `
                <div class="travel-suggestion-card mt-4">
                    <div class="travel-suggestion-title" style="display: flex; align-items: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; border-left: 4px solid #FF9800; padding-left: 10px;">
                        <i class="bi bi-map" style="color: #FF9800; margin-right: 8px;"></i> 推荐${routes.length}天${theme}路线
                    </div>
                `;
                
                // 获取天气数据（如果有）
                const weatherData = window.lastWeatherData || null;
                const hasWeatherData = weatherData && weatherData.current;
                const weatherCondition = hasWeatherData ? weatherData.current.condition.text : '';
                const weatherTemp = hasWeatherData ? weatherData.current.temp_c : 25;
                
                routes.forEach((dayRoute, dayIndex) => {
                    routeHTML += `
                    <div class="day-route mb-3">
                        <h5 class="mt-3 mb-3" style="font-size: 16px; font-weight: bold; color: #333;">第${dayIndex+1}天路线`;
                
                    // 如果有天气数据，添加天气预报标签
                    if (hasWeatherData && weatherData.forecast && weatherData.forecast.forecastday && weatherData.forecast.forecastday.length > dayIndex) {
                        const dayForecast = weatherData.forecast.forecastday[dayIndex];
                        const condition = dayForecast.day.condition.text;
                        routeHTML += ` <span style="font-size: 13px; color: #666; font-weight: normal; margin-left: 8px;">
                                    <i class="${getWeatherIcon({code: dayForecast.day.condition.code, is_day: 1})}" style="color: #2196F3;"></i> 
                                    ${condition}, ${dayForecast.day.maxtemp_c}°C/${dayForecast.day.mintemp_c}°C
                                </span>`;
                    }
                    
                    routeHTML += `</h5>`;
                    
                    dayRoute.forEach((poi, poiIndex) => {
                        // 创建一个干净的描述，不包含技术性的字段名
                        let poiDesc = '';
                        if (poi.description) {
                            // 只显示描述内容，不显示类型和标题等技术字段
                            poiDesc = poi.description.substring(0, 80) + (poi.description.length > 80 ? '...' : '');
                        }
                        
                        // 根据天气添加景点推荐标记
                        let weatherRecommendation = '';
                        if (hasWeatherData) {
                            // 判断是否为室内景点
                            const isIndoor = poi.indoor === true || 
                                (poi.name && (
                                    poi.name.includes('博物馆') || 
                                    poi.name.includes('美术馆') || 
                                    poi.name.includes('展览') ||
                                    poi.name.includes('茶馆')
                                ));
                            
                            // 根据天气条件添加推荐标记
                            if (weatherCondition.includes('雨') && isIndoor) {
                                weatherRecommendation = '<span style="color: #2196F3; font-size: 12px; margin-left: 6px;">(雨天推荐)</span>';
                            } else if (weatherTemp > 30 && isIndoor) {
                                weatherRecommendation = '<span style="color: #FF9800; font-size: 12px; margin-left: 6px;">(避暑推荐)</span>';
                            } else if (weatherCondition.includes('晴') && !isIndoor && poiIndex === 0) {
                                weatherRecommendation = '<span style="color: #4CAF50; font-size: 12px; margin-left: 6px;">(今日优选)</span>';
                            }
                        }
                        
                        routeHTML += `
                        <div class="poi-item d-flex align-items-start mb-3">
                            <div class="poi-number rounded-circle d-flex justify-content-center align-items-center text-white" style="width: 36px; height: 36px; background-color: #2196F3; flex-shrink: 0; margin-right: 15px; font-weight: bold; font-size: 14px;">${poiIndex+1}</div>
                            <div class="poi-content">
                                <div class="poi-name fw-bold mb-1" style="font-size: 15px; color: #333;">${poi.name}${weatherRecommendation}</div>
                                <div class="poi-desc text-muted small" style="font-size: 13px; color: #666;">${poiDesc}</div>
                            </div>
                        </div>
                        `;
                    });
                    
                    routeHTML += `</div>`;
                });
                
                // 添加旅行建议部分
                routeHTML += `
                    <div class="travel-tips p-3 mt-2 rounded" style="background-color: #FFF8E1; border-radius: 8px;">
                        <div class="travel-tips-header d-flex align-items-center mb-2">
                            <i class="bi bi-info-circle me-2" style="color: #FF9800;"></i>
                            <span style="font-weight: bold; color: #333; font-size: 15px;">旅行建议</span>
                        </div>
                        <p class="mb-1" style="font-size: 14px; color: #555;">最佳游览时间：8:00-17:00</p>
                        <p class="mb-1" style="font-size: 14px; color: #555;">交通方式：公交、地铁、步行或打车</p>
                        <p class="mb-0" style="font-size: 14px; color: #555;">建议携带：舒适的鞋子、相机、遮阳伞</p>
                `;
                
                // 根据天气添加特定建议
                if (hasWeatherData) {
                    const weatherTip = document.createElement('p');
                    weatherTip.className = 'mb-0';
                    weatherTip.style.fontSize = '14px';
                    weatherTip.style.color = '#555';
                    weatherTip.style.marginTop = '8px';
                    
                    if (weatherCondition.includes('雨')) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>天气提醒：</strong> 预计有雨，请带伞并考虑调整为参观室内景点。
                        </p>`;
                    } else if (weatherCondition.includes('晴') && weatherTemp > 30) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>天气提醒：</strong> 天气炎热，请做好防晒，多补充水分，避开中午高温时段。
                        </p>`;
                    } else if (weatherCondition.includes('多云')) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>天气提醒：</strong> 天气适宜，建议按计划游览，是拍照的好天气。
                        </p>`;
                    }
                }
                
                routeHTML += `
                    </div>
                </div>
                `;
                
                // 在回复末尾添加路线信息
                responseElement.innerHTML += routeHTML;
                
                // 更新路线推荐，基于天气情况
                if (window.lastWeatherData) {
                    updateRouteRecommendation(window.lastWeatherData, routes);
                }
            }
            
            // 通过天气代码获取对应的Bootstrap图标
            function getWeatherIcon(condition) {
                const code = condition?.code;
                const isDay = condition?.is_day === 1;
                
                // 基于天气代码和时间返回对应的Bootstrap图标
                if (code >= 1000 && code <= 1003) { // 晴/多云
                    return isDay ? 'bi-sun' : 'bi-moon-stars';
                } else if (code >= 1004 && code <= 1009) { // 阴/多云
                    return 'bi-cloud';
                } else if (code >= 1030 && code <= 1039) { // 雾/霾
                    return 'bi-cloud-fog';
                } else if (code >= 1063 && code <= 1069) { // 小雨
                    return 'bi-cloud-drizzle';
                } else if (code >= 1180 && code <= 1195) { // 中到大雨
                    return 'bi-cloud-rain';
                } else if (code >= 1196 && code <= 1201) { // 冻雨
                    return 'bi-cloud-sleet';
                } else if (code >= 1204 && code <= 1237) { // 雪/冰雹
                    return 'bi-cloud-snow';
                } else if (code >= 1273 && code <= 1282) { // 雷雨
                    return 'bi-cloud-lightning-rain';
                }
                
                return 'bi-cloud'; // 默认图标
            }
            
            // 添加消息到对话区域
            function addMessage(text, isUser, showReasoning = false) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container');
                
                if (isUser) {
                    messageContainer.classList.add('user-message-container');
                    messageContainer.innerHTML = `
                        <div class="user-message">
                            <div class="message-content">${text}</div>
                        </div>
                        <div class="avatar user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                    `;
                } else {
                    messageContainer.classList.add('assistant-message-container');
                    
                    // 只有在showReasoning为true时才创建推理容器
                    let reasoningHtml = '';
                    if (showReasoning) {
                        console.log("正在创建推理容器...");
                        const reasoningContainer = document.createElement('div');
                        reasoningContainer.classList.add('reasoning-container');
                        reasoningContainer.innerHTML = `
                            <div class="reasoning-header">
                                <div class="reasoning-title"><i class="bi bi-lightbulb"></i> 推理过程</div>
                                <div class="reasoning-toggle"><i class="bi bi-chevron-up"></i></div>
                            </div>
                            <div class="reasoning-content"></div>
                        `;
                        
                        // 为推理容器添加展开/折叠功能
                        const reasoningToggle = reasoningContainer.querySelector('.reasoning-toggle');
                        const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                        
                        if (reasoningToggle && reasoningContent) {
                            console.log("成功找到推理容器的切换按钮和内容区域");
                            reasoningToggle.addEventListener('click', function() {
                                reasoningContent.classList.toggle('collapsed');
                                const icon = reasoningToggle.querySelector('i');
                                if (icon) {
                                    icon.classList.toggle('bi-chevron-down');
                                    icon.classList.toggle('bi-chevron-up');
                                }
                            });
                        } else {
                            console.log("未能找到推理容器的切换按钮或内容区域");
                        }
                        
                        // 更新当前推理容器引用
                        lastReasoningContainer = reasoningContainer;
                        reasoningHtml = reasoningContainer.outerHTML;
                        console.log("推理容器HTML已生成");
                    }
                    
                    messageContainer.innerHTML = `
                        <div class="avatar assistant-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="assistant-message">
                            ${showReasoning ? reasoningHtml : ''}
                            <div class="message-content markdown-content" id="currentResponse">${text}</div>
                        </div>
                    `;
                }
                
                chatContent.appendChild(messageContainer);
                chatContent.scrollTop = chatContent.scrollHeight;
                
                return messageContainer;
            }
            
            // 创建推理容器
            function createReasoningContainer(reasoning) {
                const container = document.createElement('div');
                container.className = 'reasoning-container';
                
                const header = document.createElement('div');
                header.className = 'reasoning-header';
                header.innerHTML = '<span>推理过程</span><i class="bi bi-chevron-down"></i>';
                
                const content = document.createElement('div');
                content.className = 'reasoning-content markdown-content';
                // 确保reasoning不是undefined
                content.innerHTML = reasoning ? renderMarkdown(reasoning) : '';
                
                container.appendChild(header);
                container.appendChild(content);
                
                // 添加切换显示/隐藏的功能
                header.addEventListener('click', () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    header.querySelector('i').className = isHidden ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
                });
                
                return container;
            }
            
            // 获取流式响应
            function getStreamingResponse(userMessage) {
                console.log("开始获取LLM流式响应...");
                
                // 禁用发送按钮
                sendButton.disabled = true;
                
                // 找到响应和推理元素
                const responseElement = document.querySelector('#currentResponse');
                const reasoningElement = lastReasoningContainer ? 
                    lastReasoningContainer.querySelector('.reasoning-content') : null;
                
                if (!responseElement) {
                    console.error("找不到响应元素 #currentResponse");
                    return;
                }
                
                // 不再显示警告，只是记录日志
                if (!reasoningElement) {
                    console.log("未找到推理内容元素，可能是正常情况");
                }
                
                // 创建EventSource对象
                const url = `/api/chat?prompt=${encodeURIComponent(userMessage)}`;
                console.log("连接到SSE API: ", url);
                const eventSource = new EventSource(url);
                
                let currentReasoningText = '';
                let currentResponseText = '';
                
                // 监听消息
                eventSource.onmessage = function(event) {
                    console.log("收到SSE消息:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        // 处理推理内容
                        if (data.type === "reasoning" && data.content) {
                            currentReasoningText += data.content;
                            // 安全地处理推理内容元素
                            if (reasoningElement) {
                                try {
                                    reasoningElement.innerHTML = renderMarkdown(currentReasoningText);
                                    if (reasoningElement.scrollHeight) {
                                        reasoningElement.scrollTop = reasoningElement.scrollHeight;
                                    }
                                    
                                    // 确保推理内容容器可见
                                    if (reasoningElement.classList.contains('collapsed')) {
                                        reasoningElement.classList.remove('collapsed');
                                    }
                                } catch (renderError) {
                                    console.log("渲染推理内容时出错:", renderError);
                                }
                            }
                        } 
                        // 当收到分隔符，表示推理结束，开始生成回答
                        else if (data.type === "separator") {
                            console.log("推理结束，开始生成回答");
                            // 清除加载动画
                            if (responseElement) {
                                responseElement.innerHTML = '';
                            }
                        } 
                        // 处理回答内容
                        else if (data.type === "content" && data.content) {
                            currentResponseText += data.content;
                            if (responseElement) {
                                try {
                                    responseElement.innerHTML = renderMarkdown(currentResponseText);
                                    if (chatContent && chatContent.scrollHeight) {
                                        chatContent.scrollTop = chatContent.scrollHeight;
                                    }
                                } catch (renderError) {
                                    console.log("渲染回答内容时出错:", renderError);
                                    responseElement.textContent = currentResponseText; // 回退到纯文本
                                }
                            }
                        }
                        // 处理知识图谱数据
                        else if (data.type === "graph_data" && data.content) {
                            console.log("收到知识图谱数据，准备渲染");
                            try {
                                // 显示加载指示
                                graphLoading.classList.remove('d-none');
                                
                                // 渲染新的知识图谱
                                renderGraph(data.content);
                                
                                // 隐藏加载指示
                                graphLoading.classList.add('d-none');
                            } catch (graphError) {
                                console.error("处理知识图谱数据时出错:", graphError);
                                graphLoading.classList.add('d-none');
                            }
                        }
                        // 处理状态消息
                        else if (data.type === "status" && data.content) {
                            console.log("收到状态消息:", data.content);
                            // 可以选择将状态消息添加到推理内容或其他地方
                        }
                        // 处理流结束事件
                        else if (data.type === "end") {
                            console.log("流式响应结束");
                            eventSource.close();
                            sendButton.disabled = false;
                            
                            // 提取偏好并获取路线数据
                            try {
                                if (typeof window.extractPreferencesAndGetRoutes === 'function') {
                                    window.extractPreferencesAndGetRoutes(userMessage);
                                } else if (typeof extractPreferencesAndGetRoutes === 'function') {
                                    extractPreferencesAndGetRoutes(userMessage);
                                }
                            } catch (routeError) {
                                console.log("提取偏好或获取路线时出错:", routeError);
                            }
                        }
                    } catch (error) {
                        console.error("解析事件数据出错:", error, "原始数据:", event.data);
                        if (responseElement) {
                            responseElement.innerHTML = "解析响应时出现错误，请稍后再试。";
                        }
                        eventSource.close();
                        sendButton.disabled = false;
                    }
                };
                
                // 连接打开时的处理
                eventSource.onopen = function(event) {
                    console.log("SSE连接已打开");
                };
                
                // 错误处理
                eventSource.onerror = function(event) {
                    console.error("EventSource错误:", event);
                    eventSource.close();
                    
                    if (responseElement) {
                        if (currentResponseText) {
                            // 如果已有一些回答，保留它
                            responseElement.innerHTML = renderMarkdown(currentResponseText);
                        } else {
                            // 否则显示错误消息
                            responseElement.innerHTML = renderMarkdown("连接到服务器时出错，请重试。");
                        }
                    }
                    
                    sendButton.disabled = false;
                };
            }
            
            // 提取偏好并获取路线数据
            function extractPreferencesAndGetRoutes(userMessage) {
                console.log("提取用户旅行偏好...");
                
                // 显示加载指示器
                mapLoading.classList.remove('d-none');
                graphLoading.classList.remove('d-none');
                
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: userMessage, extract_preferences: true })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`提取偏好API错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(preferences => {
                    console.log("旅行偏好提取结果: ", preferences);
                    
                    // 检查是否返回了有效的偏好数据
                    if (!preferences || !preferences.theme) {
                        console.warn("未获取到有效的偏好数据，使用默认偏好");
                        preferences = {
                            theme: "文化体验",
                            city: "杭州",
                            days: 1,
                            energy: "中等"
                        };
                    }
                    
                    // 显示提取的偏好信息
                    const responseElement = document.getElementById('currentResponse');
                    if (responseElement) {
                        const preferenceHTML = `
                        <div class="alert alert-info mt-2 mb-3" style="background-color: #E3F2FD; border: none; border-radius: 8px; padding: 15px 20px;">
                            <strong>已识别您的旅行偏好：</strong> 
                            <span class="badge ms-1" style="background-color: #1976D2; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.theme}</span>
                            <span class="badge ms-1" style="background-color: #455A64; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.days}天</span>
                            <span class="badge ms-1" style="background-color: #26C6DA; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.energy}强度</span>
                        </div>`;
                        
                        // 在现有内容前添加偏好信息
                        responseElement.innerHTML = preferenceHTML + responseElement.innerHTML;
                    }
                
                    // 用提取的偏好调用统一数据API
                    return fetch('/api/unified_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(preferences)
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`统一数据API错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("获取到统一数据:", data);
                    
                    if (data.error) {
                        console.error("统一数据API错误:", data.error);
                        throw new Error("获取路线数据失败: " + data.error);
                    }
                    
                    // 获取目的地天气信息
                    getDestinationWeather(data.city || "杭州");
                    
                    // 渲染地图
                    renderMap(data.routes);
                    
                    // 渲染知识图谱
                    renderGraph(data.graph_data);
                    
                    // 渲染路线信息到当前回复中
                    if (data.routes && data.routes.length > 0) {
                        appendRouteInfoToResponse(data.routes, data.theme);
                    }
                    
                    // 移除加载指示器
                    mapLoading.classList.add('d-none');
                    graphLoading.classList.add('d-none');
                })
                .catch(error => {
                    console.error('路线数据获取错误:', error);
                    
                    // 显示错误信息
                    const responseElement = document.getElementById('currentResponse');
                    if (responseElement) {
                        responseElement.innerHTML += `
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle"></i> 
                            获取旅行路线失败，请重试。错误信息: ${error.message}
                        </div>`;
                    }
                    
                    // 移除加载指示器
                    mapLoading.classList.add('d-none');
                    graphLoading.classList.add('d-none');
                });
            }
            
            // 渲染地图
            function renderMap(routes) {
                // 检查路线数据
                if (!routes || routes.length === 0) {
                    console.warn("没有路线数据可显示");
                    return; // 不清空地图，保留现有底图
                }
                
                // 清空地图容器
                mapContainer.innerHTML = '';
                
                // 创建加载指示器
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'map-loading-indicator';
                loadingIndicator.style.position = 'absolute';
                loadingIndicator.style.top = '50%';
                loadingIndicator.style.left = '50%';
                loadingIndicator.style.transform = 'translate(-50%, -50%)';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">加载中...</span>
                    </div>
                    <p class="mt-2 text-muted">正在更新地图和路线...</p>
                `;
                mapContainer.appendChild(loadingIndicator);
                
                // 创建iframe以显示地图
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.5s ease';
                
                // 添加iframe到容器
                mapContainer.appendChild(iframe);
                
                // 发送请求生成地图
                fetch('/api/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ routes })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`地图API错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // 当iframe加载完成时，显示iframe并移除加载指示器
                    iframe.onload = function() {
                        iframe.style.opacity = '1';
                        loadingIndicator.style.display = 'none';
                    };
                    
                    // 设置iframe源
                    iframe.src = data.map_url;
                })
                .catch(error => {
                    console.error('地图渲染错误:', error);
                    loadingIndicator.style.display = 'none';
                    mapContainer.innerHTML = `
                        <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                            <h5>加载地图时出错</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
            }
            
            // 渲染知识图谱
            function renderGraph(graphData) {
                // 检查图谱数据
                if (!graphData || !graphData.nodes || !graphData.links) {
                    console.warn("没有知识图谱数据可显示");
                    graphContainer.innerHTML = '<div class="d-flex h-100 justify-content-center align-items-center text-muted">没有找到相关的知识图谱数据</div>';
                    return;
                }
                
                // 获取当前规划路线中的POI ID
                let routePoiIds = [];
                const routeElements = document.querySelectorAll('.route-item');
                if (routeElements.length > 0) {
                    // 我们有活跃的路线，提取所有POI ID
                    graphData.nodes.forEach(node => {
                        // 初始化节点的匹配状态，默认为未匹配
                        node.inRoute = false;
                    });
                    
                    // 从路线信息中获取POI名称
                    const poiNameElements = document.querySelectorAll('.route-item ol li');
                    const poiNames = Array.from(poiNameElements).map(el => el.textContent.split(' (')[0].trim());
                    
                    // 匹配图谱节点与路线POI
                    if (poiNames.length > 0) {
                        graphData.nodes.forEach(node => {
                            if (poiNames.includes(node.name)) {
                                node.inRoute = true;
                                routePoiIds.push(node.id);
                            }
                        });
                    }
                }
                
                // 清空图谱容器
                graphContainer.innerHTML = '';
                
                // 创建图例
                const legend = document.createElement('div');
                legend.className = 'kg-legend';
                
                // 获取类别和颜色
                const categories = graphData.categories || [];
                let nodeTypes = [];
                
                // 如果有明确的类别定义，使用它
                if (categories.length > 0) {
                    nodeTypes = categories;
                } else {
                    // 否则从节点中提取类别
                    const typeSet = new Set();
                    graphData.nodes.forEach(node => {
                        if (node.category) typeSet.add(node.category);
                    });
                    nodeTypes = Array.from(typeSet).map(name => ({ name }));
                }
                
                // 定义颜色
                const typeColors = {
                    '自然景观': '#2c7bb6',
                    '历史古迹': '#d7191c',
                    '文化场所': '#fdae61',
                    '购物区域': '#abd9e9',
                    '美食街区': '#66bd63',
                    '景点': '#42a5f5',
                    '古迹': '#ef5350',
                    '文化体验': '#5c6bc0',
                    '历史遗址': '#66bb6a',
                    '博物馆': '#ec407a',
                    '茶馆': '#ffa726',
                    '历史建筑': '#8d6e63'
                };
                
                // 图例标题
                const title = document.createElement('div');
                title.textContent = '景点分类';
                title.style.fontWeight = 'bold';
                title.style.marginBottom = '10px';
                title.style.fontSize = '14px';
                title.style.borderBottom = '2px solid #e1e1e1';
                title.style.paddingBottom = '8px';
                title.style.color = '#1a237e';
                legend.appendChild(title);
                
                // 添加节点类型图例
                const categoryGrid = document.createElement('div');
                categoryGrid.style.display = 'grid';
                categoryGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                categoryGrid.style.gap = '8px';
                categoryGrid.style.marginBottom = '10px';
                
                nodeTypes.forEach(type => {
                    const color = type.color || typeColors[type.name] || '#999';
                    
                    const legendItem = document.createElement('div');
                    legendItem.style.display = 'flex';
                    legendItem.style.alignItems = 'center';
                    legendItem.style.padding = '5px 8px';
                    legendItem.style.borderRadius = '4px';
                    legendItem.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                    legendItem.style.border = '1px solid ' + color;
                    legendItem.style.transition = 'all 0.2s ease';
                    
                    legendItem.addEventListener('mouseover', () => {
                        legendItem.style.backgroundColor = color + '22'; // 添加透明度
                        legendItem.style.transform = 'translateY(-2px)';
                        legendItem.style.boxShadow = '0 3px 8px rgba(0,0,0,0.1)';
                    });
                    
                    legendItem.addEventListener('mouseout', () => {
                        legendItem.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                        legendItem.style.transform = 'translateY(0)';
                        legendItem.style.boxShadow = 'none';
                    });
                    
                    const colorBox = document.createElement('span');
                    colorBox.style.display = 'inline-block';
                    colorBox.style.width = '12px';
                    colorBox.style.height = '12px';
                    colorBox.style.marginRight = '8px';
                    colorBox.style.backgroundColor = color;
                    colorBox.style.borderRadius = '3px';
                    colorBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(document.createTextNode(type.name));
                    categoryGrid.appendChild(legendItem);
                });
                
                legend.appendChild(categoryGrid);
                
                // 添加路线POI图例
                if (routePoiIds.length > 0) {
                    const statusTitle = document.createElement('div');
                    statusTitle.textContent = '节点状态';
                    statusTitle.style.fontWeight = 'bold';
                    statusTitle.style.marginTop = '15px';
                    statusTitle.style.marginBottom = '10px';
                    statusTitle.style.fontSize = '14px';
                    statusTitle.style.borderBottom = '2px solid #e1e1e1';
                    statusTitle.style.paddingBottom = '8px';
                    statusTitle.style.color = '#1a237e';
                    legend.appendChild(statusTitle);
                    
                    const routeItem = document.createElement('div');
                    routeItem.style.display = 'flex';
                    routeItem.style.alignItems = 'center';
                    routeItem.style.padding = '5px 8px';
                    routeItem.style.marginBottom = '8px';
                    routeItem.style.borderRadius = '4px';
                    routeItem.style.backgroundColor = 'rgba(255, 87, 34, 0.1)';
                    routeItem.style.border = '1px solid #ff5722';
                    
                    const routeBox = document.createElement('span');
                    routeBox.style.display = 'inline-block';
                    routeBox.style.width = '12px';
                    routeBox.style.height = '12px';
                    routeBox.style.marginRight = '8px';
                    routeBox.style.border = '2px solid #ff5722';
                    routeBox.style.borderRadius = '50%';
                    routeBox.style.backgroundColor = 'rgba(255, 87, 34, 0.3)';
                    routeBox.style.boxShadow = '0 0 8px rgba(255, 87, 34, 0.5)';
                    
                    routeItem.appendChild(routeBox);
                    routeItem.appendChild(document.createTextNode('路线中的景点'));
                    legend.appendChild(routeItem);
                    
                    // 添加选中图例
                    const selectedItem = document.createElement('div');
                    selectedItem.style.display = 'flex';
                    selectedItem.style.alignItems = 'center';
                    selectedItem.style.padding = '5px 8px';
                    selectedItem.style.borderRadius = '4px';
                    selectedItem.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                    selectedItem.style.border = '1px solid #333';
                    
                    const selectedBox = document.createElement('span');
                    selectedBox.style.display = 'inline-block';
                    selectedBox.style.width = '12px';
                    selectedBox.style.height = '12px';
                    selectedBox.style.marginRight = '8px';
                    selectedBox.style.border = '2px solid #333';
                    selectedBox.style.borderRadius = '50%';
                    selectedBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                    
                    selectedItem.appendChild(selectedBox);
                    selectedItem.appendChild(document.createTextNode('选中的景点'));
                    legend.appendChild(selectedItem);
                } else {
                    // 简化版：只显示选中图例
                    const selectedItem = document.createElement('div');
                    selectedItem.style.display = 'flex';
                    selectedItem.style.alignItems = 'center';
                    selectedItem.style.marginTop = '15px';
                    selectedItem.style.padding = '5px 8px';
                    selectedItem.style.borderRadius = '4px';
                    selectedItem.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                    selectedItem.style.border = '1px solid #333';
                    
                    const selectedBox = document.createElement('span');
                    selectedBox.style.display = 'inline-block';
                    selectedBox.style.width = '12px';
                    selectedBox.style.height = '12px';
                    selectedBox.style.marginRight = '8px';
                    selectedBox.style.border = '2px solid #333';
                    selectedBox.style.borderRadius = '50%';
                    selectedBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                    
                    selectedItem.appendChild(selectedBox);
                    selectedItem.appendChild(document.createTextNode('选中的景点'));
                    legend.appendChild(selectedItem);
                }
                
                // 添加图例到容器
                graphContainer.appendChild(legend);
                
                // 设置 SVG 尺寸
                const width = graphContainer.clientWidth;
                const height = graphContainer.clientHeight;
                
                // 创建 SVG 元素
                const svg = d3.select(graphContainer)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("class", "kg-svg");
                
                // 创建工具提示
                const tooltip = d3.select(graphContainer)
                    .append("div")
                    .attr("class", "kg-tooltip")
                    .style("position", "absolute")
                    .style("visibility", "hidden")
                    .style("background-color", "rgba(30, 30, 50, 0.9)")
                    .style("color", "white")
                    .style("padding", "10px 15px")
                    .style("border-radius", "6px")
                    .style("box-shadow", "0 4px 15px rgba(0, 0, 0, 0.3)")
                    .style("font-size", "14px")
                    .style("max-width", "300px")
                    .style("backdrop-filter", "blur(5px)")
                    .style("z-index", "1000")
                    .style("pointer-events", "none")
                    .style("opacity", 0);
                
                // 更新工具提示内容和位置的函数
                function updateTooltip(d, pageX, pageY) {
                    // 获取节点的类别信息
                    const category = categories.find(c => c.name === d.category);
                    const categoryColor = category ? category.color : typeColors[d.category] || '#999';
                    
                    // 创建工具提示内容
                    let html = `
                        <div style="margin-bottom: 8px; border-bottom: 2px solid ${categoryColor}; padding-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 16px;">${d.name}</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${categoryColor}; border-radius: 2px; margin-right: 5px;"></span>
                            <span style="font-weight: 500;">${d.category}</span>
                        </div>
                    `;
                    
                    // 添加描述（如果有）
                    if (d.description) {
                        html += `<div style="margin-top: 8px; font-size: 13px; line-height: 1.4;">${d.description.substring(0, 100)}${d.description.length > 100 ? '...' : ''}</div>`;
                    }
                    
                    // 添加属性信息（如评分、票价等）
                    html += '<div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px;">';
                    
                    if (d.rating) {
                        const stars = '★'.repeat(Math.round(d.rating)) + '☆'.repeat(5 - Math.round(d.rating));
                        html += `<div><span style="opacity: 0.8;">评分:</span> <span style="color: #FFC107;">${stars}</span></div>`;
                    }
                    
                    if (d.properties && d.properties.price !== undefined) {
                        html += `<div><span style="opacity: 0.8;">票价:</span> ${d.properties.price > 0 ? '¥' + d.properties.price : '免费'}</div>`;
                    }
                    
                    if (d.properties && d.properties.visit_time) {
                        html += `<div><span style="opacity: 0.8;">游览时间:</span> ${d.properties.visit_time}分钟</div>`;
                    }
                    
                    html += '</div>';
                    
                    // 如果是在路线中的POI，添加指示
                    if (d.inRoute) {
                        html += `<div style="margin-top: 10px; padding: 5px; background-color: rgba(255,87,34,0.2); border-radius: 4px; font-size: 12px; color: #ff5722;">此景点在您的旅行路线中</div>`;
                    }
                    
                    // 更新工具提示内容
                    tooltip.html(html);
                    
                    // 确定最佳工具提示位置
                    const tooltipWidth = 300; // 估计的宽度
                    const tooltipHeight = 180; // 估计的高度
                    
                    // 计算相对于视口的最佳位置
                    let left = pageX + 15;
                    let top = pageY - 10;
                    
                    // 确保不超出右边界
                    if (left + tooltipWidth > window.innerWidth) {
                        left = pageX - tooltipWidth - 10;
                    }
                    
                    // 确保不超出底部边界
                    if (top + tooltipHeight > window.innerHeight) {
                        top = window.innerHeight - tooltipHeight - 10;
                    }
                    
                    // 设置位置
                    tooltip.style("left", left + "px")
                           .style("top", top + "px");
                }
                
                // 创建箭头标记
                svg.append("defs").append("marker")
                    .attr("id", "arrowhead")
                    .attr("viewBox", "-0 -5 10 10")
                    .attr("refX", 25) // 调整箭头位置，使其刚好在节点边缘
                    .attr("refY", 0)
                    .attr("orient", "auto")
                    .attr("markerWidth", 8)
                    .attr("markerHeight", 8)
                    .attr("xoverflow", "visible")
                    .append("path")
                    .attr("d", "M 0,-5 L 10 ,0 L 0,5")
                    .attr("fill", "#999")
                    .style("stroke", "none");
                
                // 定义缩放行为
                const zoom = d3.zoom()
                    .scaleExtent([0.3, 4]) // 允许更大范围的缩放
                    .on("zoom", (event) => {
                        // 应用缩放和平移变换
                        container.attr("transform", event.transform);
                    });
                
                // 启用缩放
                svg.call(zoom);
                
                // 创建一个容器来包含所有元素，使它们一起缩放和平移
                const container = svg.append("g")
                    .attr("class", "container");
                
                // 创建关系连线
                const links = container.selectAll(".link")
                    .data(graphData.links)
                    .enter()
                    .append("line")
                    .attr("class", "kg-link")
                    .style("stroke", "#999")
                    .style("stroke-width", d => {
                        // 强调连接路线中POI的连线
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (sourceInRoute && targetInRoute) {
                                return Math.max(2, (d.strength || 0.5) * 3);
                            }
                        }
                        return Math.max(1, d.strength * 2 || 1);
                    })
                    .style("stroke-opacity", d => {
                        // 弱化非路线相关的连线
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (!sourceInRoute && !targetInRoute) {
                                return 0.3;
                            }
                        }
                        return 0.6;
                    })
                    .attr("marker-end", "url(#arrowhead)");
                
                // 获取节点半径的函数
                const getNodeRadius = d => {
                    // 突出路线上的节点
                    if (d.inRoute) return 14;
                    
                    // 根据节点是否被高亮或选择来决定大小
                    const baseRadius = d.highlighted ? 12 : 8;
                    
                    // 可以根据其他属性进一步调整大小，比如评分或重要性
                    return baseRadius + (d.rating ? (d.rating / 5) * 4 : 0);
                };
                
                // 添加径向渐变定义
                const defs = svg.append("defs");
                
                // 为每种类别创建径向渐变
                categories.forEach(category => {
                    const gradientId = "gradient-" + category.name.replace(/\s+/g, '-').toLowerCase();
                    
                    // 提取基础颜色
                    const baseColor = category.color || typeColors[category.name] || '#999';
                    
                    // 计算渐变的亮色和暗色版本
                    const lighterColor = pSBC(0.2, baseColor); // 更亮的版本
                    const darkerColor = pSBC(-0.2, baseColor); // 更暗的版本
                    
                    const gradient = defs.append("radialGradient")
                        .attr("id", gradientId)
                        .attr("cx", "50%")
                        .attr("cy", "50%")
                        .attr("r", "50%")
                        .attr("fx", "50%")
                        .attr("fy", "50%");
                        
                    gradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", lighterColor);
                        
                    gradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", darkerColor);
                });
                
                // 添加发光效果滤镜
                const glowFilter = defs.append("filter")
                    .attr("id", "glow")
                    .attr("height", "300%")
                    .attr("width", "300%")
                    .attr("x", "-100%")
                    .attr("y", "-100%");
                    
                glowFilter.append("feGaussianBlur")
                    .attr("stdDeviation", "5")
                    .attr("result", "coloredBlur");
                    
                const glowMerge = glowFilter.append("feMerge");
                glowMerge.append("feMergeNode").attr("in", "coloredBlur");
                glowMerge.append("feMergeNode").attr("in", "SourceGraphic");
                
                // 添加更强的发光效果
                const strongGlowFilter = defs.append("filter")
                    .attr("id", "strongGlow")
                    .attr("height", "300%")
                    .attr("width", "300%")
                    .attr("x", "-100%")
                    .attr("y", "-100%");
                    
                strongGlowFilter.append("feGaussianBlur")
                    .attr("stdDeviation", "10")
                    .attr("result", "coloredBlur");
                    
                const strongGlowMerge = strongGlowFilter.append("feMerge");
                strongGlowMerge.append("feMergeNode").attr("in", "coloredBlur");
                strongGlowMerge.append("feMergeNode").attr("in", "SourceGraphic");
                
                // 创建节点分组，使用渐变色和发光效果
                const nodeGroups = container.selectAll(".node")
                    .data(graphData.nodes)
                    .enter()
                    .append("g")
                    .attr("class", d => {
                        let classes = "kg-node";
                        if (d.highlighted) classes += " highlighted";
                        if (d.inRoute) classes += " in-route";
                        return classes;
                    })
                    .style("opacity", d => {
                        // 弱化不在路线上的节点
                        if (routePoiIds.length > 0 && !d.inRoute) {
                            return 0.4;
                        }
                        return 1;
                    })
                    .call(d3.drag()
                        .on("start", dragStarted)
                        .on("drag", dragged)
                        .on("end", dragEnded));
                
                // 添加节点圆形，使用渐变和发光效果
                const circles = nodeGroups.append("circle")
                    .attr("r", getNodeRadius)
                    .style("fill", d => {
                        // 直接使用分类颜色
                        const category = categories.find(c => c.name === d.category);
                        return category ? category.color : typeColors[d.category] || '#999';
                    })
                    .style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return d.highlighted ? "#ff5722" : "rgba(255,255,255,0.8)";
                    })
                    .style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return d.highlighted ? 3 : 1.5;
                    })
                    .style("filter", d => {
                        if (d.inRoute || d.highlighted) return "url(#strongGlow)";
                        return "";
                    });
                
                // 添加脉动动画圆圈
                nodeGroups.filter(d => d.highlighted || d.inRoute).each(function(d) {
                    const node = d3.select(this);
                    const radius = getNodeRadius(d);
                    
                    // 添加脉动环
                    const pulseRing = node.append("circle")
                        .attr("r", radius + 5)
                        .style("fill", "none")
                        .style("stroke", d.inRoute ? "#ff5722" : "#f44336")
                        .style("stroke-width", 2)
                        .style("stroke-opacity", 0.7)
                        .style("stroke-dasharray", "5,5");
                        
                    // 应用脉动动画
                    pulseRing.append("animate")
                        .attr("attributeName", "r")
                        .attr("from", radius + 5)
                        .attr("to", radius + 15)
                        .attr("dur", "1.5s")
                        .attr("repeatCount", "indefinite");
                        
                    pulseRing.append("animate")
                        .attr("attributeName", "stroke-opacity")
                        .attr("from", "0.7")
                        .attr("to", "0")
                        .attr("dur", "1.5s")
                        .attr("repeatCount", "indefinite");
                        
                    // 添加第二个错开的脉动环以增强效果
                    const pulseRing2 = node.append("circle")
                        .attr("r", radius + 10)
                        .style("fill", "none")
                        .style("stroke", d.inRoute ? "#ff5722" : "#f44336")
                        .style("stroke-width", 1.5)
                        .style("stroke-opacity", 0.5)
                        .style("stroke-dasharray", "3,3");
                        
                    pulseRing2.append("animate")
                        .attr("attributeName", "r")
                        .attr("from", radius + 10)
                        .attr("to", radius + 20)
                        .attr("dur", "2s")
                        .attr("repeatCount", "indefinite");
                        
                    pulseRing2.append("animate")
                        .attr("attributeName", "stroke-opacity")
                        .attr("from", "0.5")
                        .attr("to", "0")
                        .attr("dur", "2s")
                        .attr("repeatCount", "indefinite");
                });
                
                // 添加文本标签
                nodeGroups.append("text")
                    .attr("dy", d => -getNodeRadius(d) - 5)
                    .attr("text-anchor", "middle")
                    .style("font-size", d => {
                        // 突出路线上的节点标签
                        if (d.inRoute) return "14px";
                        return d.highlighted ? "13px" : "12px";
                    })
                    .style("font-weight", d => {
                        if (d.inRoute || d.highlighted) return "bold";
                        return "normal";
                    })
                    .style("pointer-events", "none")
                    .style("fill", "#333")
                    .style("text-shadow", "0px 0px 3px rgba(255,255,255,0.9), 0px 0px 5px rgba(255,255,255,0.7)")
                    .text(d => d.name);
                
                // 节点点击事件
                nodeGroups.on("click", function(event, d) {
                    event.stopPropagation(); // 阻止事件冒泡
                    
                    // 突出显示当前节点及其连接
                    highlightNode(d);
                    
                    // 显示工具提示
                    tooltip.transition()
                        .duration(200)
                        .style("visibility", "visible")
                        .style("opacity", 1);
                        
                    // 更新工具提示内容和位置
                    updateTooltip(d, event.pageX, event.pageY);
                });
                
                // 鼠标悬停事件
                nodeGroups.on("mouseover", function(event, d) {
                    d3.select(this).style("cursor", "pointer");
                    
                    // 仅当尚未点击选择任何节点时，显示工具提示
                    if (!currentSelectedNode) {
                        tooltip.transition()
                            .duration(200)
                            .style("visibility", "visible")
                            .style("opacity", 0.9);
                            
                        updateTooltip(d, event.pageX, event.pageY);
                    }
                })
                .on("mouseout", function() {
                    // 仅当尚未点击选择任何节点时，隐藏工具提示
                    if (!currentSelectedNode) {
                        tooltip.transition()
                            .duration(500)
                            .style("visibility", "hidden")
                            .style("opacity", 0);
                    }
                });
                
                // 点击图谱背景时重置视图
                svg.on("click", (event) => {
                    if (event.target === svg.node() || event.target.tagName === "rect") {
                        // 重置所有节点的highlighted属性
                        graphData.nodes.forEach(node => {
                            node.highlighted = false;
                        });
                        
                        // 重置所有节点样式
                        circles.style("stroke", d => {
                            if (d.inRoute) return "#ff5722";
                            return "rgba(255,255,255,0.8)";
                        }).style("stroke-width", d => {
                            if (d.inRoute) return 3;
                            return 1.5;
                        }).style("filter", d => {
                            if (d.inRoute) return "url(#glow)";
                            return "none";
                        });
                        
                        // 重置所有连线样式
                        links.style("stroke", d => {
                            if (d.inRoute) return "#ff5722";
                            return "rgba(255, 255, 255, 0.2)";
                        }).style("stroke-width", d => {
                            if (d.inRoute) return 2.5;
                            return 1;
                        }).style("opacity", 0.6)
                        .style("filter", "none");
                        
                        // 移除详细信息卡片
                        d3.selectAll('.node-info-card').style("transform", "translateY(20px)")
                            .style("opacity", "0");
                        setTimeout(() => d3.selectAll('.node-info-card').remove(), 300);
                        
                        // 隐藏提示框
                        tooltip.style("visibility", "hidden")
                            .style("opacity", 0);
                    }
                });
                
                // 跟踪当前选中的节点
                let currentSelectedNode = null;
                
                // 高亮节点及其连接
                function highlightNode(d) {
                    // 设置当前选中的节点
                    currentSelectedNode = d;
                    
                    // 计算连接强度
                    const connectionStrength = {};
                    connectionStrength[d.id] = 1.0; // 选中的节点强度为1
                    
                    // 标记直接连接的节点
                    const directConnections = {};
                    links.each(function(l) {
                        if (l.source.id === d.id) {
                            directConnections[l.target.id] = l.strength || 0.5;
                            connectionStrength[l.target.id] = l.strength || 0.5;
                        } else if (l.target.id === d.id) {
                            directConnections[l.source.id] = l.strength || 0.5;
                            connectionStrength[l.source.id] = l.strength || 0.5;
                        }
                    });
                    
                    // 高亮连接的节点，弱化其他节点
                    nodeGroups.each(function(n) {
                        const strength = connectionStrength[n.id] || 0;
                        const opacity = strength > 0 ? Math.max(0.3, strength) : 0.15;
                        d3.select(this)
                          .style("opacity", opacity)
                          .style("filter", n.id === d.id ? "url(#strongGlow)" : "");
                    });
                    
                    // 高亮连接的连线，弱化其他连线
                    links.style("stroke-opacity", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            return Math.min(1, (l.strength || 0.5) + 0.3);
                        }
                        return 0.05;
                    })
                    .style("stroke-width", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            return Math.max(2, (l.strength || 0.5) * 4);
                        }
                        return 1;
                    })
                    .style("stroke", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            // 使用目标节点的分类颜色
                            const targetNode = l.source.id === d.id ? l.target : l.source;
                            const category = categories.find(c => c.name === targetNode.category);
                            return category ? category.color : "#999";
                        }
                        return "#999";
                    });
                }
                
                // 重置高亮的函数
                function resetHighlight() {
                    // 重置节点不透明度
                    nodeGroups.style("opacity", d => {
                        if (routePoiIds.length > 0 && !d.inRoute) {
                            return 0.4;
                        }
                        return 1;
                    })
                    .style("filter", d => {
                        if (d.inRoute || d.highlighted) return "url(#strongGlow)";
                        return "";
                    });
                    
                    // 重置连线不透明度
                    links.style("stroke-opacity", d => {
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (!sourceInRoute && !targetInRoute) {
                                return 0.3;
                            }
                        }
                        return 0.6;
                    })
                    .style("stroke-width", d => {
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (sourceInRoute && targetInRoute) {
                                return Math.max(2, (d.strength || 0.5) * 3);
                            }
                        }
                        return Math.max(1, (d.strength || 0.5) * 2);
                    })
                    .style("stroke", "#999");
                    
                    // 重置节点边框样式
                    circles.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return d.highlighted ? "#ff5722" : "rgba(255,255,255,0.8)";
                    })
                    .style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return d.highlighted ? 3 : 1.5;
                    });
                }
                
                // 创建力导向图模拟
                const simulation = d3.forceSimulation(graphData.nodes)
                    .force("link", d3.forceLink(graphData.links)
                        .id(d => d.id)
                        .distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                    .on("tick", ticked);
                
                // 更新节点和连线位置的函数
                function ticked() {
                    links
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => {
                            // 计算向量方向
                            const dx = d.target.x - d.source.x;
                            const dy = d.target.y - d.source.y;
                            const len = Math.sqrt(dx * dx + dy * dy);
                            // 调整终点位置，使线条不要完全到达目标节点中心
                            const targetRadius = getNodeRadius(d.target);
                            return d.target.x - (dx / len) * targetRadius;
                        })
                        .attr("y2", d => {
                            // 同上，处理y坐标
                            const dx = d.target.x - d.source.x;
                            const dy = d.target.y - d.source.y;
                            const len = Math.sqrt(dx * dx + dy * dy);
                            const targetRadius = getNodeRadius(d.target);
                            return d.target.y - (dy / len) * targetRadius;
                        });
                    
                    nodeGroups.attr("transform", d => `translate(${d.x}, ${d.y})`);
                }
                
                // 拖拽相关函数
                function dragStarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                
                function dragEnded(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                
                // 添加缩放控制按钮
                const zoomControls = document.createElement('div');
                zoomControls.className = 'zoom-controls';
                
                const zoomInBtn = document.createElement('button');
                zoomInBtn.innerHTML = '<i class="bi bi-plus"></i>';
                zoomInBtn.title = "放大";
                zoomInBtn.onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 1.3);
                
                const zoomOutBtn = document.createElement('button');
                zoomOutBtn.innerHTML = '<i class="bi bi-dash"></i>';
                zoomOutBtn.title = "缩小";
                zoomOutBtn.onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 0.7);
                
                const resetBtn = document.createElement('button');
                resetBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                resetBtn.title = "重置视图";
                resetBtn.onclick = () => {
                    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
                    resetHighlight();
                    tooltip.style("visibility", "hidden").style("opacity", 0);
                };
                
                zoomControls.appendChild(zoomInBtn);
                zoomControls.appendChild(zoomOutBtn);
                zoomControls.appendChild(resetBtn);
                
                graphContainer.appendChild(zoomControls);
                
                // 尝试自动调整缩放以适合所有节点
                setTimeout(() => {
                    const bounds = svg.node().getBBox();
                    const dx = bounds.width;
                    const dy = bounds.height;
                    const x = bounds.x + dx / 2;
                    const y = bounds.y + dy / 2;
                    
                    // 只在节点较多时自动调整缩放
                    if (graphData.nodes.length > 5) {
                        const scale = 0.9 / Math.max(dx / width, dy / height);
                        const translate = [width / 2 - scale * x, height / 2 - scale * y];
                        
                        svg.transition()
                            .duration(750)
                            .call(zoom.transform, d3.zoomIdentity
                                .translate(translate[0], translate[1])
                                .scale(scale));
                    }
                }, 100);

                // 添加连线动画和流光效果
                links.each(function(d) {
                    const link = d3.select(this);
                    
                    // 为路线中的连接添加流光动画效果
                    if (routePoiIds.length > 0) {
                        const sourceInRoute = routePoiIds.includes(d.source.id);
                        const targetInRoute = routePoiIds.includes(d.target.id);
                        
                        if (sourceInRoute && targetInRoute) {
                            // 创建流光线条
                            const flowLine = container.append("line")
                                .attr("class", "flow-line")
                                .style("stroke", "#ff5722")
                                .style("stroke-width", 2)
                                .style("stroke-linecap", "round")
                                .style("stroke-opacity", 0.6)
                                .style("stroke-dasharray", "5, 10");
                            
                            // 添加流光动画
                            const totalLength = Math.sqrt(
                                Math.pow(d.target.x - d.source.x, 2) + 
                                Math.pow(d.target.y - d.source.y, 2)
                            );
                            
                            flowLine.attr("x1", d.source.x)
                                .attr("y1", d.source.y)
                                .attr("x2", d.source.x)
                                .attr("y2", d.source.y)
                                .transition()
                                .duration(2000)
                                .ease(d3.easeLinear)
                                .attr("x2", d.target.x)
                                .attr("y2", d.target.y)
                                .on("end", function repeat() {
                                    d3.select(this)
                                        .attr("x1", d.source.x)
                                        .attr("y1", d.source.y)
                                        .attr("x2", d.source.x)
                                        .attr("y2", d.source.y)
                                        .transition()
                                        .duration(2000)
                                        .ease(d3.easeLinear)
                                        .attr("x2", d.target.x)
                                        .attr("y2", d.target.y)
                                        .on("end", repeat);
                                });
                        }
                    }
                });

                // 添加力导向图控制面板
                const controlPanel = document.createElement('div');
                controlPanel.className = 'graph-control-panel';
                controlPanel.style.position = 'absolute';
                controlPanel.style.bottom = '15px';
                controlPanel.style.left = '15px';
                controlPanel.style.background = 'rgba(255, 255, 255, 0.9)';
                controlPanel.style.padding = '10px';
                controlPanel.style.borderRadius = '8px';
                controlPanel.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
                controlPanel.style.zIndex = '100';
                controlPanel.style.fontSize = '12px';
                controlPanel.style.backdropFilter = 'blur(5px)';
                controlPanel.style.border = '1px solid rgba(230, 230, 250, 0.7)';
                controlPanel.style.transition = 'all 0.3s ease';
                controlPanel.style.maxWidth = '220px';
                controlPanel.style.opacity = '0.8';

                // 悬停时完全显示
                controlPanel.addEventListener('mouseenter', () => {
                    controlPanel.style.opacity = '1';
                });
                controlPanel.addEventListener('mouseleave', () => {
                    controlPanel.style.opacity = '0.8';
                });

                // 添加控制面板标题
                const panelTitle = document.createElement('div');
                panelTitle.textContent = '知识图谱设置';
                panelTitle.style.fontWeight = 'bold';
                panelTitle.style.marginBottom = '8px';
                panelTitle.style.color = '#1a237e';
                panelTitle.style.borderBottom = '2px solid #e1e1e1';
                panelTitle.style.paddingBottom = '5px';
                controlPanel.appendChild(panelTitle);

                // 添加力导向控制
                const forceGroup = document.createElement('div');
                forceGroup.style.marginBottom = '10px';

                // 力强度控制
                const forceLabel = document.createElement('label');
                forceLabel.textContent = '节点排斥力:';
                forceLabel.style.display = 'block';
                forceLabel.style.marginBottom = '5px';
                forceGroup.appendChild(forceLabel);

                const forceSlider = document.createElement('input');
                forceSlider.type = 'range';
                forceSlider.min = '-800';
                forceSlider.max = '-100';
                forceSlider.value = '-300';
                forceSlider.style.width = '100%';
                forceSlider.addEventListener('input', function() {
                    // 实时更新力强度
                    simulation.force("charge").strength(parseInt(this.value));
                    simulation.alpha(0.3).restart();
                });
                forceGroup.appendChild(forceSlider);

                // 连接距离控制
                const distanceLabel = document.createElement('label');
                distanceLabel.textContent = '连接距离:';
                distanceLabel.style.display = 'block';
                distanceLabel.style.marginTop = '10px';
                distanceLabel.style.marginBottom = '5px';
                forceGroup.appendChild(distanceLabel);

                const distanceSlider = document.createElement('input');
                distanceSlider.type = 'range';
                distanceSlider.min = '50';
                distanceSlider.max = '200';
                distanceSlider.value = '100';
                distanceSlider.style.width = '100%';
                distanceSlider.addEventListener('input', function() {
                    // 更新连接距离
                    simulation.force("link").distance(parseInt(this.value));
                    simulation.alpha(0.3).restart();
                });
                forceGroup.appendChild(distanceSlider);

                controlPanel.appendChild(forceGroup);

                // 布局模式选择
                const layoutGroup = document.createElement('div');
                layoutGroup.style.marginBottom = '10px';

                const layoutLabel = document.createElement('label');
                layoutLabel.textContent = '布局模式:';
                layoutLabel.style.display = 'block';
                layoutLabel.style.marginBottom = '5px';
                layoutGroup.appendChild(layoutLabel);

                // 创建布局选择下拉菜单
                const layoutSelect = document.createElement('select');
                layoutSelect.style.width = '100%';
                layoutSelect.style.padding = '3px';
                layoutSelect.style.borderRadius = '4px';
                layoutSelect.style.border = '1px solid #ddd';
                layoutSelect.style.backgroundColor = 'white';

                // 添加布局选项
                const layouts = [
                    { value: 'force', text: '自由力导向' },
                    { value: 'circular', text: '环形布局' },
                    { value: 'radial', text: '辐射状布局' },
                    { value: 'grid', text: '网格布局' },
                    { value: 'cluster', text: '按类别聚类' }
                ];

                layouts.forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.value;
                    option.textContent = layout.text;
                    layoutSelect.appendChild(option);
                });

                layoutSelect.addEventListener('change', function() {
                    // 根据选择切换布局
                    applyLayout(this.value);
                });

                layoutGroup.appendChild(layoutSelect);
                controlPanel.appendChild(layoutGroup);

                // 添加布局应用函数
                function applyLayout(layoutType) {
                    // 停止当前模拟
                    simulation.stop();
                    
                    // 根据布局类型重新配置力
                    switch(layoutType) {
                        case 'force':
                            // 重设为默认力导向
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(distanceSlider.value)))
                                .force("charge", d3.forceManyBody().strength(parseInt(forceSlider.value)))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5));
                            break;
                            
                        case 'circular':
                            // 环形布局
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(50))
                                .force("charge", d3.forceManyBody().strength(-100))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                                .force("radial", d3.forceRadial(Math.min(width, height) / 3, width / 2, height / 2).strength(0.8));
                            break;
                            
                        case 'radial':
                            // 辐射状布局
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(30))
                                .force("charge", d3.forceManyBody().strength(-100))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                                .force("r", d3.forceRadial(function(d) {
                                    // 根据节点类型确定径向距离
                                    const categoryIndex = categories.findIndex(c => c.name === d.category);
                                    return 100 + categoryIndex * 50;
                                }, width / 2, height / 2).strength(0.8));
                            break;
                            
                        case 'grid':
                            // 网格布局
                            const gridSize = Math.ceil(Math.sqrt(graphData.nodes.length));
                            const cellSize = Math.min(width, height) / gridSize;
                            
                            // 将节点放置在网格位置
                            graphData.nodes.forEach((node, i) => {
                                const col = i % gridSize;
                                const row = Math.floor(i / gridSize);
                                node.fx = (col + 0.5) * cellSize;
                                node.fy = (row + 0.5) * cellSize;
                            });
                            
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(cellSize).strength(0.1))
                                .force("center", d3.forceCenter(width / 2, height / 2));
                            break;
                            
                        case 'cluster':
                            // 按类别聚类
                            const uniqueCategories = [...new Set(graphData.nodes.map(d => d.category))];
                            const categoryCount = uniqueCategories.length;
                            const angleStep = 2 * Math.PI / categoryCount;
                            const radius = Math.min(width, height) / 3;
                            
                            // 创建类别到位置的映射
                            const categoryPositions = {};
                            uniqueCategories.forEach((category, i) => {
                                const angle = i * angleStep;
                                categoryPositions[category] = {
                                    x: width / 2 + radius * Math.cos(angle),
                                    y: height / 2 + radius * Math.sin(angle)
                                };
                            });
                            
                            // 将节点放置在类别中心附近
                            graphData.nodes.forEach(node => {
                                const pos = categoryPositions[node.category];
                                const offset = 50;
                                node.fx = pos.x + (Math.random() - 0.5) * offset;
                                node.fy = pos.y + (Math.random() - 0.5) * offset;
                            });
                            
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(30).strength(0.1))
                                .force("center", d3.forceCenter(width / 2, height / 2));
                            break;
                    }
                    
                    // 重启模拟
                    simulation.alpha(1).restart();
                    
                    // 如果使用的是网格或聚类布局，5秒后释放固定点
                    if (layoutType === 'grid' || layoutType === 'cluster') {
                        setTimeout(() => {
                            graphData.nodes.forEach(node => {
                                node.fx = null;
                                node.fy = null;
                            });
                            simulation.alpha(0.3).restart();
                        }, 5000);
                    }
                }

                // 添加重置按钮
                const resetLayoutBtn = document.createElement('button');
                resetLayoutBtn.textContent = '重置节点位置';
                resetLayoutBtn.style.width = '100%';
                resetLayoutBtn.style.padding = '5px';
                resetLayoutBtn.style.marginTop = '10px';
                resetLayoutBtn.style.backgroundColor = '#1976d2';
                resetLayoutBtn.style.color = 'white';
                resetLayoutBtn.style.border = 'none';
                resetLayoutBtn.style.borderRadius = '4px';
                resetLayoutBtn.style.cursor = 'pointer';
                resetLayoutBtn.style.transition = 'background-color 0.2s';

                resetLayoutBtn.addEventListener('mouseenter', () => {
                    resetLayoutBtn.style.backgroundColor = '#1565c0';
                });
                resetLayoutBtn.addEventListener('mouseleave', () => {
                    resetLayoutBtn.style.backgroundColor = '#1976d2';
                });

                resetLayoutBtn.addEventListener('click', () => {
                    // 解除所有固定位置并重启模拟
                    graphData.nodes.forEach(node => {
                        node.fx = null;
                        node.fy = null;
                    });
                    
                    // 重设为默认力导向设置
                    forceSlider.value = '-300';
                    distanceSlider.value = '100';
                    layoutSelect.value = 'force';
                    
                    // 重启模拟
                    applyLayout('force');
                    
                    // 重置缩放和平移
                    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
                });

                controlPanel.appendChild(resetLayoutBtn);

                // 添加控制面板到图谱容器
                graphContainer.appendChild(controlPanel);
            }
            
            // 渲染路线信息
            function renderRouteInfo(routes) {
                // 检查路线数据
                if (!routes || routes.length === 0) {
                    return;
                }
                
                // 移除现有的路线信息面板（如果存在）
                const existingPanel = document.querySelector('.route-info-panel');
                if (existingPanel) {
                    existingPanel.remove();
                }
                
                // 创建路线信息面板
                const routeInfoPanel = document.createElement('div');
                routeInfoPanel.className = 'route-info-panel';
                routeInfoPanel.style.position = 'absolute';
                routeInfoPanel.style.top = '10px';
                routeInfoPanel.style.left = '10px';
                routeInfoPanel.style.background = 'rgba(255,255,255,0.9)';
                routeInfoPanel.style.padding = '15px';
                routeInfoPanel.style.borderRadius = '5px';
                routeInfoPanel.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                routeInfoPanel.style.maxWidth = '300px';
                routeInfoPanel.style.maxHeight = '80%';
                routeInfoPanel.style.overflowY = 'auto';
                routeInfoPanel.style.zIndex = '100';
                
                // 添加标题
                const title = document.createElement('h5');
                title.textContent = '推荐路线';
                title.style.marginTop = '0';
                title.style.marginBottom = '10px';
                title.style.color = '#333';
                routeInfoPanel.appendChild(title);
                
                // 添加关闭按钮
                const closeButton = document.createElement('button');
                closeButton.textContent = '×';
                closeButton.style.position = 'absolute';
                closeButton.style.top = '5px';
                closeButton.style.right = '5px';
                closeButton.style.background = 'none';
                closeButton.style.border = 'none';
                closeButton.style.color = '#999';
                closeButton.style.fontSize = '16px';
                closeButton.style.cursor = 'pointer';
                routeInfoPanel.appendChild(closeButton);
                
                closeButton.addEventListener('click', function() {
                    routeInfoPanel.remove();
                });
                
                // 为每条路线创建信息
                routes.forEach((route, index) => {
                    const routeDiv = document.createElement('div');
                    routeDiv.className = 'route-item';
                    routeDiv.style.marginBottom = '15px';
                    routeDiv.style.paddingBottom = '15px';
                    routeDiv.style.borderBottom = index < routes.length - 1 ? '1px solid #eee' : 'none';
                    
                    // 路线名称
                    const routeName = document.createElement('h6');
                    routeName.textContent = `路线 ${index + 1}${route.name ? ': ' + route.name : ''}`;
                    routeName.style.margin = '0 0 8px 0';
                    routeName.style.color = '#444';
                    routeDiv.appendChild(routeName);
                    
                    // 路线详情
                    if (route.description) {
                        const description = document.createElement('p');
                        description.textContent = route.description;
                        description.style.fontSize = '13px';
                        description.style.margin = '0 0 8px 0';
                        description.style.color = '#666';
                        routeDiv.appendChild(description);
                    }
                    
                    // 路线信息
                    const routeInfo = document.createElement('div');
                    routeInfo.style.fontSize = '12px';
                    routeInfo.style.margin = '8px 0';
                    
                    // 总距离
                    if (route.total_distance) {
                        const distance = document.createElement('p');
                        distance.style.margin = '2px 0';
                        distance.innerHTML = `<strong>总距离:</strong> ${route.total_distance}`;
                        routeInfo.appendChild(distance);
                    }
                    
                    // 估计时间
                    if (route.estimated_time) {
                        const time = document.createElement('p');
                        time.style.margin = '2px 0';
                        time.innerHTML = `<strong>估计时间:</strong> ${route.estimated_time}`;
                        routeInfo.appendChild(time);
                    }
                    
                    // 难度级别
                    if (route.difficulty) {
                        const difficulty = document.createElement('p');
                        difficulty.style.margin = '2px 0';
                        difficulty.innerHTML = `<strong>难度级别:</strong> ${route.difficulty}`;
                        routeInfo.appendChild(difficulty);
                    }
                    
                    routeDiv.appendChild(routeInfo);
                    
                    // 路线点列表
                    if (route.points && route.points.length > 0) {
                        const pointsTitle = document.createElement('p');
                        pointsTitle.textContent = '景点顺序:';
                        pointsTitle.style.fontWeight = 'bold';
                        pointsTitle.style.margin = '8px 0 4px 0';
                        pointsTitle.style.fontSize = '12px';
                        routeDiv.appendChild(pointsTitle);
                        
                        const pointsList = document.createElement('ol');
                        pointsList.style.margin = '0';
                        pointsList.style.paddingLeft = '20px';
                        pointsList.style.fontSize = '12px';
                        
                        route.points.forEach(point => {
                            const pointItem = document.createElement('li');
                            pointItem.textContent = point.name;
                            pointItem.style.margin = '2px 0';
                            
                            // 如果有停留时间，添加
                            if (point.time) {
                                const timeSpan = document.createElement('span');
                                timeSpan.textContent = ` (${point.time})`;
                                timeSpan.style.color = '#777';
                                pointItem.appendChild(timeSpan);
                            }
                            
                            pointsList.appendChild(pointItem);
                        });
                        
                        routeDiv.appendChild(pointsList);
                    }
                    
                    routeInfoPanel.appendChild(routeDiv);
                });
                
                // 添加到地图容器
                mapContainer.appendChild(routeInfoPanel);
            }

            // 粒子效果初始化
            function initializeParticles() {
                const particlesContainer = document.createElement('div');
                particlesContainer.className = 'particles';
                document.querySelector('.graph-container').appendChild(particlesContainer);
                
                const particleCount = 40; // 粒子数量
                const colors = ['#1976d2', '#64b5f6', '#bbdefb', '#e3f2fd']; // 粒子颜色
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.position = 'absolute';
                    particle.style.width = Math.random() * 4 + 1 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.borderRadius = '50%';
                    particle.style.opacity = Math.random() * 0.5 + 0.2;
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.left = Math.random() * 100 + '%';
                    
                    // 设置动画
                    const duration = Math.random() * 20 + 10;
                    const delay = Math.random() * 5;
                    
                    particle.style.animation = `float ${duration}s ${delay}s infinite linear`;
                    
                    particlesContainer.appendChild(particle);
                }
                
                // 添加动画关键帧
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes float {
                        0% {
                            transform: translateY(0) translateX(0) rotate(0deg);
                            opacity: 0.2;
                        }
                        25% {
                            transform: translateY(-20px) translateX(10px) rotate(90deg);
                            opacity: 0.5;
                        }
                        50% {
                            transform: translateY(-40px) translateX(0) rotate(180deg);
                            opacity: 0.3;
                        }
                        75% {
                            transform: translateY(-20px) translateX(-10px) rotate(270deg);
                            opacity: 0.5;
                        }
                        100% {
                            transform: translateY(0) translateX(0) rotate(360deg);
                            opacity: 0.2;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // 在图谱初始化完成后调用粒子效果
            setTimeout(initializeParticles, 1000);

            // 增强节点信息卡片效果
            const createInfoCard = (node) => {
                // 移除现有卡片
                d3.selectAll('.node-info-card').remove();
                
                // 创建新卡片
                const card = document.createElement('div');
                card.className = 'node-info-card';
                card.style.position = 'absolute';
                card.style.top = '70px';
                card.style.right = '15px';
                card.style.width = '280px';
                card.style.background = 'rgba(255, 255, 255, 0.95)';
                card.style.borderRadius = '10px';
                card.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.15)';
                card.style.padding = '0';
                card.style.overflow = 'hidden';
                card.style.zIndex = '200';
                card.style.transition = 'all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1)';
                card.style.transform = 'translateY(20px)';
                card.style.opacity = '0';
                card.style.backdropFilter = 'blur(10px)';
                card.style.border = '1px solid rgba(230, 230, 250, 0.7)';
                
                // 创建顶部色带
                const category = categories.find(c => c.name === node.category);
                const color = category ? category.color : '#999';
                
                const colorBand = document.createElement('div');
                colorBand.style.height = '8px';
                colorBand.style.background = color;
                colorBand.style.width = '100%';
                card.appendChild(colorBand);
                
                // 添加内容区域
                const content = document.createElement('div');
                content.style.padding = '15px';
                card.appendChild(content);
                
                // 添加标题
                const title = document.createElement('h4');
                title.textContent = node.name;
                title.style.margin = '0 0 10px 0';
                title.style.color = '#333';
                title.style.fontSize = '18px';
                title.style.fontWeight = 'bold';
                title.style.borderBottom = '2px solid ' + color;
                title.style.paddingBottom = '8px';
                content.appendChild(title);
                
                // 添加类别标签
                const categoryTag = document.createElement('div');
                categoryTag.textContent = node.category;
                categoryTag.style.display = 'inline-block';
                categoryTag.style.padding = '3px 8px';
                categoryTag.style.backgroundColor = color + '22'; // 添加透明度
                categoryTag.style.color = color;
                categoryTag.style.borderRadius = '4px';
                categoryTag.style.fontSize = '12px';
                categoryTag.style.marginBottom = '12px';
                categoryTag.style.border = '1px solid ' + color;
                content.appendChild(categoryTag);
                
                // 添加描述
                if (node.description) {
                    const desc = document.createElement('p');
                    desc.textContent = node.description;
                    desc.style.margin = '10px 0';
                    desc.style.fontSize = '14px';
                    desc.style.lineHeight = '1.5';
                    desc.style.color = '#555';
                    content.appendChild(desc);
                }
                
                // 创建表格展示详细信息
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.marginTop = '15px';
                table.style.fontSize = '13px';
                
                // 添加评分
                if (node.rating) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = '评分';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    cell1.style.width = '30%';
                    
                    // 创建星级评分
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                    
                    const stars = document.createElement('div');
                    stars.style.display = 'flex';
                    stars.style.alignItems = 'center';
                    
                    // 添加实心星星
                    const fullStars = Math.floor(node.rating);
                    for (let i = 0; i < fullStars; i++) {
                        const star = document.createElement('i');
                        star.className = 'bi bi-star-fill';
                        star.style.color = '#FFC107';
                        star.style.marginRight = '2px';
                        star.style.fontSize = '14px';
                        stars.appendChild(star);
                    }
                    
                    // 添加半星（如果有）
                    if (node.rating % 1 >= 0.5) {
                        const halfStar = document.createElement('i');
                        halfStar.className = 'bi bi-star-half';
                        halfStar.style.color = '#FFC107';
                        halfStar.style.marginRight = '2px';
                        halfStar.style.fontSize = '14px';
                        stars.appendChild(halfStar);
                    }
                    
                    // 添加空星
                    const remainingStars = 5 - Math.ceil(node.rating);
                    for (let i = 0; i < remainingStars; i++) {
                        const emptyStar = document.createElement('i');
                        emptyStar.className = 'bi bi-star';
                        emptyStar.style.color = '#FFC107';
                        emptyStar.style.marginRight = '2px';
                        emptyStar.style.fontSize = '14px';
                        stars.appendChild(emptyStar);
                    }
                    
                    // 添加数字评分
                    const ratingText = document.createElement('span');
                    ratingText.textContent = ` ${node.rating.toFixed(1)}`;
                    ratingText.style.marginLeft = '5px';
                    ratingText.style.color = '#666';
                    stars.appendChild(ratingText);
                    
                    cell2.appendChild(stars);
                }
                
                // 添加价格信息
                if (node.properties && node.properties.price !== undefined) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = '价格';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    
                    // 更直观的价格展示
                    const price = node.properties.price;
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                    
                    if (price === 0) {
                        cell2.textContent = '免费';
                        cell2.style.color = '#4CAF50';
                    } else {
                        cell2.textContent = `¥${price}`;
                        cell2.style.color = price > 100 ? '#F44336' : price > 50 ? '#FF9800' : '#4CAF50';
                    }
                }
                
                // 添加游览时间
                if (node.properties && node.properties.visit_time !== undefined) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = '游览时间';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    
                    // 格式化时间展示
                    const minutes = node.properties.visit_time;
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    
                    let timeText = '';
                    if (hours > 0) {
                        timeText += `${hours}小时`;
                    }
                    if (remainingMinutes > 0 || hours === 0) {
                        timeText += `${remainingMinutes}分钟`;
                    }
                    
                    cell2.textContent = timeText;
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                }
                
                content.appendChild(table);
                
                // 添加连接展示
                if (graphData.links.some(link => link.source.id === node.id || link.target.id === node.id)) {
                    const connectionsTitle = document.createElement('h5');
                    connectionsTitle.textContent = '相关景点';
                    connectionsTitle.style.margin = '15px 0 10px 0';
                    connectionsTitle.style.fontSize = '14px';
                    connectionsTitle.style.color = '#333';
                    content.appendChild(connectionsTitle);
                    
                    const connections = document.createElement('div');
                    connections.style.display = 'flex';
                    connections.style.flexWrap = 'wrap';
                    connections.style.gap = '5px';
                    
                    // 查找关联节点
                    const relatedNodes = new Set();
                    graphData.links.forEach(link => {
                        if (link.source.id === node.id) {
                            relatedNodes.add(link.target.id);
                        } else if (link.target.id === node.id) {
                            relatedNodes.add(link.source.id);
                        }
                    });
                    
                    // 为每个关联节点创建一个标签
                    graphData.nodes.forEach(relatedNode => {
                        if (relatedNodes.has(relatedNode.id)) {
                            const tag = document.createElement('span');
                            tag.textContent = relatedNode.name;
                            tag.style.display = 'inline-block';
                            tag.style.padding = '2px 8px';
                            tag.style.backgroundColor = '#f5f5f5';
                            tag.style.color = '#333';
                            tag.style.borderRadius = '15px';
                            tag.style.fontSize = '12px';
                            tag.style.border = '1px solid #ddd';
                            tag.style.cursor = 'pointer';
                            tag.style.transition = 'all 0.2s ease';
                            
                            // 悬停效果
                            tag.addEventListener('mouseenter', () => {
                                tag.style.backgroundColor = '#e0e0e0';
                                tag.style.transform = 'translateY(-2px)';
                                tag.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                            });
                            
                            tag.addEventListener('mouseleave', () => {
                                tag.style.backgroundColor = '#f5f5f5';
                                tag.style.transform = 'translateY(0)';
                                tag.style.boxShadow = 'none';
                            });
                            
                            // 点击切换到该节点
                            tag.addEventListener('click', () => {
                                // 移除当前卡片
                                card.remove();
                                
                                // 查找并高亮新节点
                                const targetNode = nodeGroups.filter(d => d.id === relatedNode.id).node();
                                if (targetNode) {
                                    // 触发点击事件
                                    d3.select(targetNode).dispatch('click');
                                }
                            });
                            
                            connections.appendChild(tag);
                        }
                    });
                    
                    content.appendChild(connections);
                }
                
                // 添加底部按钮区域
                const buttonArea = document.createElement('div');
                buttonArea.style.padding = '10px 15px 15px';
                buttonArea.style.display = 'flex';
                buttonArea.style.justifyContent = 'flex-end';
                buttonArea.style.gap = '10px';
                
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.textContent = '关闭';
                closeBtn.style.padding = '5px 12px';
                closeBtn.style.border = '1px solid #ddd';
                closeBtn.style.borderRadius = '4px';
                closeBtn.style.backgroundColor = '#f5f5f5';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.fontSize = '12px';
                closeBtn.style.transition = 'all 0.2s ease';
                
                closeBtn.addEventListener('mouseenter', () => {
                    closeBtn.style.backgroundColor = '#e0e0e0';
                });
                
                closeBtn.addEventListener('mouseleave', () => {
                    closeBtn.style.backgroundColor = '#f5f5f5';
                });
                
                closeBtn.addEventListener('click', () => {
                    card.style.transform = 'translateY(20px)';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                });
                
                buttonArea.appendChild(closeBtn);
                card.appendChild(buttonArea);
                
                // 添加到图谱容器
                graphContainer.appendChild(card);
                
                // 触发动画
                setTimeout(() => {
                    card.style.transform = 'translateY(0)';
                    card.style.opacity = '1';
                }, 10);
                
                return card;
            };

            // 添加连接高亮功能
            const highlightConnections = (node) => {
                // 重置所有连线样式
                links.style("stroke", d => {
                    if (d.inRoute) return "#ff5722";
                    return "rgba(255, 255, 255, 0.2)";
                }).style("stroke-width", d => {
                    if (d.inRoute) return 2.5;
                    return 1;
                }).style("opacity", 0.6)
                .style("filter", "none");
                
                // 高亮当前节点的连线
                links.filter(d => d.source.id === node.id || d.target.id === node.id)
                    .style("stroke", "#ffeb3b")
                    .style("stroke-width", 2.5)
                    .style("opacity", 1)
                    .style("filter", "url(#glow)");
                
                // 高亮相关节点
                graphData.links.forEach(link => {
                    if (link.source.id === node.id) {
                        // 目标节点添加highlighted属性
                        const targetNode = graphData.nodes.find(n => n.id === link.target.id);
                        if (targetNode) {
                            targetNode.highlighted = true;
                        }
                    } else if (link.target.id === node.id) {
                        // 源节点添加highlighted属性
                        const sourceNode = graphData.nodes.find(n => n.id === link.source.id);
                        if (sourceNode) {
                            sourceNode.highlighted = true;
                        }
                    }
                });
                
                // 更新所有节点的视觉样式
                circles.style("stroke", d => {
                    if (d.id === node.id) return "#ff5722";
                    if (d.inRoute) return "#ff5722";
                    return d.highlighted ? "#ffeb3b" : "rgba(255,255,255,0.8)";
                }).style("stroke-width", d => {
                    if (d.id === node.id) return 3;
                    if (d.inRoute) return 3;
                    return d.highlighted ? 2.5 : 1.5;
                }).style("filter", d => {
                    if (d.id === node.id) return "url(#strongGlow)";
                    if (d.highlighted) return "url(#glow)";
                    return "none";
                });
            };

            // 点击空白区域取消高亮
            svg.on("click", (event) => {
                if (event.target === svg.node() || event.target.tagName === "rect") {
                    // 重置所有节点的highlighted属性
                    graphData.nodes.forEach(node => {
                        node.highlighted = false;
                    });
                    
                    // 重置所有节点样式
                    circles.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return "rgba(255,255,255,0.8)";
                    }).style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return 1.5;
                    }).style("filter", d => {
                        if (d.inRoute) return "url(#glow)";
                        return "none";
                    });
                    
                    // 重置所有连线样式
                    links.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return "rgba(255, 255, 255, 0.2)";
                    }).style("stroke-width", d => {
                        if (d.inRoute) return 2.5;
                        return 1;
                    }).style("opacity", 0.6)
                    .style("filter", "none");
                    
                    // 移除详细信息卡片
                    d3.selectAll('.node-info-card').style("transform", "translateY(20px)")
                        .style("opacity", "0");
                    setTimeout(() => d3.selectAll('.node-info-card').remove(), 300);
                    
                    // 隐藏提示框
                    tooltip.style("visibility", "hidden")
                        .style("opacity", 0);
                }
            });

            // 辅助函数：安全的色彩混合计算
            function pSBC(p, c0, c1, l) {
                let r, g, b, P, f, t, h, i=parseInt, m=Math.round, a=typeof(c1)=="string";
                if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
                if(!this.pSBCr)this.pSBCr=(d)=>{
                    let n=d.length,x={};
                    if(n>9){
                        [r,g,b,a]=d.match(/\d+/g).map(v=>Number(v));
                        return r>255||g>255||b>255||isNaN(r)||isNaN(g)||isNaN(b)?null:[r,g,b,a/255];
                    }else{
                        if(n==8||n==6||n<4)return null;
                        if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
                        d=i(d.slice(1),16);
                        if(n==9||n==5)return[d>>24&255,d>>16&255,d>>8&255,(d&255)/0.255];
                        return[d>>16,d>>8&255,d&255,1];
                    }
                };
                h=c0.length>9;
                h=a?c1.length>9?true:c1=="c"?!h:false:h;
                f=this.pSBCr(c0);P=p<0;t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1};
                p=P?p*-1:p;P=1-p;
                if(!f||!t)return null;
                if(l)r=m(P*f[0]+p*t[0]),g=m(P*f[1]+p*t[1]),b=m(P*f[2]+p*t[2]);
                else r=m((P*f[0]**2+p*t[0]**2)**0.5),g=m((P*f[1]**2+p*t[1]**2)**0.5),b=m((P*f[2]**2+p*t[2]**2)**0.5);
                a=f[3]*P+t[3]*p;a=a<0?0:a>1?1:a;
                return"rgb"+(a<1?"a(":"(")+r+","+g+","+b+(a<1?","+a:"")+")"
            }

            // 添加一个力导向图控制面板
            const createForceControls = () => {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'graph-controls';
                controlsDiv.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    color: white;
                    font-size: 14px;
                    z-index: 1000;
                    width: 230px;
                    transition: all 0.3s ease;
                `;
                
                // 添加标题
                const title = document.createElement('div');
                title.style.cssText = `
                    font-weight: bold;
                    margin-bottom: 15px;
                    font-size: 16px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                title.innerHTML = '<span>力导向图控制面板</span>';
                
                // 添加最小化按钮
                const minimizeBtn = document.createElement('button');
                minimizeBtn.innerHTML = '−';
                minimizeBtn.style.cssText = `
                    background: none;
                    border: none;
                    color: white;
                    font-size: 16px;
                    cursor: pointer;
                    padding: 0 5px;
                `;
                title.appendChild(minimizeBtn);
                
                // 创建内容容器
                const contentDiv = document.createElement('div');
                contentDiv.className = 'controls-content';
                contentDiv.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                
                // 节点排斥力控制
                const chargeDiv = document.createElement('div');
                chargeDiv.className = 'control-group';
                chargeDiv.style.cssText = `margin-bottom: 15px;`;
                
                const chargeLabel = document.createElement('label');
                chargeLabel.innerHTML = '节点排斥力: <span class="value">-200</span>';
                
                const chargeSlider = document.createElement('input');
                chargeSlider.type = 'range';
                chargeSlider.min = '-500';
                chargeSlider.max = '-50';
                chargeSlider.value = '-200';
                chargeSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                // 添加自定义样式
                const sliderStyle = document.createElement('style');
                sliderStyle.textContent = `
                    input[type=range]::-webkit-slider-thumb {
                        -webkit-appearance: none;
                        appearance: none;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #4CAF50;
                        cursor: pointer;
                        box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    }
                    input[type=range]::-moz-range-thumb {
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #4CAF50;
                        cursor: pointer;
                        box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    }
                `;
                document.head.appendChild(sliderStyle);
                
                chargeDiv.appendChild(chargeLabel);
                chargeDiv.appendChild(chargeSlider);
                
                // 连接距离控制
                const linkDistDiv = document.createElement('div');
                linkDistDiv.className = 'control-group';
                linkDistDiv.style.cssText = `margin-bottom: 15px;`;
                
                const linkLabel = document.createElement('label');
                linkLabel.innerHTML = '连接距离: <span class="value">50</span>';
                
                const linkSlider = document.createElement('input');
                linkSlider.type = 'range';
                linkSlider.min = '10';
                linkSlider.max = '200';
                linkSlider.value = '50';
                linkSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                linkDistDiv.appendChild(linkLabel);
                linkDistDiv.appendChild(linkSlider);
                
                // 力强度控制
                const strengthDiv = document.createElement('div');
                strengthDiv.className = 'control-group';
                strengthDiv.style.cssText = `margin-bottom: 15px;`;
                
                const strengthLabel = document.createElement('label');
                strengthLabel.innerHTML = '力强度: <span class="value">0.5</span>';
                
                const strengthSlider = document.createElement('input');
                strengthSlider.type = 'range';
                strengthSlider.min = '0.1';
                strengthSlider.max = '1';
                strengthSlider.value = '0.5';
                strengthSlider.step = '0.1';
                strengthSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                strengthDiv.appendChild(strengthLabel);
                strengthDiv.appendChild(strengthSlider);
                
                // 布局类型选择
                const layoutDiv = document.createElement('div');
                layoutDiv.className = 'control-group';
                
                const layoutLabel = document.createElement('label');
                layoutLabel.innerHTML = '布局类型:';
                layoutLabel.style.display = 'block';
                layoutLabel.style.marginBottom = '8px';
                
                const layoutSelect = document.createElement('select');
                layoutSelect.style.cssText = `
                    width: 100%;
                    padding: 5px 8px;
                    background: #333;
                    color: white;
                    border: 1px solid #555;
                    border-radius: 4px;
                    outline: none;
                `;
                
                const layouts = [
                    { value: 'force', label: '力导向图' },
                    { value: 'circular', label: '环形布局' },
                    { value: 'radial', label: '放射状布局' },
                    { value: 'grid', label: '网格布局' }
                ];
                
                layouts.forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.value;
                    option.textContent = layout.label;
                    layoutSelect.appendChild(option);
                });
                
                layoutDiv.appendChild(layoutLabel);
                layoutDiv.appendChild(layoutSelect);
                
                // 添加事件处理
                chargeSlider.addEventListener('input', function() {
                    const value = this.value;
                    chargeLabel.querySelector('.value').textContent = value;
                    simulation.force('charge').strength(parseInt(value));
                    simulation.alpha(1).restart();
                });
                
                linkSlider.addEventListener('input', function() {
                    const value = this.value;
                    linkLabel.querySelector('.value').textContent = value;
                    simulation.force('link').distance(parseInt(value));
                    simulation.alpha(1).restart();
                });
                
                strengthSlider.addEventListener('input', function() {
                    const value = this.value;
                    strengthLabel.querySelector('.value').textContent = value;
                    simulation.velocityDecay(1 - parseFloat(value));
                    simulation.alpha(1).restart();
                });
                
                layoutSelect.addEventListener('change', function() {
                    const value = this.value;
                    
                    // 停止当前模拟
                    simulation.stop();
                    
                    // 根据选择的布局类型重新配置力
                    switch(value) {
                        case 'force':
                            // 标准力导向图
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value)))
                                .force('center', d3.forceCenter(width / 2, height / 2));
                            break;
                        case 'circular':
                            // 环形布局
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 3))
                                .force('r', d3.forceRadial(Math.min(width, height) / 3, width / 2, height / 2));
                            break;
                        case 'radial':
                            // 放射状布局（根据类别）
                            const categories = [...new Set(graphData.nodes.map(d => d.category))];
                            const angleStep = (2 * Math.PI) / categories.length;
                            
                            // 为每个类别分配一个角度
                            const categoryAngles = {};
                            categories.forEach((cat, i) => {
                                categoryAngles[cat] = i * angleStep;
                            });
                            
                            // 创建径向力，基于节点类别
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 2))
                                .force('r', d3.forceRadial(d => {
                                    // 内部节点靠近中心，外部节点靠近边缘
                                    return d.degree > 3 ? Math.min(width, height) / 4 : Math.min(width, height) / 2.5;
                                }, width / 2, height / 2))
                                .force('angle', alpha => {
                                    const centerX = width / 2;
                                    const centerY = height / 2;
                                    const strength = 0.1;
                                    
                                    graphData.nodes.forEach(node => {
                                        if (!node.category) return;
                                        
                                        // 计算节点应该的角度
                                        const targetAngle = categoryAngles[node.category];
                                        const radius = Math.sqrt(Math.pow(node.x - centerX, 2) + Math.pow(node.y - centerY, 2));
                                        
                                        // 目标位置
                                        const targetX = centerX + radius * Math.cos(targetAngle);
                                        const targetY = centerY + radius * Math.sin(targetAngle);
                                        
                                        // 向目标位置移动
                                        node.vx += (targetX - node.x) * strength * alpha;
                                        node.vy += (targetY - node.y) * strength * alpha;
                                    });
                                });
                            break;
                        case 'grid':
                            // 网格布局
                            const gridSize = Math.ceil(Math.sqrt(graphData.nodes.length));
                            const cellWidth = width / gridSize;
                            const cellHeight = height / gridSize;
                            
                            // 为每个节点分配网格位置
                            graphData.nodes.forEach((node, i) => {
                                const row = Math.floor(i / gridSize);
                                const col = i % gridSize;
                                node.fx = col * cellWidth + cellWidth / 2;
                                node.fy = row * cellHeight + cellHeight / 2;
                            });
                            
                            // 较弱的力以允许有些自由移动
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 5));
                            
                            // 2秒后释放固定位置
                            setTimeout(() => {
                                graphData.nodes.forEach(node => {
                                    node.fx = null;
                                    node.fy = null;
                                });
                            }, 2000);
                            break;
                    }
                    
                    // 重启模拟
                    simulation.alpha(1).restart();
                });
                
                // 最小化/最大化功能
                minimizeBtn.addEventListener('click', function() {
                    if (contentDiv.style.maxHeight) {
                        // 展开面板
                        contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                        contentDiv.style.opacity = "1";
                        minimizeBtn.innerHTML = '−';
                        setTimeout(() => {
                            contentDiv.style.maxHeight = null; // 允许自动高度
                        }, 300);
                    } else {
                        // 折叠面板
                        contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                        setTimeout(() => {
                            contentDiv.style.maxHeight = "0px";
                            contentDiv.style.opacity = "0";
                            minimizeBtn.innerHTML = '+';
                        }, 10);
                    }
                });
                
                // 添加所有控件
                contentDiv.appendChild(chargeDiv);
                contentDiv.appendChild(linkDistDiv);
                contentDiv.appendChild(strengthDiv);
                contentDiv.appendChild(layoutDiv);
                
                controlsDiv.appendChild(title);
                controlsDiv.appendChild(contentDiv);
                
                // 添加到地图容器
                document.querySelector('.map-container').appendChild(controlsDiv);
                
                // 在窗口调整大小时重新布局
                window.addEventListener('resize', () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    simulation.force('center', d3.forceCenter(width / 2, height / 2));
                    simulation.alpha(1).restart();
                });
            };

            // 在渲染图完成后调用创建控制面板
            const originalRenderGraph = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraph(data);
                createForceControls();
                return result;
            };

            // 添加搜索功能
            const createSearchFunction = () => {
                const searchContainer = document.createElement('div');
                searchContainer.className = 'search-container';
                searchContainer.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    z-index: 1000;
                    width: 250px;
                    transition: all 0.3s ease;
                `;
                
                // 搜索输入框
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = '搜索节点...';
                searchInput.style.cssText = `
                    width: 100%;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 30px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    color: white;
                    font-size: 14px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                    outline: none;
                    transition: all 0.3s ease;
                `;
                
                // 搜索结果容器
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'search-results';
                resultsContainer.style.cssText = `
                    margin-top: 10px;
                    max-height: 0;
                    overflow-y: auto;
                    background: rgba(30, 30, 50, 0.9);
                    backdrop-filter: blur(5px);
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    opacity: 0;
                    transition: all 0.3s ease;
                `;
                
                // 添加到DOM
                searchContainer.appendChild(searchInput);
                searchContainer.appendChild(resultsContainer);
                document.querySelector('.map-container').appendChild(searchContainer);
                
                // 搜索功能
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase().trim();
                    
                    // 清空结果容器
                    resultsContainer.innerHTML = '';
                    
                    if (query.length < 2) {
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                        return;
                    }
                    
                    // 查找匹配的节点
                    const matchedNodes = graphData.nodes.filter(node => 
                        node.name.toLowerCase().includes(query) || 
                        (node.description && node.description.toLowerCase().includes(query))
                    );
                    
                    if (matchedNodes.length === 0) {
                        resultsContainer.innerHTML = '<div class="no-results" style="padding: 10px 15px; color: #ccc;">没有找到匹配的节点</div>';
                    } else {
                        // 创建结果列表
                        matchedNodes.slice(0, 10).forEach(node => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item';
                            resultItem.style.cssText = `
                                padding: 10px 15px;
                                cursor: pointer;
                                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                                transition: background 0.2s;
                            `;
                            
                            // 添加分类颜色标记
                            const categoryColor = getCategoryColor(node.category);
                            resultItem.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${categoryColor}; margin-right: 10px;"></div>
                                    <div>
                                        <div style="font-weight: bold;">${node.name}</div>
                                        ${node.description ? `<div style="font-size: 12px; color: #ccc; margin-top: 3px;">${node.description.substring(0, 60)}${node.description.length > 60 ? '...' : ''}</div>` : ''}
                                    </div>
                                </div>
                            `;
                            
                            // 鼠标悬停效果
                            resultItem.addEventListener('mouseover', () => {
                                resultItem.style.background = 'rgba(255, 255, 255, 0.1)';
                            });
                            
                            resultItem.addEventListener('mouseout', () => {
                                resultItem.style.background = 'transparent';
                            });
                            
                            // 点击跳转到节点
                            resultItem.addEventListener('click', () => {
                                // 找到相应的节点DOM元素
                                const nodeElement = d3.select(`circle[data-id="${node.id}"]`);
                                if (!nodeElement.empty()) {
                                    // 清除之前的高亮
                                    d3.selectAll('.node circle').classed('highlighted', false);
                                    
                                    // 高亮当前节点
                                    nodeElement.classed('highlighted', true);
                                    
                                    // 计算缩放并居中
                                    const currentScale = d3.zoomTransform(svg.node()).k;
                                    const targetX = node.x * currentScale;
                                    const targetY = node.y * currentScale;
                                    
                                    // 平滑过渡到目标位置
                                    svg.transition()
                                        .duration(750)
                                        .call(
                                            zoom.transform,
                                            d3.zoomIdentity
                                                .translate(width / 2 - targetX, height / 2 - targetY)
                                                .scale(currentScale * 1.5) // 稍微放大
                                        );
                                        
                                    // 显示节点信息
                                    showNodeInfo(node);
                                    
                                    // 添加动画效果，突出显示找到的节点
                                    const pulseCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                    pulseCircle.setAttribute('cx', node.x);
                                    pulseCircle.setAttribute('cy', node.y);
                                    pulseCircle.setAttribute('r', 20);
                                    pulseCircle.setAttribute('fill', 'none');
                                    pulseCircle.setAttribute('stroke', '#fff');
                                    pulseCircle.setAttribute('stroke-width', '3');
                                    pulseCircle.setAttribute('opacity', '1');
                                    
                                    // 添加到SVG
                                    svg.node().appendChild(pulseCircle);
                                    
                                    // 动画效果
                                    d3.select(pulseCircle)
                                        .transition()
                                        .duration(1000)
                                        .attr('r', 40)
                                        .attr('opacity', 0)
                                        .remove();
                                        
                                    // 清空搜索框
                                    searchInput.value = '';
                                    resultsContainer.style.maxHeight = '0';
                                    resultsContainer.style.opacity = '0';
                                }
                            });
                            
                            resultsContainer.appendChild(resultItem);
                        });
                    }
                    
                    // 显示结果
                    resultsContainer.style.maxHeight = '300px';
                    resultsContainer.style.opacity = '1';
                });
                
                // 点击外部时隐藏结果
                document.addEventListener('click', function(e) {
                    if (!searchContainer.contains(e.target)) {
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                    }
                });
                
                // 按ESC键清空搜索
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                    }
                });
                
                // 焦点样式
                searchInput.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 2px rgba(77, 144, 254, 0.5), 0 4px 15px rgba(0, 0, 0, 0.2)';
                });
                
                searchInput.addEventListener('blur', function() {
                    this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                });
            };

            // 在渲染图完成后调用创建搜索功能
            const originalRenderGraphWithControls = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraphWithControls(data);
                createSearchFunction();
                return result;
            };

            // 添加导出图片功能
            const createExportButton = () => {
                const exportButton = document.createElement('button');
                exportButton.className = 'export-button';
                exportButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    导出图片
                `;
                exportButton.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 30px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    color: white;
                    font-size: 14px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                // 悬停效果
                exportButton.addEventListener('mouseover', () => {
                    exportButton.style.background = 'rgba(40, 40, 70, 0.9)';
                    exportButton.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)';
                });
                
                exportButton.addEventListener('mouseout', () => {
                    exportButton.style.background = 'rgba(30, 30, 50, 0.8)';
                    exportButton.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                });
                
                // 点击导出图片
                exportButton.addEventListener('click', () => {
                    // 创建加载提示
                    const loadingToast = document.createElement('div');
                    loadingToast.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                        z-index: 2000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    `;
                    
                    const spinner = document.createElement('div');
                    spinner.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                        border-radius: 50%;
                        border-top-color: white;
                        animation: spin 1s linear infinite;
                    `;
                    
                    const loadingText = document.createElement('div');
                    loadingText.textContent = '正在准备图片...';
                    
                    loadingToast.appendChild(spinner);
                    loadingToast.appendChild(loadingText);
                    document.body.appendChild(loadingToast);
                    
                    // 添加spinner动画
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                    
                    // 使用html2canvas库导出SVG为图片
                    setTimeout(() => {
                        // 使用svg-crowbar技术导出SVG
                        const svgElement = document.querySelector('svg');
                        const svgData = new XMLSerializer().serializeToString(svgElement);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // 设置画布大小为SVG大小
                        const svgRect = svgElement.getBoundingClientRect();
                        canvas.width = svgRect.width;
                        canvas.height = svgRect.height;
                        
                        // 创建图像
                        const img = new Image();
                        img.onload = function() {
                            // 填充背景
                            ctx.fillStyle = '#121220';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // 绘制SVG
                            ctx.drawImage(img, 0, 0);
                            
                            // 转换为Data URL并下载
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            // 创建下载链接
                            const downloadLink = document.createElement('a');
                            downloadLink.href = dataUrl;
                            downloadLink.download = '知识图谱_' + new Date().toISOString().slice(0, 10) + '.png';
                            
                            // 移除加载提示
                            document.body.removeChild(loadingToast);
                            
                            // 模拟点击下载
                            downloadLink.click();
                        };
                        
                        // SVG数据转换为Base64
                        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                        const url = URL.createObjectURL(svgBlob);
                        img.src = url;
                    }, 500);
                });
                
                document.querySelector('.map-container').appendChild(exportButton);
            };

            // 修改renderGraph函数调用来添加导出按钮
            const originalRenderGraphWithExport = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraphWithExport(data);
                createExportButton();
                return result;
            };

            // 旅行建议卡片函数
            function createTravelSuggestionCard(suggestion) {
                const card = document.createElement('div');
                card.className = 'travel-suggestion-card';
                
                const title = document.createElement('div');
                title.className = 'travel-suggestion-title';
                title.innerHTML = '<i class="bi bi-map"></i>旅行建议';
                card.appendChild(title);
                
                // 如果有兴趣点
                if (suggestion.pois && suggestion.pois.length > 0) {
                    const poiTitle = document.createElement('div');
                    poiTitle.textContent = '推荐景点:';
                    poiTitle.style.fontWeight = '600';
                    poiTitle.style.marginTop = '0.8rem';
                    card.appendChild(poiTitle);
                    
                    const poiList = document.createElement('ul');
                    poiList.className = 'poi-list';
                    
                    suggestion.pois.forEach(poi => {
                        const poiItem = document.createElement('li');
                        poiItem.className = 'poi-item';
                        
                        const poiIcon = document.createElement('div');
                        poiIcon.className = 'poi-icon';
                        poiIcon.style.backgroundColor = getCategoryColor(poi.category);
                        poiIcon.textContent = poi.category.charAt(0);
                        
                        const poiInfo = document.createElement('div');
                        poiInfo.className = 'poi-info';
                        
                        const poiName = document.createElement('div');
                        poiName.className = 'poi-name';
                        poiName.textContent = poi.name;
                        
                        const poiDesc = document.createElement('div');
                        poiDesc.className = 'poi-desc';
                        poiDesc.textContent = poi.description || '';
                        
                        poiInfo.appendChild(poiName);
                        poiInfo.appendChild(poiDesc);
                        poiItem.appendChild(poiIcon);
                        poiItem.appendChild(poiInfo);
                        poiList.appendChild(poiItem);
                    });
                    
                    card.appendChild(poiList);
                }
                
                // 如果有旅行提示
                if (suggestion.tips && suggestion.tips.length > 0) {
                    const tipsContainer = document.createElement('div');
                    tipsContainer.className = 'travel-tips';
                    
                    const tipsTitle = document.createElement('div');
                    tipsTitle.className = 'travel-tips-title';
                    tipsTitle.innerHTML = '<i class="bi bi-lightbulb"></i>旅行贴士';
                    tipsContainer.appendChild(tipsTitle);
                    
                    const tipsList = document.createElement('ul');
                    tipsList.style.paddingLeft = '1.5rem';
                    tipsList.style.marginTop = '0.5rem';
                    
                    suggestion.tips.forEach(tip => {
                        const tipItem = document.createElement('li');
                        tipItem.textContent = tip;
                        tipsList.appendChild(tipItem);
                    });
                    
                    tipsContainer.appendChild(tipsList);
                    card.appendChild(tipsContainer);
                }
                
                return card;
            }

            // 根据分类获取颜色
            function getCategoryColor(category) {
                const colors = {
                    '自然景观': '#2c7bb6',
                    '历史古迹': '#d7191c',
                    '文化场所': '#fdae61',
                    '购物区域': '#abd9e9',
                    '美食街区': '#66bd63'
                };
                
                return colors[category] || '#888888';
            }

            // 获取目的地天气信息并显示
            function getDestinationWeather(location) {
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) {
                    console.error("无法找到responseElement元素");
                    return;
                }
                
                console.log("开始获取天气信息: " + location);
                
                // 直接添加一个加载指示器，确认函数被调用
                const weatherLoadingHTML = `
                <div class="weather-loading mt-3 mb-3 p-3 text-center" style="background-color: #f8f9fa; border-radius: 8px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">加载天气数据...</span>
                    </div>
                    <p class="mt-2">正在加载 ${location} 的天气数据...</p>
                </div>`;
                
                // 先添加加载指示器
                if (responseElement.innerHTML.indexOf('travel-suggestion-card') > -1) {
                    responseElement.innerHTML = responseElement.innerHTML.replace(
                        '<div class="travel-suggestion-card mt-4">',
                        weatherLoadingHTML + '<div class="travel-suggestion-card mt-4">'
                    );
                } else {
                    responseElement.innerHTML += weatherLoadingHTML;
                }
                
                // 调用后端天气API
                const weatherApiUrl = `/api/weather?location=${encodeURIComponent(location)}`;
                console.log("天气API URL: " + weatherApiUrl);
                
                fetch(weatherApiUrl)
                    .then(response => {
                        console.log("天气API响应状态: ", response.status);
                        if (!response.ok) {
                            throw new Error(`天气API错误: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(weatherData => {
                        console.log("获取到天气数据:", weatherData);
                        
                        // 移除加载指示器
                        const weatherLoading = responseElement.querySelector('.weather-loading');
                        if (weatherLoading) {
                            weatherLoading.remove();
                        }
                        
                        // 添加天气信息到响应中
                        const weatherHTML = createWeatherWidget(weatherData);
                        
                        // 添加天气信息到当前响应中
                        if (responseElement.innerHTML.indexOf('travel-suggestion-card') > -1) {
                            // 在路线推荐前插入天气信息
                            responseElement.innerHTML = responseElement.innerHTML.replace(
                                '<div class="travel-suggestion-card mt-4">',
                                weatherHTML + '<div class="travel-suggestion-card mt-4">'
                            );
                            
                            // 为了在DeepSeek助手回答中加入天气相关建议
                            // 保存天气数据到全局变量，供其他函数使用
                            window.lastWeatherData = weatherData;
                            
                            // 提取当前路线数据用于更新推荐
                            try {
                                // 寻找所有路线信息
                                const dayRoutes = Array.from(responseElement.querySelectorAll('.day-route')).map(dayEl => {
                                    return Array.from(dayEl.querySelectorAll('.poi-item')).map(poiEl => {
                                        const nameEl = poiEl.querySelector('.poi-name');
                                        const descEl = poiEl.querySelector('.poi-desc');
                                        return {
                                            name: nameEl?.textContent || '',
                                            description: descEl?.textContent || '',
                                            // 尝试判断是否为室内景点
                                            indoor: nameEl?.textContent.includes('博物馆') || 
                                                    nameEl?.textContent.includes('美术馆') || 
                                                    nameEl?.textContent.includes('展览馆')
                                        };
                                    });
                                });
                                
                                if (dayRoutes.length > 0) {
                                    // 更新路线推荐，基于天气情况
                                    updateRouteRecommendation(weatherData, dayRoutes, location);
                                }
                            } catch (e) {
                                console.error("解析路线数据失败:", e);
                            }
                        } else {
                            // 直接添加到响应末尾
                            responseElement.innerHTML += weatherHTML;
                        }
                    })
                    .catch(error => {
                        console.error("获取天气信息失败:", error);
                        
                        // 移除加载指示器并显示错误消息
                        const weatherLoading = responseElement.querySelector('.weather-loading');
                        if (weatherLoading) {
                            weatherLoading.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                无法加载${location}天气信息: ${error.message}
                            </div>`;
                        }
                        
                        // 5秒后移除错误消息
                        setTimeout(() => {
                            const weatherLoading = responseElement.querySelector('.weather-loading');
                            if (weatherLoading) {
                                weatherLoading.remove();
                            }
                        }, 5000);
                    });
            }
            
            // 创建天气信息小部件
            function createWeatherWidget(weatherData) {
                // 如果没有天气数据，返回空字符串
                if (!weatherData || !weatherData.current) return '';
                
                const current = weatherData.current;
                const forecast = weatherData.forecast?.forecastday || [];
                
                // 获取天气图标
                const getWeatherIcon = (condition) => {
                    const code = condition?.code;
                    const isDay = condition?.is_day === 1;
                    
                    // 基于天气代码和时间返回对应的Bootstrap图标
                    if (code >= 1000 && code <= 1003) { // 晴/多云
                        return isDay ? 'bi-sun' : 'bi-moon-stars';
                    } else if (code >= 1004 && code <= 1009) { // 阴/多云
                        return 'bi-cloud';
                    } else if (code >= 1030 && code <= 1039) { // 雾/霾
                        return 'bi-cloud-fog';
                    } else if (code >= 1063 && code <= 1069) { // 小雨
                        return 'bi-cloud-drizzle';
                    } else if (code >= 1180 && code <= 1195) { // 中到大雨
                        return 'bi-cloud-rain';
                    } else if (code >= 1196 && code <= 1201) { // 冻雨
                        return 'bi-cloud-sleet';
                    } else if (code >= 1204 && code <= 1237) { // 雪/冰雹
                        return 'bi-cloud-snow';
                    } else if (code >= 1273 && code <= 1282) { // 雷雨
                        return 'bi-cloud-lightning-rain';
                    }
                    
                    return 'bi-cloud'; // 默认图标
                };
                
                // 创建天气小部件HTML
                let html = `
                <div class="weather-widget mt-3 mb-3" style="background: linear-gradient(to right, #41C1F0, #2272EB); color: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="current-weather d-flex align-items-center">
                            <i class="${getWeatherIcon(current.condition)}" style="font-size: 2.5rem; margin-right: 15px;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 20px; font-weight: bold;">${weatherData.location?.name || '未知位置'}</h5>
                                <p class="mb-0" style="font-size: 14px;">${current.condition?.text || '未知天气'}, ${current.temp_c}°C</p>
                            </div>
                        </div>
                        <div class="weather-details text-end">
                            <p class="mb-0" style="font-size: 14px;">湿度: ${current.humidity}%</p>
                            <p class="mb-0" style="font-size: 14px;">风速: ${current.wind_kph} km/h</p>
                        </div>
                    </div>`;
                
                // 添加未来天气预报
                if (forecast.length > 0) {
                    html += `
                    <div class="weather-forecast mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.3);">
                        <h6 style="font-size: 16px; margin-bottom: 10px;">未来天气预报</h6>
                        <div class="d-flex justify-content-between">`;
                    
                    // 最多显示3天的预报
                    const maxDays = Math.min(forecast.length, 3);
                    for (let i = 0; i < maxDays; i++) {
                        const day = forecast[i];
                        const date = new Date(day.date);
                        const dayNames = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                        const dayName = dayNames[date.getDay()];
                        
                        html += `
                        <div class="forecast-day text-center" style="flex: 1;">
                            <p class="mb-1" style="font-size: 14px;">${dayName}</p>
                            <i class="${getWeatherIcon(day.day.condition)}" style="font-size: 1.5rem;"></i>
                            <p class="mb-0 mt-1" style="font-size: 14px;">${day.day.maxtemp_c}° / ${day.day.mintemp_c}°</p>
                        </div>`;
                    }
                    
                    html += `
                        </div>
                    </div>`;
                }
                
                // 添加旅行建议
                html += `
                    <div class="weather-travel-tips mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.3);">
                        <h6 style="font-size: 16px; margin-bottom: 10px;">天气旅行建议</h6>
                        <p class="mb-0" style="font-size: 14px;">`;
                
                // 根据天气状况提供建议
                const condition = current.condition?.text || '';
                const temp = current.temp_c || 0;
                
                if (condition.includes('雨')) {
                    html += '记得携带雨伞，选择室内景点游览更合适。';
                } else if (condition.includes('雪')) {
                    html += '请注意保暖，路面可能湿滑，注意安全。';
                } else if (condition.includes('晴') && temp > 28) {
                    html += '天气炎热，请做好防晒，多补充水分，避免中午高温时段户外活动。';
                } else if (condition.includes('晴') || condition.includes('多云')) {
                    html += '天气适宜出行，适合户外活动和拍照。';
                } else if (condition.includes('雾') || condition.includes('霾')) {
                    html += '能见度较低，注意交通安全，可考虑调整为室内景点。';
                } else {
                    html += '建议关注实时天气变化，灵活调整出行计划。';
                }
                
                html += `
                        </p>
                    </div>
                </div>`;
                
                return html;
            }
            
            // 更新天气相关的旅游推荐
            function updateRouteRecommendation(weatherData, routes, city) {
                if (!weatherData || !weatherData.current || !routes || routes.length === 0) return;
                
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) return;
                
                const condition = weatherData.current.condition?.text || '';
                const temp = weatherData.current.temp_c || 0;
                
                // 寻找旅行建议段落
                const travelTipsElements = responseElement.querySelectorAll('.travel-tips p');
                if (travelTipsElements.length === 0) return;
                
                // 根据天气状况添加特定建议
                let weatherSpecificTip = document.createElement('p');
                weatherSpecificTip.className = 'mb-1';
                weatherSpecificTip.style.fontSize = '14px';
                weatherSpecificTip.style.color = '#555';
                
                if (condition.includes('雨')) {
                    weatherSpecificTip.innerHTML = '<strong>天气提醒：</strong> 预计有雨，建议调整为参观博物馆、美术馆等室内景点，或准备雨具。';
                    
                    // 在路线中找到室内景点并添加标记
                    routes.forEach((dayRoute, dayIndex) => {
                        dayRoute.forEach((poi, poiIndex) => {
                            if (poi.indoor === true || 
                                (poi.name && (
                                    poi.name.includes('博物馆') || 
                                    poi.name.includes('美术馆') || 
                                    poi.name.includes('展览') ||
                                    poi.name.includes('茶馆')
                                ))) {
                                // 找到对应的POI项添加推荐标记
                                const poiItems = responseElement.querySelectorAll('.day-route');
                                if (poiItems.length > dayIndex) {
                                    const poiElements = poiItems[dayIndex].querySelectorAll('.poi-item');
                                    if (poiElements.length > poiIndex) {
                                        const nameElement = poiElements[poiIndex].querySelector('.poi-name');
                                        if (nameElement) {
                                            nameElement.innerHTML += ' <span style="color: #2196F3; font-size: 12px;">(雨天推荐)</span>';
                                        }
                                    }
                                }
                            }
                        });
                    });
                } else if (condition.includes('晴') && temp > 28) {
                    weatherSpecificTip.innerHTML = '<strong>天气提醒：</strong> 天气炎热，建议避开中午高温时段，选择清晨或傍晚游览户外景点。';
                } else if (condition.includes('雾') || condition.includes('霾')) {
                    weatherSpecificTip.innerHTML = '<strong>天气提醒：</strong> 能见度较低，拍照效果可能受影响，建议调整期望或选择近距离观赏的景点。';
                } else {
                    weatherSpecificTip.innerHTML = '<strong>天气提醒：</strong> 天气适宜，按计划游览即可，景色会很棒！';
                }
                
                // 添加到旅行建议的最后
                travelTipsElements[travelTipsElements.length - 1].parentNode.appendChild(weatherSpecificTip);
            }
        });
    </script>
    
    <!-- Markdown编辑器增强功能 -->
    <script>
        // 添加分屏Markdown编辑/预览功能
        function enhanceMarkdownDisplay() {
            // 添加必要的CSS样式
            const style = document.createElement('style');
            style.textContent = `
                .markdown-container {
                    display: flex;
                    flex-direction: column;
                    border: 1px solid #e1e4e8;
                    border-radius: 6px;
                    overflow: hidden;
                    margin-bottom: 20px;
                }
                
                .markdown-toolbar {
                    display: flex;
                    padding: 8px;
                    background-color: #f6f8fa;
                    border-bottom: 1px solid #e1e4e8;
                    flex-wrap: wrap;
                }
                
                .markdown-toolbar button {
                    background-color: transparent;
                    border: 1px solid #e1e4e8;
                    border-radius: 3px;
                    color: #24292e;
                    cursor: pointer;
                    font-size: 14px;
                    margin-right: 4px;
                    padding: 4px 8px;
                    transition: background-color 0.2s;
                }
                
                .markdown-toolbar button:hover {
                    background-color: #e1e4e8;
                }
                
                .markdown-toolbar button.active {
                    background-color: #ddf4ff;
                    border-color: #54aeff;
                    color: #0969da;
                }
                
                .markdown-view-options {
                    margin-left: auto;
                }
                
                .markdown-content-area {
                    display: flex;
                    height: 300px;
                    border-top: 1px solid #e1e4e8;
                }
                
                .markdown-editor {
                    flex: 1;
                    border: none;
                    padding: 16px;
                    resize: none;
                    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                    font-size: 14px;
                    line-height: 1.5;
                    overflow: auto;
                }
                
                .markdown-editor:focus {
                    outline: none;
                }
                
                .markdown-preview {
                    flex: 1;
                    padding: 16px;
                    border-left: 1px solid #e1e4e8;
                    overflow: auto;
                }
                
                .markdown-preview.hidden,
                .markdown-editor.hidden {
                    display: none;
                }
                
                .markdown-preview.full-width,
                .markdown-editor.full-width {
                    flex: 1;
                    border-left: none;
                }
                
                /* 显示源代码的样式 */
                .markdown-source-view pre {
                    margin: 0;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    background-color: #f6f8fa;
                    padding: 16px;
                    border-radius: 6px;
                    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                    font-size: 14px;
                    line-height: 1.5;
                    color: #24292e;
                    overflow: auto;
                }
                
                /* 高亮语法样式 */
                .markdown-editor .keyword { color: #d73a49; }
                .markdown-editor .string { color: #032f62; }
                .markdown-editor .comment { color: #6a737d; }
                .markdown-editor .heading { color: #005cc5; font-weight: bold; }
                .markdown-editor .list { color: #6f42c1; }
            `;
            document.head.appendChild(style);
            
            // 修改addMessage函数，为响应添加Markdown编辑器界面
            const originalAddMessage = window.addMessage;
            window.addMessage = function(text, isUser, showReasoning = false) {
                // 调用原始函数创建消息容器
                const messageContainer = originalAddMessage(text, isUser, showReasoning);
                
                // 如果是AI响应，添加Markdown编辑器界面
                if (!isUser && showReasoning) {
                    const responseElement = messageContainer.querySelector('#currentResponse');
                    const reasoningElement = messageContainer.querySelector('.reasoning-content');
                    
                    if (responseElement) {
                        // 保存原始内容
                        const originalContent = responseElement.innerHTML;
                        
                        // 清空原始内容
                        responseElement.innerHTML = '';
                        
                        // 创建Markdown编辑器容器
                        const markdownContainer = document.createElement('div');
                        markdownContainer.className = 'markdown-container';
                        
                        // 创建工具栏
                        const toolbar = document.createElement('div');
                        toolbar.className = 'markdown-toolbar';
                        
                        // 常用的Markdown快捷按钮
                        const buttons = [
                            { icon: 'bi-type-bold', title: '加粗', action: 'bold', markup: '**文本**' },
                            { icon: 'bi-type-italic', title: '斜体', action: 'italic', markup: '*文本*' },
                            { icon: 'bi-code', title: '代码', action: 'code', markup: '`代码`' },
                            { icon: 'bi-link', title: '链接', action: 'link', markup: '[链接文本](http://...)' },
                            { icon: 'bi-list-ul', title: '无序列表', action: 'unordered-list', markup: '- 列表项\n- 列表项' },
                            { icon: 'bi-list-ol', title: '有序列表', action: 'ordered-list', markup: '1. 列表项\n2. 列表项' },
                            { icon: 'bi-blockquote-left', title: '引用', action: 'quote', markup: '> 引用文本' },
                            { icon: 'bi-code-square', title: '代码块', action: 'codeblock', markup: '```\n代码块\n```' },
                            { icon: 'bi-type-h1', title: '标题1', action: 'h1', markup: '# 标题1' },
                            { icon: 'bi-type-h2', title: '标题2', action: 'h2', markup: '## 标题2' },
                            { icon: 'bi-type-h3', title: '标题3', action: 'h3', markup: '### 标题3' },
                        ];
                        
                        buttons.forEach(btn => {
                            const button = document.createElement('button');
                            button.innerHTML = `<i class="${btn.icon}"></i>`;
                            button.title = btn.title;
                            button.dataset.action = btn.action;
                            button.dataset.markup = btn.markup;
                            button.addEventListener('click', (e) => insertMarkup(e.target.closest('button').dataset.markup));
                            toolbar.appendChild(button);
                        });
                        
                        // 添加视图切换选项
                        const viewOptions = document.createElement('div');
                        viewOptions.className = 'markdown-view-options';
                        
                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '<i class="bi bi-pencil"></i> 编辑';
                        editBtn.title = '编辑模式';
                        editBtn.dataset.view = 'edit';
                        editBtn.classList.add('active');
                        
                        const splitBtn = document.createElement('button');
                        splitBtn.innerHTML = '<i class="bi bi-layout-split"></i> 分屏';
                        splitBtn.title = '分屏模式';
                        splitBtn.dataset.view = 'split';
                        
                        const previewBtn = document.createElement('button');
                        previewBtn.innerHTML = '<i class="bi bi-eye"></i> 预览';
                        previewBtn.title = '预览模式';
                        previewBtn.dataset.view = 'preview';
                        
                        // 添加视图切换事件
                        [editBtn, splitBtn, previewBtn].forEach(btn => {
                            btn.addEventListener('click', function() {
                                // 移除所有按钮的active类
                                [editBtn, splitBtn, previewBtn].forEach(b => b.classList.remove('active'));
                                // 添加当前按钮的active类
                                this.classList.add('active');
                                
                                // 根据选择的视图调整编辑器和预览区域
                                const view = this.dataset.view;
                                const editor = markdownContainer.querySelector('.markdown-editor');
                                const preview = markdownContainer.querySelector('.markdown-preview');
                                
                                if (view === 'edit') {
                                    editor.classList.remove('hidden');
                                    editor.classList.add('full-width');
                                    preview.classList.add('hidden');
                                    preview.classList.remove('full-width');
                                } else if (view === 'preview') {
                                    editor.classList.add('hidden');
                                    editor.classList.remove('full-width');
                                    preview.classList.remove('hidden');
                                    preview.classList.add('full-width');
                                } else { // split
                                    editor.classList.remove('hidden', 'full-width');
                                    preview.classList.remove('hidden', 'full-width');
                                }
                            });
                            viewOptions.appendChild(btn);
                        });
                        
                        toolbar.appendChild(viewOptions);
                        markdownContainer.appendChild(toolbar);
                        
                        // 创建编辑和预览区域
                        const contentArea = document.createElement('div');
                        contentArea.className = 'markdown-content-area';
                        
                        // 创建编辑器
                        const editor = document.createElement('textarea');
                        editor.className = 'markdown-editor';
                        editor.placeholder = '输入Markdown文本...';
                        // 设置初始文本
                        editor.value = originalContent.replace(/<[^>]*>/g, ''); // 简单去除HTML标签
                        
                        // 创建预览区
                        const preview = document.createElement('div');
                        preview.className = 'markdown-preview';
                        // 设置初始预览内容
                        try {
                            preview.innerHTML = window.renderMarkdown(editor.value);
                        } catch (error) {
                            preview.innerHTML = '<p>预览加载失败</p>';
                            console.error('预览加载失败:', error);
                        }
                        
                        // 当编辑器内容变化时更新预览
                        editor.addEventListener('input', function() {
                            try {
                                const markdown = this.value;
                                preview.innerHTML = window.renderMarkdown(markdown);
                            } catch (error) {
                                preview.innerHTML = '<p>预览加载失败</p>';
                                console.error('预览更新失败:', error);
                            }
                        });
                        
                        // 插入标记的函数
                        function insertMarkup(markup) {
                            const start = editor.selectionStart;
                            const end = editor.selectionEnd;
                            const selectedText = editor.value.substring(start, end);
                            
                            let replacement = markup;
                            if (selectedText) {
                                // 如果有选中文本，替换掉标记中的占位符
                                if (markup.includes('文本')) {
                                    replacement = markup.replace('文本', selectedText);
                                } else if (markup.includes('链接文本')) {
                                    replacement = markup.replace('链接文本', selectedText);
                                } else if (markup.includes('代码') && !markup.includes('代码块')) {
                                    replacement = markup.replace('代码', selectedText);
                                } else if (markup.includes('代码块')) {
                                    replacement = "```\n" + selectedText + "\n```";
                                } else if (markup.includes('引用文本')) {
                                    replacement = markup.replace('引用文本', selectedText);
                                } else if (markup.includes('标题')) {
                                    if (markup.includes('# 标题1')) {
                                        replacement = "# " + selectedText;
                                    } else if (markup.includes('## 标题2')) {
                                        replacement = "## " + selectedText;
                                    } else if (markup.includes('### 标题3')) {
                                        replacement = "### " + selectedText;
                                    }
                                } else if (markup.includes('列表项')) {
                                    // 处理列表项，为每行前面添加相应的标记
                                    const lines = selectedText.split('\n');
                                    if (markup.startsWith('-')) {
                                        replacement = lines.map(line => `- ${line}`).join('\n');
                                    } else if (markup.startsWith('1.')) {
                                        replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                                    }
                                }
                            }
                            
                            // 插入内容
                            editor.focus();
                            document.execCommand('insertText', false, replacement);
                            
                            // 更新预览
                            try {
                                preview.innerHTML = window.renderMarkdown(editor.value);
                            } catch (error) {
                                console.error('预览更新失败:', error);
                            }
                        }
                        
                        // 添加到容器
                        contentArea.appendChild(editor);
                        contentArea.appendChild(preview);
                        markdownContainer.appendChild(contentArea);
                        
                        // 将Markdown编辑器添加到响应元素
                        responseElement.appendChild(markdownContainer);
                        
                        // 如果有推理元素，也应用同样的处理
                        if (reasoningElement) {
                            const reasoningOriginalContent = reasoningElement.innerHTML;
                            // 清空原始内容
                            reasoningElement.innerHTML = '';
                            
                            // 创建Markdown编辑器容器
                            const reasoningMarkdownContainer = document.createElement('div');
                            reasoningMarkdownContainer.className = 'markdown-container';
                            
                            // 复制工具栏
                            const reasoningToolbar = toolbar.cloneNode(true);
                            // 重新添加事件
                            reasoningToolbar.querySelectorAll('button[data-markup]').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const reasoningEditor = reasoningMarkdownContainer.querySelector('.markdown-editor');
                                    insertReasoningMarkup(e.target.closest('button').dataset.markup, reasoningEditor);
                                });
                            });
                            
                            // 处理视图切换按钮
                            const reasoningViewBtns = reasoningToolbar.querySelectorAll('.markdown-view-options button');
                            reasoningViewBtns.forEach(btn => {
                                btn.addEventListener('click', function() {
                                    // 移除所有按钮的active类
                                    reasoningViewBtns.forEach(b => b.classList.remove('active'));
                                    // 添加当前按钮的active类
                                    this.classList.add('active');
                                    
                                    // 根据选择的视图调整编辑器和预览区域
                                    const view = this.dataset.view;
                                    const editor = reasoningMarkdownContainer.querySelector('.markdown-editor');
                                    const preview = reasoningMarkdownContainer.querySelector('.markdown-preview');
                                    
                                    if (view === 'edit') {
                                        editor.classList.remove('hidden');
                                        editor.classList.add('full-width');
                                        preview.classList.add('hidden');
                                        preview.classList.remove('full-width');
                                    } else if (view === 'preview') {
                                        editor.classList.add('hidden');
                                        editor.classList.remove('full-width');
                                        preview.classList.remove('hidden');
                                        preview.classList.add('full-width');
                                    } else { // split
                                        editor.classList.remove('hidden', 'full-width');
                                        preview.classList.remove('hidden', 'full-width');
                                    }
                                });
                            });
                            
                            reasoningMarkdownContainer.appendChild(reasoningToolbar);
                            
                            // 创建编辑和预览区域
                            const reasoningContentArea = document.createElement('div');
                            reasoningContentArea.className = 'markdown-content-area';
                            
                            // 创建编辑器
                            const reasoningEditor = document.createElement('textarea');
                            reasoningEditor.className = 'markdown-editor';
                            reasoningEditor.placeholder = '输入推理过程的Markdown文本...';
                            // 设置初始文本
                            reasoningEditor.value = reasoningOriginalContent.replace(/<[^>]*>/g, ''); // 简单去除HTML标签
                            
                            // 创建预览区
                            const reasoningPreview = document.createElement('div');
                            reasoningPreview.className = 'markdown-preview';
                            // 设置初始预览内容
                            try {
                                reasoningPreview.innerHTML = window.renderMarkdown(reasoningEditor.value);
                            } catch (error) {
                                reasoningPreview.innerHTML = '<p>预览加载失败</p>';
                                console.error('推理预览加载失败:', error);
                            }
                            
                            // 当编辑器内容变化时更新预览
                            reasoningEditor.addEventListener('input', function() {
                                try {
                                    const markdown = this.value;
                                    reasoningPreview.innerHTML = window.renderMarkdown(markdown);
                                } catch (error) {
                                    reasoningPreview.innerHTML = '<p>预览加载失败</p>';
                                    console.error('推理预览更新失败:', error);
                                }
                            });
                            
                            // 插入标记的函数
                            function insertReasoningMarkup(markup, editor) {
                                const start = editor.selectionStart;
                                const end = editor.selectionEnd;
                                const selectedText = editor.value.substring(start, end);
                                
                                let replacement = markup;
                                if (selectedText) {
                                    // 如果有选中文本，替换掉标记中的占位符
                                    if (markup.includes('文本')) {
                                        replacement = markup.replace('文本', selectedText);
                                    } else if (markup.includes('链接文本')) {
                                        replacement = markup.replace('链接文本', selectedText);
                                    } else if (markup.includes('代码') && !markup.includes('代码块')) {
                                        replacement = markup.replace('代码', selectedText);
                                    } else if (markup.includes('代码块')) {
                                        replacement = "```\n" + selectedText + "\n```";
                                    } else if (markup.includes('引用文本')) {
                                        replacement = markup.replace('引用文本', selectedText);
                                    } else if (markup.includes('标题')) {
                                        if (markup.includes('# 标题1')) {
                                            replacement = "# " + selectedText;
                                        } else if (markup.includes('## 标题2')) {
                                            replacement = "## " + selectedText;
                                        } else if (markup.includes('### 标题3')) {
                                            replacement = "### " + selectedText;
                                        }
                                    } else if (markup.includes('列表项')) {
                                        // 处理列表项，为每行前面添加相应的标记
                                        const lines = selectedText.split('\n');
                                        if (markup.startsWith('-')) {
                                            replacement = lines.map(line => `- ${line}`).join('\n');
                                        } else if (markup.startsWith('1.')) {
                                            replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                                        }
                                    }
                                }
                                
                                // 插入内容
                                editor.focus();
                                document.execCommand('insertText', false, replacement);
                                
                                // 更新预览
                                try {
                                    reasoningPreview.innerHTML = window.renderMarkdown(editor.value);
                                } catch (error) {
                                    console.error('推理预览更新失败:', error);
                                }
                            }
                            
                            // 添加到容器
                            reasoningContentArea.appendChild(reasoningEditor);
                            reasoningContentArea.appendChild(reasoningPreview);
                            reasoningMarkdownContainer.appendChild(reasoningContentArea);
                            
                            // 将Markdown编辑器添加到推理元素
                            reasoningElement.appendChild(reasoningMarkdownContainer);
                        }
                    }
                }
                
                return messageContainer;
            };
            
            // 修改getStreamingResponse函数，使其支持Markdown编辑器
            const originalGetStreamingResponse = window.getStreamingResponse;
            window.getStreamingResponse = function(userMessage) {
                console.log("开始获取LLM流式响应（增强版）...");
                
                // 禁用发送按钮
                const sendButton = document.getElementById('sendButton');
                if (sendButton) sendButton.disabled = true;
                
                // 找到响应和推理元素
                const responseElement = document.querySelector('#currentResponse');
                const reasoningElement = window.lastReasoningContainer ? 
                    window.lastReasoningContainer.querySelector('.reasoning-content') : null;
                
                if (!responseElement) {
                    console.error("找不到响应元素 #currentResponse");
                    return;
                }
                
                // 查找Markdown编辑器元素
                const responseEditor = responseElement.querySelector('.markdown-editor');
                const responsePreview = responseElement.querySelector('.markdown-preview');
                const reasoningEditor = reasoningElement ? reasoningElement.querySelector('.markdown-editor') : null;
                const reasoningPreview = reasoningElement ? reasoningElement.querySelector('.markdown-preview') : null;
                
                // 创建EventSource对象
                const url = `/api/chat?prompt=${encodeURIComponent(userMessage)}`;
                console.log("连接到SSE API: ", url);
                const eventSource = new EventSource(url);
                
                let currentReasoningText = '';
                let currentResponseText = '';
                
                // 监听消息
                eventSource.onmessage = function(event) {
                    console.log("收到SSE消息:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        // 处理推理内容
                        if (data.type === "reasoning" && data.content) {
                            currentReasoningText += data.content;
                            
                            // 如果有Markdown编辑器，更新编辑器内容和预览
                            if (reasoningEditor && reasoningPreview) {
                                try {
                                    reasoningEditor.value = currentReasoningText;
                                    reasoningPreview.innerHTML = window.renderMarkdown(currentReasoningText);
                                } catch (renderError) {
                                    console.log("渲染推理内容时出错:", renderError);
                                    reasoningPreview.textContent = currentReasoningText;
                                }
                                
                                // 滚动到底部
                                reasoningEditor.scrollTop = reasoningEditor.scrollHeight;
                                reasoningPreview.scrollTop = reasoningPreview.scrollHeight;
                            } 
                            // 否则使用原始方法更新推理内容
                            else if (reasoningElement) {
                                try {
                                    reasoningElement.innerHTML = window.renderMarkdown(currentReasoningText);
                                    if (reasoningElement.scrollHeight) {
                                        reasoningElement.scrollTop = reasoningElement.scrollHeight;
                                    }
                                    
                                    // 确保推理内容容器可见
                                    if (reasoningElement.classList.contains('collapsed')) {
                                        reasoningElement.classList.remove('collapsed');
                                    }
                                } catch (renderError) {
                                    console.log("渲染推理内容时出错:", renderError);
                                    reasoningElement.textContent = currentReasoningText;
                                }
                            }
                        } 
                        // 当收到分隔符，表示推理结束，开始生成回答
                        else if (data.type === "separator") {
                            console.log("推理结束，开始生成回答");
                            // 清除加载动画
                            if (!responseEditor && responseElement) {
                                responseElement.innerHTML = '';
                            }
                        } 
                        // 处理回答内容
                        else if (data.type === "content" && data.content) {
                            currentResponseText += data.content;
                            
                            // 如果有Markdown编辑器，更新编辑器内容和预览
                            if (responseEditor && responsePreview) {
                                try {
                                    responseEditor.value = currentResponseText;
                                    responsePreview.innerHTML = window.renderMarkdown(currentResponseText);
                                } catch (renderError) {
                                    console.log("渲染回答内容时出错:", renderError);
                                    responsePreview.textContent = currentResponseText;
                                }
                                
                                // 滚动到底部
                                responseEditor.scrollTop = responseEditor.scrollHeight;
                                responsePreview.scrollTop = responsePreview.scrollHeight;
                            }
                            // 否则使用原始方法更新响应内容
                            else if (responseElement) {
                                try {
                                    responseElement.innerHTML = window.renderMarkdown(currentResponseText);
                                    const chatContent = document.getElementById('chatContent');
                                    if (chatContent && chatContent.scrollHeight) {
                                        chatContent.scrollTop = chatContent.scrollHeight;
                                    }
                                } catch (renderError) {
                                    console.log("渲染回答内容时出错:", renderError);
                                    responseElement.textContent = currentResponseText; // 回退到纯文本
                                }
                            }
                        }
                        // 处理知识图谱数据
                        else if (data.type === "graph_data" && data.content) {
                            console.log("收到知识图谱数据，准备渲染");
                            try {
                                // 显示加载指示
                                graphLoading.classList.remove('d-none');
                                
                                // 渲染新的知识图谱
                                renderGraph(data.content);
                                
                                // 隐藏加载指示
                                graphLoading.classList.add('d-none');
                            } catch (graphError) {
                                console.error("处理知识图谱数据时出错:", graphError);
                                graphLoading.classList.add('d-none');
                            }
                        }
                        // 处理状态消息
                        else if (data.type === "status" && data.content) {
                            console.log("收到状态消息:", data.content);
                            // 可以选择将状态消息添加到推理内容或其他地方
                        }
                        // 处理流结束事件
                        else if (data.type === "end") {
                            console.log("流式响应结束");
                            eventSource.close();
                            sendButton.disabled = false;
                            
                            // 提取偏好并获取路线数据
                            try {
                                if (typeof window.extractPreferencesAndGetRoutes === 'function') {
                                    window.extractPreferencesAndGetRoutes(userMessage);
                                } else if (typeof extractPreferencesAndGetRoutes === 'function') {
                                    extractPreferencesAndGetRoutes(userMessage);
                                }
                            } catch (routeError) {
                                console.log("提取偏好或获取路线时出错:", routeError);
                            }
                        }
                    } catch (error) {
                        console.error("解析事件数据出错:", error, "原始数据:", event.data);
                        
                        // 如果有Markdown编辑器，更新错误信息
                        if (responseEditor && responsePreview) {
                            responseEditor.value = "解析响应时出现错误，请稍后再试。";
                            responsePreview.innerHTML = "<p>解析响应时出现错误，请稍后再试。</p>";
                        }
                        // 否则使用原始方法显示错误
                        else if (responseElement) {
                            responseElement.innerHTML = "解析响应时出现错误，请稍后再试。";
                        }
                        
                        eventSource.close();
                        if (sendButton) sendButton.disabled = false;
                    }
                };
                
                // 连接打开时的处理
                eventSource.onopen = function(event) {
                    console.log("SSE连接已打开");
                };
                
                // 错误处理
                eventSource.onerror = function(event) {
                    console.error("EventSource错误:", event);
                    eventSource.close();
                    
                    // 如果有Markdown编辑器，更新错误信息
                    if (responseEditor && responsePreview) {
                        if (currentResponseText) {
                            responseEditor.value = currentResponseText;
                            try {
                                responsePreview.innerHTML = window.renderMarkdown(currentResponseText);
                            } catch (error) {
                                responsePreview.textContent = currentResponseText;
                            }
                        } else {
                            responseEditor.value = "连接到服务器时出错，请重试。";
                            responsePreview.innerHTML = "<p>连接到服务器时出错，请重试。</p>";
                        }
                    }
                    // 否则使用原始方法显示错误
                    else if (responseElement) {
                        if (currentResponseText) {
                            try {
                                responseElement.innerHTML = window.renderMarkdown(currentResponseText);
                            } catch (error) {
                                responseElement.textContent = currentResponseText;
                            }
                        } else {
                            responseElement.innerHTML = "连接到服务器时出错，请重试。";
                        }
                    }
                    
                    if (sendButton) sendButton.disabled = false;
                };
            };
            
            console.log("Markdown编辑器增强功能已加载");
        }

        // 初始化函数
        function initMarkdownEditor() {
            // 确保DOM已加载
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', enhanceMarkdownDisplay);
            } else {
                enhanceMarkdownDisplay();
            }
        }

        // 运行初始化
        initMarkdownEditor();
    </script>
</body>
</html> 