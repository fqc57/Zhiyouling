<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ¸¸çµ - ä¸€ä½“åŒ–æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.2/dist/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
    <!-- ç¡®ä¿ marked åœ¨ä¸åŒç‰ˆæœ¬é—´å…¼å®¹ -->
    <script>
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶å¤„ç† marked å…¼å®¹æ€§
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹ marked æ˜¯å¦ä¸ºå¯¹è±¡ï¼ˆæ–°ç‰ˆæœ¬ 5.xï¼‰
            if (typeof marked === 'object' && typeof marked.parse === 'function') {
                console.log('æ£€æµ‹åˆ° marked 5.xï¼Œåˆ›å»ºå…¼å®¹å±‚');
                // ä¿å­˜åŸå§‹ marked å¯¹è±¡
                const originalMarked = window.marked;
                
                // åˆ›å»ºå…¼å®¹æ—§ç‰ˆæœ¬çš„å‡½æ•°
                window.marked = function(text) {
                    return originalMarked.parse(text);
                };
                
                // ä¿ç•™ setOptions æ–¹æ³•
                window.marked.setOptions = originalMarked.setOptions;
                
                // ä¿ç•™ parse æ–¹æ³•
                window.marked.parse = originalMarked.parse;
            }
        });
    </script>
    <style>
        :root {
            --primary-color: #1e88e5;
            --primary-light: #6ab7ff;
            --primary-dark: #005cb2;
            --accent-color: #ff5722;
            --text-dark: #263238;
            --text-light: #eceff1;
            --background-dark: #102027;
            --background-light: #f5f5f5;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "SimHei", sans-serif;
            height: 100%;
            background-color: var(--background-light);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            color: white;
            transform: translateX(-5px);
        }
        
        .back-btn i {
            margin-right: 5px;
        }

        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #005cb2 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-container {
            padding: 1.5rem;
            height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .unified-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 1rem;
            flex: 1;
            margin-top: 1rem;
        }

        .chat-area {
            grid-column: 1;
            grid-row: 1 / span 2;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .map-area {
            grid-column: 2;
            grid-row: 1;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .graph-area {
            grid-column: 2;
            grid-row: 2;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .section-header {
            padding: 1rem;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1ecf9;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .section-content {
            padding: 1rem;
            overflow: auto;
            flex: 1;
        }

        /* å¯¹è¯åŒºæ ·å¼ */
        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }
        
        #prompt {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #prompt:focus {
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
            outline: none;
        }
        
        .send-button {
            padding: 0 1.5rem;
            background-color: #1e88e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-button:hover {
            background-color: #1976D2;
            box-shadow: 0 3px 10px rgba(30, 136, 229, 0.3);
        }
        
        .send-button i {
            margin-right: 8px;
        }

        /* å“åº”æ ·å¼ */
        .response-container {
            background-color: rgba(245, 245, 245, 0.95);
            border-radius: 12px;
            padding: 1.8rem;
            margin-top: 1.8rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(10px);
        }

        .user-message {
            background: linear-gradient(135deg, #e6f3ff 0%, #e1f5fe 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e88e5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .user-message:hover {
            transform: translateY(-2px);
        }

        .assistant-message {
            background: linear-gradient(135deg, #f5f7fa 0%, #f5f5f5 100%);
            border-radius: 18px;
            border-top-left-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #66bb6a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .reasoning-container {
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e1effe;
        }

        .reasoning-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1effe;
            cursor: pointer;
        }
        
        .reasoning-title {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #0d47a1;
            font-size: 14px;
        }
        
        .reasoning-title i {
            margin-right: 8px;
            color: #1e88e5;
        }
        
        .reasoning-content {
            padding: 15px;
            color: #455a64;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fdfdfd;
            max-height: 300px;
            overflow-y: auto;
            display: block !important;
        }
        
        .reasoning-content.collapsed {
            display: none !important;
        }
        
        .reasoning-toggle i {
            transition: transform 0.3s;
        }

        /* Markdown æ ·å¼ */
        .markdown-content h1, 
        .markdown-content h2, 
        .markdown-content h3, 
        .markdown-content h4, 
        .markdown-content h5, 
        .markdown-content h6 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            color: #333;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.8rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }

        .markdown-content h2 {
            font-size: 1.6rem;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 0.4rem;
        }

        .markdown-content h3 { font-size: 1.4rem; }
        .markdown-content h4 { font-size: 1.2rem; }

        .markdown-content p {
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .markdown-content ol, 
        .markdown-content ul {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        .markdown-content li {
            margin-bottom: 0.5rem;
        }

        .markdown-content blockquote {
            border-left: 4px solid #66bb6a;
            padding-left: 1rem;
            color: #555;
            font-style: italic;
            margin: 1rem 0;
            background-color: rgba(102, 187, 106, 0.1);
            padding: 0.8rem 1rem;
            border-radius: 0 6px 6px 0;
        }

        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .markdown-content code {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content a {
            color: #1e88e5;
            text-decoration: none;
            border-bottom: 1px dashed #1e88e5;
            transition: color 0.2s, border-bottom 0.2s;
        }

        .markdown-content a:hover {
            color: #0d47a1;
            border-bottom: 1px solid #0d47a1;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }

        .markdown-content th, 
        .markdown-content td {
            border: 1px solid #e9ecef;
            padding: 0.6rem;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .markdown-content tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .markdown-content img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            margin: 1rem 0;
        }

        /* æ—…è¡Œå»ºè®®å¡ç‰‡æ ·å¼ */
        .travel-suggestion-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin: 1.5rem 0;
            border-left: 4px solid #ff9800;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .travel-suggestion-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
        }

        .travel-suggestion-title i {
            margin-right: 8px;
            color: #ff9800;
        }

        .poi-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .poi-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .poi-item:last-child {
            border-bottom: none;
        }

        .poi-icon {
            margin-right: 10px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            font-size: 0.8rem;
        }

        .poi-info {
            flex: 1;
        }

        .poi-name {
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .poi-desc {
            font-size: 0.85rem;
            color: #666;
        }

        .travel-tips {
            background-color: rgba(255, 152, 0, 0.1);
            padding: 0.8rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .travel-tips-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .travel-tips-title i {
            margin-right: 8px;
            color: #ff9800;
        }

        /* åœ°å›¾æ ·å¼ */
        .map-container {
            height: 100%;
            width: 100%;
        }

        /* çŸ¥è¯†å›¾è°±æ ·å¼ */
        .graph-container {
            height: 100%;
            width: 100%;
            position: relative;
            background: linear-gradient(to bottom, #f7f9fc, #edf1f7);
            border-radius: 10px;
            overflow: hidden;
        }

        /* èŠ‚ç‚¹æ ·å¼ */
        .kg-node {
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .kg-node circle {
            transition: stroke 0.3s ease, stroke-width 0.3s ease, fill 0.3s ease, filter 0.4s ease;
            filter: drop-shadow(0 2px 3px rgba(0, 0, 0, 0.2));
        }

        .kg-node.in-route circle {
            filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.5));
        }

        .kg-node text {
            transition: font-size 0.3s ease, font-weight 0.3s ease, fill 0.3s ease;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .kg-link {
            transition: stroke-opacity 0.4s ease, stroke-width 0.4s ease, stroke 0.4s ease;
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.6;
        }

        /* å›¾è°±å›¾ä¾‹æ ·å¼ */
        .kg-legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            z-index: 100;
            max-height: calc(100% - 20px);
            overflow-y: auto;
            border-left: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
            transition: all 0.3s ease;
        }

        .kg-legend:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        /* å›¾è°±èŠ‚ç‚¹æç¤ºæ¡† */
        .kg-tooltip {
            position: absolute;
            visibility: hidden;
            background-color: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 280px;
            font-size: 12px;
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
        }

        .kg-tooltip.visible {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        .kg-tooltip h5 {
            margin-top: 0;
            font-size: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
            color: #1a237e;
        }

        .kg-tooltip p {
            margin: 5px 0;
            line-height: 1.5;
            color: #37474f;
        }

        /* ç¼©æ”¾æ§åˆ¶æŒ‰é’® */
        .zoom-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(230, 230, 250, 0.7);
        }

        .zoom-controls button {
            width: 32px;
            height: 32px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #1976d2;
        }

        .zoom-controls button:hover {
            background-color: #1976d2;
            color: white;
            box-shadow: 0 3px 8px rgba(25, 118, 210, 0.3);
        }

        /* é«˜äº®èŠ‚ç‚¹æ ·å¼ */
        .kg-node.highlighted circle {
            stroke: #ff5722;
            stroke-width: 3px;
            stroke-dasharray: 5;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 0 8px rgba(255, 87, 34, 0.5));
        }

        .kg-node.in-route circle {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { stroke-opacity: 1; filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.5)); }
            50% { stroke-opacity: 0.7; filter: drop-shadow(0 0 12px rgba(255, 87, 34, 0.7)); }
            100% { stroke-opacity: 1; filter: drop-shadow(0 0 5px rgba(255, 87, 34, 0.5)); }
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 992px) {
            .unified-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            
            .chat-area {
                grid-column: 1;
                grid-row: 1;
                height: 400px;
            }
            
            .map-area {
                grid-column: 1;
                grid-row: 2;
                height: 400px;
            }
            
            .graph-area {
                grid-column: 1;
                grid-row: 3;
                height: 400px;
            }
        }

        /* ä¼˜åŒ–åŠ©æ‰‹å’Œç”¨æˆ·æ¶ˆæ¯æ ·å¼ */
        .welcome-message {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4eaff 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .welcome-message h2 {
            color: var(--primary-color);
            font-size: 24px;
            margin-bottom: 15px;
        }

        .welcome-message p {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .welcome-message ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .welcome-message li {
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .example-questions {
            background-color: rgba(255,255,255,0.7);
            border-left: 4px solid var(--primary-color);
            padding: 10px 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .example-questions p {
            margin: 8px 0;
            color: var(--text-dark);
            font-style: italic;
        }

        .final-note {
            font-weight: 500;
            color: var(--primary-color) !important;
            margin-top: 20px;
            font-size: 15px;
        }
        
        .user-message {
            background: linear-gradient(135deg, #e6f3ff 0%, #e1f5fe 100%);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e88e5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        .user-message:hover {
            transform: translateY(-2px);
        }

        /* æ¨ç†å®¹å™¨æ ·å¼ */
        .reasoning-container {
            margin-bottom: 1.5rem;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e1effe;
        }

        .reasoning-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #f0f7ff;
            border-bottom: 1px solid #e1effe;
            cursor: pointer;
        }
        
        .reasoning-title {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #0d47a1;
            font-size: 14px;
        }
        
        .reasoning-title i {
            margin-right: 8px;
            color: #1e88e5;
        }
        
        .reasoning-content {
            padding: 15px;
            color: #455a64;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fdfdfd;
            max-height: 300px;
            overflow-y: auto;
            display: block !important;
        }
        
        .reasoning-content.collapsed {
            display: none !important;
        }
        
        .reasoning-toggle i {
            transition: transform 0.3s;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 24px;
            margin: 10px 0;
        }

        .loading-dots div {
            width: 10px;
            height: 10px;
            margin: 0 5px;
            background-color: #4CAF50;
            border-radius: 50%;
            animation: dot-pulse 1.5s infinite ease-in-out;
        }

        .loading-dots div:nth-child(1) {
            animation-delay: 0s;
        }

        .loading-dots div:nth-child(2) {
            animation-delay: 0.5s;
        }

        .loading-dots div:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes dot-pulse {
            0%, 50%, 100% {
                transform: scale(1);
                opacity: 0.5;
            }
            25%, 75% {
                transform: scale(1.5);
                opacity: 1;
            }
        }

        /* æ—…æ¸¸è·¯çº¿æ ·å¼ */
        .travel-route-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }
        
        .travel-route-header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .travel-route-header i {
            font-size: 1.2rem;
        }
        
        .travel-route-day {
            background-color: #f8f9fa;
            padding: 12px 20px;
            font-weight: 600;
            border-bottom: 1px solid #e8e8e8;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .day-badge {
            background-color: #2196F3;
            color: white;
            padding: 3px 10px;
            border-radius: 30px;
            font-size: 0.9rem;
        }
        
        .day-title {
            color: #424242;
            font-weight: 500;
        }
        
        .poi-list {
            list-style: none;
            margin: 0;
            padding: 10px 20px;
        }
        
        .poi-item {
            padding: 15px 0;
            display: flex;
            gap: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-number {
            width: 32px;
            height: 32px;
            background-color: #2196F3;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .poi-content {
            flex-grow: 1;
        }
        
        .poi-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1976D2;
            font-size: 1.05rem;
        }
        
        .poi-desc {
            color: #616161;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .desc-label {
            display: inline-block;
            color: #0277BD;
            font-weight: 500;
            margin: 4px 0;
        }
        
        .desc-label i {
            margin-right: 3px;
        }
        
        .travel-advice {
            background-color: #f5f5f5;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .travel-advice-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: #455A64;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .travel-advice-title i {
            color: #FF9800;
        }
        
        .travel-advice-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .travel-advice-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .travel-advice-item i {
            color: #43A047;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .travel-advice-label {
            font-weight: 500;
            color: #455A64;
            min-width: 60px;
        }
        
        .travel-advice-value {
            color: #546E7A;
            flex-grow: 1;
        }
        
        .travel-advice-notes {
            margin-top: 15px;
            color: #607D8B;
            font-style: italic;
            font-size: 0.95rem;
            padding: 0 8px;
        }
        
        .travel-route-footer {
            margin: 15px 20px;
            font-size: 0.95rem;
            color: #757575;
            font-style: italic;
            text-align: center;
        }
        
        /* Markdown å†…å®¹æ ·å¼ */
        .markdown-content h2 {
            font-size: 1.3rem;
            color: #1e88e5;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 8px;
            margin-top: 1.5rem;
        }

        .markdown-content h3 {
            font-size: 1.1rem;
            color: #333;
            margin-top: 1.2rem;
        }

        .markdown-content strong {
            color: #0d47a1;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="bi bi-geo-alt-fill"></i> æ™ºæ¸¸çµ</a>
            <a href="/" class="back-btn ms-auto">
                <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container container">
        <h3 class="text-center mb-4">æ™ºèƒ½æ—…æ¸¸ä¸€ä½“åŒ–ä½“éªŒ</h3>
        
        <!-- ä¸»è¦å†…å®¹ç½‘æ ¼ -->
        <div class="unified-grid">
            <!-- æ™ºèƒ½å¯¹è¯åŒºåŸŸ -->
            <div class="chat-area">
                <div class="section-header">
                    <span><i class="bi bi-chat-dots"></i> æ·±åº¦æ€è€ƒæ—…æ¸¸åŠ©æ‰‹</span>
                </div>
                <div id="chatContent" class="chat-content">
                    <!-- å¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                <div class="input-area">
                    <input type="text" id="prompt" placeholder="è¯·è¾“å…¥æ‚¨çš„æ—…æ¸¸éœ€æ±‚ï¼Œä¾‹å¦‚ï¼šæƒ³å»æ­å·ä½“éªŒèŒ¶æ–‡åŒ–ï¼Œå®‰æ’3å¤©çš„è¡Œç¨‹..." autofocus>
                    <button id="sendButton" class="send-button">
                        <i class="bi bi-send"></i> å‘é€
                    </button>
                </div>
            </div>
            
            <!-- åœ°å›¾åŒºåŸŸ -->
            <div class="map-area">
                <div class="section-header">
                    <span><i class="bi bi-map"></i> è·¯çº¿è§„åˆ’åœ°å›¾</span>
                    <div class="spinner-border text-primary d-none" id="mapLoading" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                </div>
                <div id="mapContainer" class="map-container">
                    <!-- åœ°å›¾å°†åœ¨è¿™é‡ŒåŠ è½½ -->
                </div>
            </div>
            
            <!-- çŸ¥è¯†å›¾è°±åŒºåŸŸ -->
            <div class="graph-area">
                <div class="section-header">
                    <span><i class="bi bi-diagram-3"></i> æ—…æ¸¸çŸ¥è¯†å›¾è°±</span>
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary d-none" id="graphLoading" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
                <div id="graphContainer" class="graph-container">
                    <!-- çŸ¥è¯†å›¾è°±å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
        
        <!-- è·¯çº¿è¯¦æƒ…åŒºåŸŸ -->
        <div id="routeInfo" class="route-info d-none">
            <!-- è·¯çº¿ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // é…ç½®Markedé€‰é¡¹
            marked.setOptions({
                breaks: true,       // å…è®¸æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                gfm: true,          // ä½¿ç”¨GitHubé£æ ¼çš„Markdown
                pedantic: false,    // ä¸ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼
                sanitize: false,    // ä¸è¿‡æ»¤HTMLæ ‡ç­¾
                smartLists: true,   // ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ—è¡¨è¡Œä¸º
                smartypants: false  // ä¸ä½¿ç”¨æ™ºèƒ½æ ‡ç‚¹
            });
            
            // DOMå…ƒç´ 
            const chatContent = document.getElementById('chatContent');
            const promptInput = document.getElementById('prompt');
            const sendButton = document.getElementById('sendButton');
            const mapContainer = document.getElementById('mapContainer');
            const graphContainer = document.getElementById('graphContainer');
            const routeInfo = document.getElementById('routeInfo');
            const mapLoading = document.getElementById('mapLoading');
            const graphLoading = document.getElementById('graphLoading');
            
            // å½“å‰å¯¹è¯çŠ¶æ€
            let currentReasoningContent = "";
            let currentResponseContent = "";
            let lastReasoningContainer = null;
            
            // åˆå§‹åŒ–åœ°å›¾å’ŒçŸ¥è¯†å›¾è°±
            initializeMap();
            initializeGraph();
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            showWelcomeMessage();
            
            // Markdownæ¸²æŸ“å‡½æ•°
            function renderMarkdown(text) {
                if (!text) return '';
                
                try {
                    // é…ç½®Markedé€‰é¡¹ï¼Œæå‡æ¸²æŸ“è´¨é‡
                    marked.setOptions({
                        gfm: true,          // ä½¿ç”¨GitHubé£æ ¼çš„Markdown
                        breaks: true,        // å…è®¸æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
                        smartLists: true,    // ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ—è¡¨è¡Œä¸º
                        smartypants: true,   // ä½¿ç”¨æ›´æ™ºèƒ½çš„æ ‡ç‚¹ç¬¦å·
                        highlight: function(code, lang) {
                            // å¦‚æœæœ‰åˆé€‚çš„ä»£ç é«˜äº®åº“ï¼Œè¿™é‡Œå¯ä»¥é›†æˆ
                            return code;
                        }
                    });
                    
                    // é¦–å…ˆæ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«æ—…æ¸¸è·¯çº¿è§„åˆ’æ ¼å¼
                    if (text.includes('## æ¨è') && (text.includes('å¤©è·¯çº¿') || text.includes('å¤©è¡Œç¨‹'))) {
                        return formatTravelRoute(text);
                    }
                    
                    // å¦åˆ™ä½¿ç”¨å¸¸è§„Markdownæ¸²æŸ“
                    return marked.parse(text);
                } catch (error) {
                    console.error('Markdownæ¸²æŸ“å¤±è´¥:', error);
                    return text; // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬
                }
            }
            
            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            function showWelcomeMessage() {
                const welcomeHTML = `
                <div class="welcome-message">
                    <h2>æ¬¢è¿ä½¿ç”¨æ™ºæ¸¸çµ - æ‚¨çš„AIæ—…è¡Œè§„åˆ’å¤§å¸ˆ</h2>
                    <p>æˆ‘èƒ½æ„ŸçŸ¥æ‚¨çš„æ—…è¡Œçµæ„Ÿï¼Œèåˆç©ºé—´ä¸æ–‡åŒ–ï¼Œä¸ºæ‚¨æ‰“é€ ä¸“å±æ—…ç¨‹ã€‚æ— è®ºæ‚¨å‘å¾€è¥¿æ¹–çš„è¯—æ„ï¼Œæ¸´æœ›å“å‘³åŸå¸‚ç¾é£Ÿï¼Œè¿˜æ˜¯æƒ³è¦æ¢ç´¢å†å²å¤è¿¹ï¼Œåªéœ€å‘Šè¯‰æˆ‘æ‚¨çš„æƒ³æ³•ã€‚</p>
                    <p>é€šè¿‡å…ˆè¿›çš„ç©ºé—´æ„ŸçŸ¥æŠ€æœ¯å’Œæ–‡åŒ–è¯­ä¹‰ç†è§£ï¼Œæˆ‘å¯ä»¥ï¼š</p>
                    <ul>
                        <li>ğŸ“ æ ¹æ®æ‚¨çš„å…´è¶£æä¾›ä¸ªæ€§åŒ–å¤šæ—¥è·¯çº¿è§„åˆ’</li>
                        <li>ğŸŒ¦ï¸ å®æ—¶å¤©æ°”ä¿¡æ¯ä¸æ™ºèƒ½æ´»åŠ¨è°ƒæ•´å»ºè®®</li>
                        <li>ğŸ” å‘ˆç°ç›®çš„åœ°çš„çŸ¥è¯†å›¾è°±ï¼Œå‘ç°éšè—å…³è”</li>
                        <li>ğŸ—ºï¸ æä¾›æ¸…æ™°ç›´è§‚çš„åœ°å›¾å¯¼èˆª</li>
                    </ul>
                    <p>è¯•è¯•è¿™æ ·é—®æˆ‘ï¼š</p>
                    <div class="example-questions">
                        <p>â€¢ "è®¡åˆ’ä¸€æ¬¡è¥¿å®‰çš„3å¤©ç¾é£Ÿä¹‹æ—…"</p>
                        <p>â€¢ "æƒ³å»æ­å·ä½“éªŒèŒ¶æ–‡åŒ–ï¼Œè¯·å¸®æˆ‘å®‰æ’ä¸¤å¤©çš„è½»æ¾è¡Œç¨‹"</p>
                        <p>â€¢ "å¸®æˆ‘è®¾è®¡ä¸€ä¸ªé«˜å¼ºåº¦çš„åŒ—äº¬å†å²æ–‡åŒ–ä¸€æ—¥æ¸¸"</p>
                    </div>
                    <p class="final-note">æ¯ä¸€æ®µæ—…ç¨‹éƒ½æ˜¯ç‹¬ç‰¹çš„æ•…äº‹ï¼Œè®©æ™ºæ¸¸çµåŠ©æ‚¨ç¼–ç»‡éš¾å¿˜çš„æ—…è¡Œå›å¿†...</p>
                </div>
                `;
                
                // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container', 'assistant-message-container');
                
                // è®¾ç½®æ¶ˆæ¯å†…å®¹
                messageContainer.innerHTML = `
                    <div class="assistant-message">
                        <!--div class="message-avatar">AI</div-->
                        <div class="message-content markdown-content">${welcomeHTML}</div>
                    </div>
                `;
                
                // æ·»åŠ åˆ°èŠå¤©å†…å®¹åŒºåŸŸ
                chatContent.appendChild(messageContainer);
                
                // ä¸ºç¤ºä¾‹é—®é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setTimeout(() => {
                    const exampleQuestions = document.querySelectorAll('.example-questions p');
                    exampleQuestions.forEach(question => {
                        question.style.cursor = 'pointer';
                        question.addEventListener('click', () => {
                            // æå–é—®é¢˜æ–‡æœ¬ï¼ˆç§»é™¤å‰é¢çš„â€¢å’Œå¼•å·ï¼‰
                            const questionText = question.textContent.replace(/^â€¢\s*"|"$/g, '');
                            // å¡«å…¥è¾“å…¥æ¡†
                            promptInput.value = questionText;
                            // èšç„¦è¾“å…¥æ¡†
                            promptInput.focus();
                        });
                    });
                }, 100);
            }
            
            // æ ¼å¼åŒ–æ—…æ¸¸è·¯çº¿ä¸ºç¾è§‚çš„HTML
            function formatTravelRoute(markdownText) {
                try {
                    // ç›´æ¥è¿”å›åŸå§‹markdownçš„æ ‡å‡†HTMLæ¸²æŸ“ï¼Œä¸åšé¢å¤–å¤„ç†
                    return marked.parse(markdownText);
                    
                    /* æ³¨é‡Šæ‰åŸæœ‰ä»£ç ä»¥ä¾¿ä¿ç•™åŸå§‹markdownæ•ˆæœ
                    // é¦–å…ˆä½¿ç”¨markedå°†markdownè½¬ä¸ºåŸºæœ¬HTML
                    const basicHtml = marked.parse(markdownText);
                    
                    // ä½¿ç”¨DOMè§£æå™¨è§£æHTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(basicHtml, 'text/html');
                    
                    // åˆ›å»ºç»“æœå®¹å™¨ï¼Œæ·»åŠ ç¾åŒ–æ ·å¼
                    let result = '<div class="travel-route-container">';
                    
                    // å¤„ç†æ ‡é¢˜ï¼ˆæ¨èXå¤©è·¯çº¿ï¼‰
                    const mainTitle = doc.querySelector('h2');
                    if (mainTitle) {
                        result += `<div class="travel-route-header">
                            <i class="bi bi-compass"></i>
                            ${mainTitle.textContent}
                        </div>`;
                    }
                    
                    // éå†æ¯å¤©çš„è¡Œç¨‹
                    const dayTitles = doc.querySelectorAll('h3');
                    dayTitles.forEach((dayTitle, dayIndex) => {
                        // æå–æ—¥æœŸç¼–å·ï¼Œç§»é™¤"ç¬¬"å’Œ"å¤©è·¯çº¿"ç­‰æ–‡å­—
                        const dayText = dayTitle.textContent;
                        let dayNum = dayText.replace(/ç¬¬|å¤©è·¯çº¿|å¤©è¡Œç¨‹|å¤©|æ—¥/g, '').trim();
                        
                        // æ·»åŠ æ—¥æœŸæ ‡é¢˜ï¼Œä½¿ç”¨æ›´å¥½çš„æ ¼å¼
                        result += `<div class="travel-route-day">
                            <span class="day-badge">Day ${dayNum}</span>
                            <span class="day-title">è¡Œç¨‹å®‰æ’</span>
                        </div>`;
                        
                        // å¯»æ‰¾è¯¥æ—¥è¡Œç¨‹çš„æ‰€æœ‰åˆ—è¡¨é¡¹
                        let poiList = '<ul class="poi-list">';
                        let currentElement = dayTitle.nextElementSibling;
                        
                        // æ”¶é›†è¡Œç¨‹ç‚¹ç›´åˆ°ä¸‹ä¸€ä¸ªæ ‡é¢˜æˆ–æ—…è¡Œå»ºè®®
                        while (currentElement && 
                              !currentElement.matches('h3') && 
                              !currentElement.textContent.includes('æ—…è¡Œå»ºè®®')) {
                            
                            // å¤„ç†æ•°å­—åˆ—è¡¨é¡¹
                            if (currentElement.matches('ol')) {
                                const items = currentElement.querySelectorAll('li');
                                items.forEach((item, index) => {
                                    // æå–æ™¯ç‚¹åç§°ï¼ˆå¼ºè°ƒæ–‡æœ¬ï¼‰
                                    const nameMatch = item.innerHTML.match(/<strong>(.*?)<\/strong>/);
                                    const name = nameMatch ? nameMatch[1] : `æ™¯ç‚¹ ${index + 1}`;
                                    
                                    // ç§»é™¤å¼ºè°ƒæ–‡æœ¬ï¼Œè·å–æè¿°
                                    const desc = item.innerHTML.replace(/<strong>.*?<\/strong>/, '').trim();
                                    
                                    // ä¸ºæè¿°æ·»åŠ å›¾æ ‡
                                    let formattedDesc = desc;
                                    
                                    // æ£€æµ‹å¹¶æ·»åŠ ç¾åŒ–å›¾æ ‡
                                    const icons = {
                                        'æ™¯ç‚¹ç±»å‹': 'bi-tag',
                                        'æ¨èç†ç”±': 'bi-star',
                                        'æ¸¸è§ˆæ—¶é—´': 'bi-clock',
                                        'åœ°å€': 'bi-geo-alt',
                                        'äº¤é€š': 'bi-car-front',
                                        'é—¨ç¥¨': 'bi-ticket',
                                        'å°è´´å£«': 'bi-info-circle'
                                    };
                                    
                                    // ä¸ºæè¿°æ–‡æœ¬æ·»åŠ å›¾æ ‡
                                    for (const [key, icon] of Object.entries(icons)) {
                                        if (desc.includes(key)) {
                                            formattedDesc = formattedDesc.replace(
                                                new RegExp(`(${key})([ï¼š:])`, 'g'), 
                                                `<span class="desc-label"><i class="bi ${icon}"></i> $1</span>$2`
                                            );
                                        }
                                    }
                                    
                                    poiList += `
                                        <li class="poi-item">
                                            <div class="poi-number">${index + 1}</div>
                                            <div class="poi-content">
                                                <div class="poi-name">${name}</div>
                                                <div class="poi-desc">${formattedDesc}</div>
                                            </div>
                                        </li>`;
                                });
                            }
                            
                            currentElement = currentElement.nextElementSibling;
                        }
                        
                        poiList += '</ul>';
                        result += poiList;
                        
                        // å¦‚æœå½“å‰æ˜¯æ—…è¡Œå»ºè®®éƒ¨åˆ†ï¼Œå¤„ç†å®ƒ
                        if (currentElement && currentElement.textContent.includes('æ—…è¡Œå»ºè®®')) {
                            result += `<div class="travel-advice">
                                        <div class="travel-advice-title">
                                            <i class="bi bi-lightbulb"></i>
                                            æ—…è¡Œå»ºè®®
                                        </div>`;
                            
                            // è·å–å»ºè®®åˆ—è¡¨
                            if (currentElement.nextElementSibling && currentElement.nextElementSibling.matches('ul')) {
                                result += '<ul class="travel-advice-list">';
                                
                                const adviceItems = currentElement.nextElementSibling.querySelectorAll('li');
                                adviceItems.forEach(item => {
                                    // å¤„ç†å†’å·åˆ†éš”çš„å»ºè®®é¡¹
                                    const parts = item.textContent.split('ï¼š');
                                    if (parts.length > 1) {
                                        const label = parts[0].trim();
                                        const value = parts.slice(1).join('ï¼š').trim();
                                        
                                        let icon = 'bi-check-circle';
                                        // æ ¹æ®ä¸åŒç±»å‹é€‰æ‹©å›¾æ ‡
                                        if (label.includes('æ—¶é—´')) icon = 'bi-clock';
                                        else if (label.includes('äº¤é€š')) icon = 'bi-car-front';
                                        else if (label.includes('æºå¸¦')) icon = 'bi-backpack';
                                        else if (label.includes('å¤©æ°”')) icon = 'bi-cloud-sun';
                                        else if (label.includes('ä½å®¿')) icon = 'bi-house';
                                        else if (label.includes('é¤é¥®')) icon = 'bi-cup-hot';
                                        else if (label.includes('é¢„ç®—')) icon = 'bi-wallet2';
                                        
                                        result += `
                                            <li class="travel-advice-item">
                                                <i class="bi ${icon}"></i>
                                                <div class="travel-advice-label">${label}</div>
                                                <div class="travel-advice-value">${value}</div>
                                            </li>`;
                                    } else {
                                        // æ²¡æœ‰å†’å·çš„æ™®é€šå»ºè®®é¡¹
                                        result += `
                                            <li class="travel-advice-item">
                                                <i class="bi bi-check-circle"></i>
                                                <div class="travel-advice-value">${item.textContent}</div>
                                            </li>`;
                                    }
                                });
                                
                                result += '</ul>';
                                
                                // ç§»åŠ¨åˆ°å»ºè®®åˆ—è¡¨åçš„å…ƒç´ 
                                currentElement = currentElement.nextElementSibling.nextElementSibling;
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å»ºè®®åˆ—è¡¨ï¼Œç§»åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ 
                                currentElement = currentElement.nextElementSibling;
                            }
                            
                            // æ·»åŠ è¡¥å……è¯´æ˜ï¼ˆå¦‚æœæœ‰ï¼‰
                            if (currentElement && !currentElement.matches('h2, h3')) {
                                result += `<p class="travel-advice-notes">${currentElement.innerHTML}</p>`;
                            }
                            
                            result += '</div>'; // å…³é—­æ—…è¡Œå»ºè®®div
                        }
                    });
                    
                    // å¤„ç†åº•éƒ¨å¯èƒ½å­˜åœ¨çš„é™„åŠ è¯´æ˜
                    const lastParagraph = doc.querySelector('p:last-child');
                    if (lastParagraph && !result.includes(lastParagraph.textContent)) {
                        result += `<p class="travel-route-footer">${lastParagraph.innerHTML}</p>`;
                    }
                    
                    result += '</div>'; // å…³é—­æ—…æ¸¸è·¯çº¿å®¹å™¨
                    return result;
                    */
                } catch (error) {
                    console.error('æ ¼å¼åŒ–æ—…æ¸¸è·¯çº¿å¤±è´¥:', error);
                    return marked.parse(markdownText); // å‡ºé”™æ—¶å›é€€åˆ°æ™®é€šmarkdownæ¸²æŸ“
                }
            }
            
            // å‘é€æŒ‰é’®äº‹ä»¶å¤„ç†
            function handleSendClick() {
                const userMessage = promptInput.value.trim();
                
                if (!userMessage) {
                    return;
                }
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                addMessage(userMessage, true);
                promptInput.value = '';
                
                // åˆ›å»ºå“åº”å…ƒç´ å®¹å™¨ - æ·»åŠ å¸¦æ¨ç†å®¹å™¨çš„åŠ©æ‰‹æ¶ˆæ¯
                const messageContainer = addMessage('', false, true); // ç¬¬ä¸‰ä¸ªå‚æ•°è®¾ä¸ºtrueï¼Œè¡¨ç¤ºéœ€è¦æ¨ç†å®¹å™¨
                
                // ç¡®ä¿æ¨ç†å®¹å™¨å·²æ­£ç¡®åˆ›å»º
                const reasoningContainer = messageContainer.querySelector('.reasoning-container');
                if (reasoningContainer) {
                    console.log("æˆåŠŸåˆ›å»ºæ¨ç†å®¹å™¨");
                    
                    // æ£€æŸ¥æ¨ç†å†…å®¹å…ƒç´ 
                    lastReasoningContainer = reasoningContainer;
                    const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                    if (reasoningContent) {
                        // ç¡®ä¿ä¸æ˜¯æŠ˜å çŠ¶æ€
                        if (reasoningContent.classList.contains('collapsed')) {
                            reasoningContent.classList.remove('collapsed');
                        }
                        console.log("æ¨ç†å†…å®¹å®¹å™¨å·²å‡†å¤‡å¥½æ¥æ”¶æ•°æ®");
                    }
                } else {
                    console.log("æœªèƒ½åˆ›å»ºæ¨ç†å®¹å™¨");
                }
                
                // è·å–åˆ›å»ºçš„å“åº”å…ƒç´ 
                const responseElement = messageContainer.querySelector('#currentResponse');
                
                // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                if (responseElement) {
                    responseElement.innerHTML = '<div class="loading-dots"><div></div><div></div><div></div></div>';
                }
                
                // å¼€å§‹è·å–æµå¼å“åº”
                getStreamingResponse(userMessage);
            }

            // å¤„ç†è¾“å…¥æ¡†å›è½¦äº‹ä»¶
            promptInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendClick();
                }
            });

            // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            sendButton.addEventListener('click', handleSendClick);
            
            // åˆå§‹åŒ–åœ°å›¾
            function initializeMap() {
                console.log("åˆå§‹åŒ–åœ°å›¾åº•å›¾...");
                // åˆ›å»ºiframeä»¥æ˜¾ç¤ºåŸºç¡€åœ°å›¾
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.5s ease';
                
                // æ·»åŠ iframeåˆ°å®¹å™¨
                mapContainer.appendChild(iframe);
                
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'map-loading-indicator';
                loadingIndicator.style.position = 'absolute';
                loadingIndicator.style.top = '50%';
                loadingIndicator.style.left = '50%';
                loadingIndicator.style.transform = 'translate(-50%, -50%)';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½åœ°å›¾...</p>
                `;
                mapContainer.appendChild(loadingIndicator);
                
                // è¯·æ±‚ç®€å•çš„é»˜è®¤åœ°å›¾ï¼Œæ— è·¯çº¿
                fetch('/api/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ routes: [] }) // ç©ºè·¯çº¿ï¼ŒåªåŠ è½½åº•å›¾
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`åœ°å›¾APIé”™è¯¯: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // å½“iframeåŠ è½½å®Œæˆæ—¶ï¼Œæ˜¾ç¤ºiframeå¹¶ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    iframe.onload = function() {
                        iframe.style.opacity = '1';
                        loadingIndicator.style.display = 'none';
                    };
                    
                    // è®¾ç½®iframeæº
                    iframe.src = data.map_url;
                })
                .catch(error => {
                    console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', error);
                    loadingIndicator.style.display = 'none';
                    mapContainer.innerHTML = `
                        <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                            <h5>åŠ è½½åœ°å›¾æ—¶å‡ºé”™</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
            }
            
            // åˆå§‹åŒ–çŸ¥è¯†å›¾è°±
            function initializeGraph() {
                console.log("åˆå§‹åŒ–çŸ¥è¯†å›¾è°±...");
                
                // éšè—å›¾è°±åŠ è½½æŒ‡ç¤ºå™¨ï¼Œä¸é¢„åŠ è½½å›¾è°±
                graphLoading.classList.add('d-none');
                
                // æ˜¾ç¤ºç©ºç™½æç¤º
                graphContainer.innerHTML = `
                    <div class="d-flex justify-content-center align-items-center h-100 text-muted" style="flex-direction: column;">
                        <i class="bi bi-diagram-3 mb-3" style="font-size: 48px; opacity: 0.3;"></i>
                        <p>ä¸AIå¯¹è¯åï¼Œå°†æ˜¾ç¤ºç›¸å…³æ™¯ç‚¹çš„çŸ¥è¯†å›¾è°±</p>
                    </div>
                `;
                
                // ä¸é¢„åŠ è½½çŸ¥è¯†å›¾è°±ï¼Œæ”¹ä¸ºç­‰å¾…ç”¨æˆ·ä¸AIå¯¹è¯åæ˜¾ç¤º
                /*
                // è·å–åŸºç¡€çŸ¥è¯†å›¾è°±æ•°æ®ï¼ˆæ— é«˜äº®ï¼‰
                fetch('/api/graph_data')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`çŸ¥è¯†å›¾è°±APIé”™è¯¯: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(graphData => {
                        // åˆ›å»ºçŸ¥è¯†å›¾è°±
                        renderGraph(graphData);
                        
                        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                        graphLoading.classList.add('d-none');
                    })
                    .catch(error => {
                        console.error('çŸ¥è¯†å›¾è°±åŠ è½½é”™è¯¯:', error);
                        graphLoading.classList.add('d-none');
                        graphContainer.innerHTML = `
                            <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                                <h5>åŠ è½½çŸ¥è¯†å›¾è°±æ—¶å‡ºé”™</h5>
                                <p>${error.message}</p>
                            </div>
                        `;
                    });
                */
            }
            
            // åˆå§‹åŒ–é¡µé¢
            initializeMap();
            initializeGraph();
            
            // æ·»åŠ æ¸²æŸ“è·¯çº¿ä¿¡æ¯åˆ°å“åº”ä¸­çš„å‡½æ•°
            function appendRouteInfoToResponse(routes, theme) {
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) return;
                
                let routeHTML = `
                <div class="travel-suggestion-card mt-4">
                    <div class="travel-suggestion-title" style="display: flex; align-items: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; border-left: 4px solid #FF9800; padding-left: 10px;">
                        <i class="bi bi-map" style="color: #FF9800; margin-right: 8px;"></i> æ¨è${routes.length}å¤©${theme}è·¯çº¿
                    </div>
                `;
                
                // è·å–å¤©æ°”æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
                const weatherData = window.lastWeatherData || null;
                const hasWeatherData = weatherData && weatherData.current;
                const weatherCondition = hasWeatherData ? weatherData.current.condition.text : '';
                const weatherTemp = hasWeatherData ? weatherData.current.temp_c : 25;
                
                routes.forEach((dayRoute, dayIndex) => {
                    routeHTML += `
                    <div class="day-route mb-3">
                        <h5 class="mt-3 mb-3" style="font-size: 16px; font-weight: bold; color: #333;">ç¬¬${dayIndex+1}å¤©è·¯çº¿`;
                
                    // å¦‚æœæœ‰å¤©æ°”æ•°æ®ï¼Œæ·»åŠ å¤©æ°”é¢„æŠ¥æ ‡ç­¾
                    if (hasWeatherData && weatherData.forecast && weatherData.forecast.forecastday && weatherData.forecast.forecastday.length > dayIndex) {
                        const dayForecast = weatherData.forecast.forecastday[dayIndex];
                        const condition = dayForecast.day.condition.text;
                        routeHTML += ` <span style="font-size: 13px; color: #666; font-weight: normal; margin-left: 8px;">
                                    <i class="${getWeatherIcon({code: dayForecast.day.condition.code, is_day: 1})}" style="color: #2196F3;"></i> 
                                    ${condition}, ${dayForecast.day.maxtemp_c}Â°C/${dayForecast.day.mintemp_c}Â°C
                                </span>`;
                    }
                    
                    routeHTML += `</h5>`;
                    
                    dayRoute.forEach((poi, poiIndex) => {
                        // åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„æè¿°ï¼Œä¸åŒ…å«æŠ€æœ¯æ€§çš„å­—æ®µå
                        let poiDesc = '';
                        if (poi.description) {
                            // åªæ˜¾ç¤ºæè¿°å†…å®¹ï¼Œä¸æ˜¾ç¤ºç±»å‹å’Œæ ‡é¢˜ç­‰æŠ€æœ¯å­—æ®µ
                            poiDesc = poi.description.substring(0, 80) + (poi.description.length > 80 ? '...' : '');
                        }
                        
                        // æ ¹æ®å¤©æ°”æ·»åŠ æ™¯ç‚¹æ¨èæ ‡è®°
                        let weatherRecommendation = '';
                        if (hasWeatherData) {
                            // åˆ¤æ–­æ˜¯å¦ä¸ºå®¤å†…æ™¯ç‚¹
                            const isIndoor = poi.indoor === true || 
                                (poi.name && (
                                    poi.name.includes('åšç‰©é¦†') || 
                                    poi.name.includes('ç¾æœ¯é¦†') || 
                                    poi.name.includes('å±•è§ˆ') ||
                                    poi.name.includes('èŒ¶é¦†')
                                ));
                            
                            // æ ¹æ®å¤©æ°”æ¡ä»¶æ·»åŠ æ¨èæ ‡è®°
                            if (weatherCondition.includes('é›¨') && isIndoor) {
                                weatherRecommendation = '<span style="color: #2196F3; font-size: 12px; margin-left: 6px;">(é›¨å¤©æ¨è)</span>';
                            } else if (weatherTemp > 30 && isIndoor) {
                                weatherRecommendation = '<span style="color: #FF9800; font-size: 12px; margin-left: 6px;">(é¿æš‘æ¨è)</span>';
                            } else if (weatherCondition.includes('æ™´') && !isIndoor && poiIndex === 0) {
                                weatherRecommendation = '<span style="color: #4CAF50; font-size: 12px; margin-left: 6px;">(ä»Šæ—¥ä¼˜é€‰)</span>';
                            }
                        }
                        
                        routeHTML += `
                        <div class="poi-item d-flex align-items-start mb-3">
                            <div class="poi-number rounded-circle d-flex justify-content-center align-items-center text-white" style="width: 36px; height: 36px; background-color: #2196F3; flex-shrink: 0; margin-right: 15px; font-weight: bold; font-size: 14px;">${poiIndex+1}</div>
                            <div class="poi-content">
                                <div class="poi-name fw-bold mb-1" style="font-size: 15px; color: #333;">${poi.name}${weatherRecommendation}</div>
                                <div class="poi-desc text-muted small" style="font-size: 13px; color: #666;">${poiDesc}</div>
                            </div>
                        </div>
                        `;
                    });
                    
                    routeHTML += `</div>`;
                });
                
                // æ·»åŠ æ—…è¡Œå»ºè®®éƒ¨åˆ†
                routeHTML += `
                    <div class="travel-tips p-3 mt-2 rounded" style="background-color: #FFF8E1; border-radius: 8px;">
                        <div class="travel-tips-header d-flex align-items-center mb-2">
                            <i class="bi bi-info-circle me-2" style="color: #FF9800;"></i>
                            <span style="font-weight: bold; color: #333; font-size: 15px;">æ—…è¡Œå»ºè®®</span>
                        </div>
                        <p class="mb-1" style="font-size: 14px; color: #555;">æœ€ä½³æ¸¸è§ˆæ—¶é—´ï¼š8:00-17:00</p>
                        <p class="mb-1" style="font-size: 14px; color: #555;">äº¤é€šæ–¹å¼ï¼šå…¬äº¤ã€åœ°é“ã€æ­¥è¡Œæˆ–æ‰“è½¦</p>
                        <p class="mb-0" style="font-size: 14px; color: #555;">å»ºè®®æºå¸¦ï¼šèˆ’é€‚çš„é‹å­ã€ç›¸æœºã€é®é˜³ä¼</p>
                `;
                
                // æ ¹æ®å¤©æ°”æ·»åŠ ç‰¹å®šå»ºè®®
                if (hasWeatherData) {
                    const weatherTip = document.createElement('p');
                    weatherTip.className = 'mb-0';
                    weatherTip.style.fontSize = '14px';
                    weatherTip.style.color = '#555';
                    weatherTip.style.marginTop = '8px';
                    
                    if (weatherCondition.includes('é›¨')) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>å¤©æ°”æé†’ï¼š</strong> é¢„è®¡æœ‰é›¨ï¼Œè¯·å¸¦ä¼å¹¶è€ƒè™‘è°ƒæ•´ä¸ºå‚è§‚å®¤å†…æ™¯ç‚¹ã€‚
                        </p>`;
                    } else if (weatherCondition.includes('æ™´') && weatherTemp > 30) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>å¤©æ°”æé†’ï¼š</strong> å¤©æ°”ç‚çƒ­ï¼Œè¯·åšå¥½é˜²æ™’ï¼Œå¤šè¡¥å……æ°´åˆ†ï¼Œé¿å¼€ä¸­åˆé«˜æ¸©æ—¶æ®µã€‚
                        </p>`;
                    } else if (weatherCondition.includes('å¤šäº‘')) {
                        routeHTML += `
                        <p class="mb-0 mt-2" style="font-size: 14px; color: #555; border-top: 1px dashed #ddd; padding-top: 8px;">
                            <strong>å¤©æ°”æé†’ï¼š</strong> å¤©æ°”é€‚å®œï¼Œå»ºè®®æŒ‰è®¡åˆ’æ¸¸è§ˆï¼Œæ˜¯æ‹ç…§çš„å¥½å¤©æ°”ã€‚
                        </p>`;
                    }
                }
                
                routeHTML += `
                    </div>
                </div>
                `;
                
                // åœ¨å›å¤æœ«å°¾æ·»åŠ è·¯çº¿ä¿¡æ¯
                responseElement.innerHTML += routeHTML;
                
                // æ›´æ–°è·¯çº¿æ¨èï¼ŒåŸºäºå¤©æ°”æƒ…å†µ
                if (window.lastWeatherData) {
                    updateRouteRecommendation(window.lastWeatherData, routes);
                }
            }
            
            // é€šè¿‡å¤©æ°”ä»£ç è·å–å¯¹åº”çš„Bootstrapå›¾æ ‡
            function getWeatherIcon(condition) {
                const code = condition?.code;
                const isDay = condition?.is_day === 1;
                
                // åŸºäºå¤©æ°”ä»£ç å’Œæ—¶é—´è¿”å›å¯¹åº”çš„Bootstrapå›¾æ ‡
                if (code >= 1000 && code <= 1003) { // æ™´/å¤šäº‘
                    return isDay ? 'bi-sun' : 'bi-moon-stars';
                } else if (code >= 1004 && code <= 1009) { // é˜´/å¤šäº‘
                    return 'bi-cloud';
                } else if (code >= 1030 && code <= 1039) { // é›¾/éœ¾
                    return 'bi-cloud-fog';
                } else if (code >= 1063 && code <= 1069) { // å°é›¨
                    return 'bi-cloud-drizzle';
                } else if (code >= 1180 && code <= 1195) { // ä¸­åˆ°å¤§é›¨
                    return 'bi-cloud-rain';
                } else if (code >= 1196 && code <= 1201) { // å†»é›¨
                    return 'bi-cloud-sleet';
                } else if (code >= 1204 && code <= 1237) { // é›ª/å†°é›¹
                    return 'bi-cloud-snow';
                } else if (code >= 1273 && code <= 1282) { // é›·é›¨
                    return 'bi-cloud-lightning-rain';
                }
                
                return 'bi-cloud'; // é»˜è®¤å›¾æ ‡
            }
            
            // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
            function addMessage(text, isUser, showReasoning = false) {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add('message-container');
                
                if (isUser) {
                    messageContainer.classList.add('user-message-container');
                    messageContainer.innerHTML = `
                        <div class="user-message">
                            <div class="message-content">${text}</div>
                        </div>
                        <div class="avatar user-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                    `;
                } else {
                    messageContainer.classList.add('assistant-message-container');
                    
                    // åªæœ‰åœ¨showReasoningä¸ºtrueæ—¶æ‰åˆ›å»ºæ¨ç†å®¹å™¨
                    let reasoningHtml = '';
                    if (showReasoning) {
                        console.log("æ­£åœ¨åˆ›å»ºæ¨ç†å®¹å™¨...");
                        const reasoningContainer = document.createElement('div');
                        reasoningContainer.classList.add('reasoning-container');
                        reasoningContainer.innerHTML = `
                            <div class="reasoning-header">
                                <div class="reasoning-title"><i class="bi bi-lightbulb"></i> æ¨ç†è¿‡ç¨‹</div>
                                <div class="reasoning-toggle"><i class="bi bi-chevron-up"></i></div>
                            </div>
                            <div class="reasoning-content"></div>
                        `;
                        
                        // ä¸ºæ¨ç†å®¹å™¨æ·»åŠ å±•å¼€/æŠ˜å åŠŸèƒ½
                        const reasoningToggle = reasoningContainer.querySelector('.reasoning-toggle');
                        const reasoningContent = reasoningContainer.querySelector('.reasoning-content');
                        
                        if (reasoningToggle && reasoningContent) {
                            console.log("æˆåŠŸæ‰¾åˆ°æ¨ç†å®¹å™¨çš„åˆ‡æ¢æŒ‰é’®å’Œå†…å®¹åŒºåŸŸ");
                            reasoningToggle.addEventListener('click', function() {
                                reasoningContent.classList.toggle('collapsed');
                                const icon = reasoningToggle.querySelector('i');
                                if (icon) {
                                    icon.classList.toggle('bi-chevron-down');
                                    icon.classList.toggle('bi-chevron-up');
                                }
                            });
                        } else {
                            console.log("æœªèƒ½æ‰¾åˆ°æ¨ç†å®¹å™¨çš„åˆ‡æ¢æŒ‰é’®æˆ–å†…å®¹åŒºåŸŸ");
                        }
                        
                        // æ›´æ–°å½“å‰æ¨ç†å®¹å™¨å¼•ç”¨
                        lastReasoningContainer = reasoningContainer;
                        reasoningHtml = reasoningContainer.outerHTML;
                        console.log("æ¨ç†å®¹å™¨HTMLå·²ç”Ÿæˆ");
                    }
                    
                    messageContainer.innerHTML = `
                        <div class="avatar assistant-avatar">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="assistant-message">
                            ${showReasoning ? reasoningHtml : ''}
                            <div class="message-content markdown-content" id="currentResponse">${text}</div>
                        </div>
                    `;
                }
                
                chatContent.appendChild(messageContainer);
                chatContent.scrollTop = chatContent.scrollHeight;
                
                return messageContainer;
            }
            
            // åˆ›å»ºæ¨ç†å®¹å™¨
            function createReasoningContainer(reasoning) {
                const container = document.createElement('div');
                container.className = 'reasoning-container';
                
                const header = document.createElement('div');
                header.className = 'reasoning-header';
                header.innerHTML = '<span>æ¨ç†è¿‡ç¨‹</span><i class="bi bi-chevron-down"></i>';
                
                const content = document.createElement('div');
                content.className = 'reasoning-content markdown-content';
                // ç¡®ä¿reasoningä¸æ˜¯undefined
                content.innerHTML = reasoning ? renderMarkdown(reasoning) : '';
                
                container.appendChild(header);
                container.appendChild(content);
                
                // æ·»åŠ åˆ‡æ¢æ˜¾ç¤º/éšè—çš„åŠŸèƒ½
                header.addEventListener('click', () => {
                    const isHidden = content.style.display === 'none';
                    content.style.display = isHidden ? 'block' : 'none';
                    header.querySelector('i').className = isHidden ? 'bi bi-chevron-up' : 'bi bi-chevron-down';
                });
                
                return container;
            }
            
            // è·å–æµå¼å“åº”
            function getStreamingResponse(userMessage) {
                console.log("å¼€å§‹è·å–LLMæµå¼å“åº”...");
                
                // ç¦ç”¨å‘é€æŒ‰é’®
                sendButton.disabled = true;
                
                // æ‰¾åˆ°å“åº”å’Œæ¨ç†å…ƒç´ 
                const responseElement = document.querySelector('#currentResponse');
                const reasoningElement = lastReasoningContainer ? 
                    lastReasoningContainer.querySelector('.reasoning-content') : null;
                
                if (!responseElement) {
                    console.error("æ‰¾ä¸åˆ°å“åº”å…ƒç´  #currentResponse");
                    return;
                }
                
                // ä¸å†æ˜¾ç¤ºè­¦å‘Šï¼Œåªæ˜¯è®°å½•æ—¥å¿—
                if (!reasoningElement) {
                    console.log("æœªæ‰¾åˆ°æ¨ç†å†…å®¹å…ƒç´ ï¼Œå¯èƒ½æ˜¯æ­£å¸¸æƒ…å†µ");
                }
                
                // åˆ›å»ºEventSourceå¯¹è±¡
                const url = `/api/chat?prompt=${encodeURIComponent(userMessage)}`;
                console.log("è¿æ¥åˆ°SSE API: ", url);
                const eventSource = new EventSource(url);
                
                let currentReasoningText = '';
                let currentResponseText = '';
                
                // ç›‘å¬æ¶ˆæ¯
                eventSource.onmessage = function(event) {
                    console.log("æ”¶åˆ°SSEæ¶ˆæ¯:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        // å¤„ç†æ¨ç†å†…å®¹
                        if (data.type === "reasoning" && data.content) {
                            currentReasoningText += data.content;
                            // å®‰å…¨åœ°å¤„ç†æ¨ç†å†…å®¹å…ƒç´ 
                            if (reasoningElement) {
                                try {
                                    reasoningElement.innerHTML = renderMarkdown(currentReasoningText);
                                    if (reasoningElement.scrollHeight) {
                                        reasoningElement.scrollTop = reasoningElement.scrollHeight;
                                    }
                                    
                                    // ç¡®ä¿æ¨ç†å†…å®¹å®¹å™¨å¯è§
                                    if (reasoningElement.classList.contains('collapsed')) {
                                        reasoningElement.classList.remove('collapsed');
                                    }
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“æ¨ç†å†…å®¹æ—¶å‡ºé”™:", renderError);
                                }
                            }
                        } 
                        // å½“æ”¶åˆ°åˆ†éš”ç¬¦ï¼Œè¡¨ç¤ºæ¨ç†ç»“æŸï¼Œå¼€å§‹ç”Ÿæˆå›ç­”
                        else if (data.type === "separator") {
                            console.log("æ¨ç†ç»“æŸï¼Œå¼€å§‹ç”Ÿæˆå›ç­”");
                            // æ¸…é™¤åŠ è½½åŠ¨ç”»
                            if (responseElement) {
                                responseElement.innerHTML = '';
                            }
                        } 
                        // å¤„ç†å›ç­”å†…å®¹
                        else if (data.type === "content" && data.content) {
                            currentResponseText += data.content;
                            if (responseElement) {
                                try {
                                    responseElement.innerHTML = renderMarkdown(currentResponseText);
                                    if (chatContent && chatContent.scrollHeight) {
                                        chatContent.scrollTop = chatContent.scrollHeight;
                                    }
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“å›ç­”å†…å®¹æ—¶å‡ºé”™:", renderError);
                                    responseElement.textContent = currentResponseText; // å›é€€åˆ°çº¯æ–‡æœ¬
                                }
                            }
                        }
                        // å¤„ç†çŸ¥è¯†å›¾è°±æ•°æ®
                        else if (data.type === "graph_data" && data.content) {
                            console.log("æ”¶åˆ°çŸ¥è¯†å›¾è°±æ•°æ®ï¼Œå‡†å¤‡æ¸²æŸ“");
                            try {
                                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤º
                                graphLoading.classList.remove('d-none');
                                
                                // æ¸²æŸ“æ–°çš„çŸ¥è¯†å›¾è°±
                                renderGraph(data.content);
                                
                                // éšè—åŠ è½½æŒ‡ç¤º
                                graphLoading.classList.add('d-none');
                            } catch (graphError) {
                                console.error("å¤„ç†çŸ¥è¯†å›¾è°±æ•°æ®æ—¶å‡ºé”™:", graphError);
                                graphLoading.classList.add('d-none');
                            }
                        }
                        // å¤„ç†çŠ¶æ€æ¶ˆæ¯
                        else if (data.type === "status" && data.content) {
                            console.log("æ”¶åˆ°çŠ¶æ€æ¶ˆæ¯:", data.content);
                            // å¯ä»¥é€‰æ‹©å°†çŠ¶æ€æ¶ˆæ¯æ·»åŠ åˆ°æ¨ç†å†…å®¹æˆ–å…¶ä»–åœ°æ–¹
                        }
                        // å¤„ç†æµç»“æŸäº‹ä»¶
                        else if (data.type === "end") {
                            console.log("æµå¼å“åº”ç»“æŸ");
                            eventSource.close();
                            sendButton.disabled = false;
                            
                            // æå–åå¥½å¹¶è·å–è·¯çº¿æ•°æ®
                            try {
                                if (typeof window.extractPreferencesAndGetRoutes === 'function') {
                                    window.extractPreferencesAndGetRoutes(userMessage);
                                } else if (typeof extractPreferencesAndGetRoutes === 'function') {
                                    extractPreferencesAndGetRoutes(userMessage);
                                }
                            } catch (routeError) {
                                console.log("æå–åå¥½æˆ–è·å–è·¯çº¿æ—¶å‡ºé”™:", routeError);
                            }
                        }
                    } catch (error) {
                        console.error("è§£æäº‹ä»¶æ•°æ®å‡ºé”™:", error, "åŸå§‹æ•°æ®:", event.data);
                        if (responseElement) {
                            responseElement.innerHTML = "è§£æå“åº”æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚";
                        }
                        eventSource.close();
                        sendButton.disabled = false;
                    }
                };
                
                // è¿æ¥æ‰“å¼€æ—¶çš„å¤„ç†
                eventSource.onopen = function(event) {
                    console.log("SSEè¿æ¥å·²æ‰“å¼€");
                };
                
                // é”™è¯¯å¤„ç†
                eventSource.onerror = function(event) {
                    console.error("EventSourceé”™è¯¯:", event);
                    eventSource.close();
                    
                    if (responseElement) {
                        if (currentResponseText) {
                            // å¦‚æœå·²æœ‰ä¸€äº›å›ç­”ï¼Œä¿ç•™å®ƒ
                            responseElement.innerHTML = renderMarkdown(currentResponseText);
                        } else {
                            // å¦åˆ™æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                            responseElement.innerHTML = renderMarkdown("è¿æ¥åˆ°æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚");
                        }
                    }
                    
                    sendButton.disabled = false;
                };
            }
            
            // æå–åå¥½å¹¶è·å–è·¯çº¿æ•°æ®
            function extractPreferencesAndGetRoutes(userMessage) {
                console.log("æå–ç”¨æˆ·æ—…è¡Œåå¥½...");
                
                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
                mapLoading.classList.remove('d-none');
                graphLoading.classList.remove('d-none');
                
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: userMessage, extract_preferences: true })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`æå–åå¥½APIé”™è¯¯: ${response.status}`);
                    }
                    return response.json();
                })
                .then(preferences => {
                    console.log("æ—…è¡Œåå¥½æå–ç»“æœ: ", preferences);
                    
                    // æ£€æŸ¥æ˜¯å¦è¿”å›äº†æœ‰æ•ˆçš„åå¥½æ•°æ®
                    if (!preferences || !preferences.theme) {
                        console.warn("æœªè·å–åˆ°æœ‰æ•ˆçš„åå¥½æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤åå¥½");
                        preferences = {
                            theme: "æ–‡åŒ–ä½“éªŒ",
                            city: "æ­å·",
                            days: 1,
                            energy: "ä¸­ç­‰"
                        };
                    }
                    
                    // æ˜¾ç¤ºæå–çš„åå¥½ä¿¡æ¯
                    const responseElement = document.getElementById('currentResponse');
                    if (responseElement) {
                        const preferenceHTML = `
                        <div class="alert alert-info mt-2 mb-3" style="background-color: #E3F2FD; border: none; border-radius: 8px; padding: 15px 20px;">
                            <strong>å·²è¯†åˆ«æ‚¨çš„æ—…è¡Œåå¥½ï¼š</strong> 
                            <span class="badge ms-1" style="background-color: #1976D2; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.theme}</span>
                            <span class="badge ms-1" style="background-color: #455A64; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.days}å¤©</span>
                            <span class="badge ms-1" style="background-color: #26C6DA; font-weight: normal; padding: 5px 10px; border-radius: 5px;">${preferences.energy}å¼ºåº¦</span>
                        </div>`;
                        
                        // åœ¨ç°æœ‰å†…å®¹å‰æ·»åŠ åå¥½ä¿¡æ¯
                        responseElement.innerHTML = preferenceHTML + responseElement.innerHTML;
                    }
                
                    // ç”¨æå–çš„åå¥½è°ƒç”¨ç»Ÿä¸€æ•°æ®API
                    return fetch('/api/unified_data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(preferences)
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`ç»Ÿä¸€æ•°æ®APIé”™è¯¯: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("è·å–åˆ°ç»Ÿä¸€æ•°æ®:", data);
                    
                    if (data.error) {
                        console.error("ç»Ÿä¸€æ•°æ®APIé”™è¯¯:", data.error);
                        throw new Error("è·å–è·¯çº¿æ•°æ®å¤±è´¥: " + data.error);
                    }
                    
                    // è·å–ç›®çš„åœ°å¤©æ°”ä¿¡æ¯
                    getDestinationWeather(data.city || "æ­å·");
                    
                    // æ¸²æŸ“åœ°å›¾
                    renderMap(data.routes);
                    
                    // æ¸²æŸ“çŸ¥è¯†å›¾è°±
                    renderGraph(data.graph_data);
                    
                    // æ¸²æŸ“è·¯çº¿ä¿¡æ¯åˆ°å½“å‰å›å¤ä¸­
                    if (data.routes && data.routes.length > 0) {
                        appendRouteInfoToResponse(data.routes, data.theme);
                    }
                    
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    mapLoading.classList.add('d-none');
                    graphLoading.classList.add('d-none');
                })
                .catch(error => {
                    console.error('è·¯çº¿æ•°æ®è·å–é”™è¯¯:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const responseElement = document.getElementById('currentResponse');
                    if (responseElement) {
                        responseElement.innerHTML += `
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle"></i> 
                            è·å–æ—…è¡Œè·¯çº¿å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}
                        </div>`;
                    }
                    
                    // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    mapLoading.classList.add('d-none');
                    graphLoading.classList.add('d-none');
                });
            }
            
            // æ¸²æŸ“åœ°å›¾
            function renderMap(routes) {
                // æ£€æŸ¥è·¯çº¿æ•°æ®
                if (!routes || routes.length === 0) {
                    console.warn("æ²¡æœ‰è·¯çº¿æ•°æ®å¯æ˜¾ç¤º");
                    return; // ä¸æ¸…ç©ºåœ°å›¾ï¼Œä¿ç•™ç°æœ‰åº•å›¾
                }
                
                // æ¸…ç©ºåœ°å›¾å®¹å™¨
                mapContainer.innerHTML = '';
                
                // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'map-loading-indicator';
                loadingIndicator.style.position = 'absolute';
                loadingIndicator.style.top = '50%';
                loadingIndicator.style.left = '50%';
                loadingIndicator.style.transform = 'translate(-50%, -50%)';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2 text-muted">æ­£åœ¨æ›´æ–°åœ°å›¾å’Œè·¯çº¿...</p>
                `;
                mapContainer.appendChild(loadingIndicator);
                
                // åˆ›å»ºiframeä»¥æ˜¾ç¤ºåœ°å›¾
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.opacity = '0';
                iframe.style.transition = 'opacity 0.5s ease';
                
                // æ·»åŠ iframeåˆ°å®¹å™¨
                mapContainer.appendChild(iframe);
                
                // å‘é€è¯·æ±‚ç”Ÿæˆåœ°å›¾
                fetch('/api/map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ routes })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`åœ°å›¾APIé”™è¯¯: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // å½“iframeåŠ è½½å®Œæˆæ—¶ï¼Œæ˜¾ç¤ºiframeå¹¶ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                    iframe.onload = function() {
                        iframe.style.opacity = '1';
                        loadingIndicator.style.display = 'none';
                    };
                    
                    // è®¾ç½®iframeæº
                    iframe.src = data.map_url;
                })
                .catch(error => {
                    console.error('åœ°å›¾æ¸²æŸ“é”™è¯¯:', error);
                    loadingIndicator.style.display = 'none';
                    mapContainer.innerHTML = `
                        <div class="alert alert-danger" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 80%;">
                            <h5>åŠ è½½åœ°å›¾æ—¶å‡ºé”™</h5>
                            <p>${error.message}</p>
                        </div>
                    `;
                });
            }
            
            // æ¸²æŸ“çŸ¥è¯†å›¾è°±
            function renderGraph(graphData) {
                // æ£€æŸ¥å›¾è°±æ•°æ®
                if (!graphData || !graphData.nodes || !graphData.links) {
                    console.warn("æ²¡æœ‰çŸ¥è¯†å›¾è°±æ•°æ®å¯æ˜¾ç¤º");
                    graphContainer.innerHTML = '<div class="d-flex h-100 justify-content-center align-items-center text-muted">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„çŸ¥è¯†å›¾è°±æ•°æ®</div>';
                    return;
                }
                
                // è·å–å½“å‰è§„åˆ’è·¯çº¿ä¸­çš„POI ID
                let routePoiIds = [];
                const routeElements = document.querySelectorAll('.route-item');
                if (routeElements.length > 0) {
                    // æˆ‘ä»¬æœ‰æ´»è·ƒçš„è·¯çº¿ï¼Œæå–æ‰€æœ‰POI ID
                    graphData.nodes.forEach(node => {
                        // åˆå§‹åŒ–èŠ‚ç‚¹çš„åŒ¹é…çŠ¶æ€ï¼Œé»˜è®¤ä¸ºæœªåŒ¹é…
                        node.inRoute = false;
                    });
                    
                    // ä»è·¯çº¿ä¿¡æ¯ä¸­è·å–POIåç§°
                    const poiNameElements = document.querySelectorAll('.route-item ol li');
                    const poiNames = Array.from(poiNameElements).map(el => el.textContent.split(' (')[0].trim());
                    
                    // åŒ¹é…å›¾è°±èŠ‚ç‚¹ä¸è·¯çº¿POI
                    if (poiNames.length > 0) {
                        graphData.nodes.forEach(node => {
                            if (poiNames.includes(node.name)) {
                                node.inRoute = true;
                                routePoiIds.push(node.id);
                            }
                        });
                    }
                }
                
                // æ¸…ç©ºå›¾è°±å®¹å™¨
                graphContainer.innerHTML = '';
                
                // åˆ›å»ºå›¾ä¾‹
                const legend = document.createElement('div');
                legend.className = 'kg-legend';
                
                // è·å–ç±»åˆ«å’Œé¢œè‰²
                const categories = graphData.categories || [];
                let nodeTypes = [];
                
                // å¦‚æœæœ‰æ˜ç¡®çš„ç±»åˆ«å®šä¹‰ï¼Œä½¿ç”¨å®ƒ
                if (categories.length > 0) {
                    nodeTypes = categories;
                } else {
                    // å¦åˆ™ä»èŠ‚ç‚¹ä¸­æå–ç±»åˆ«
                    const typeSet = new Set();
                    graphData.nodes.forEach(node => {
                        if (node.category) typeSet.add(node.category);
                    });
                    nodeTypes = Array.from(typeSet).map(name => ({ name }));
                }
                
                // å®šä¹‰é¢œè‰²
                const typeColors = {
                    'è‡ªç„¶æ™¯è§‚': '#2c7bb6',
                    'å†å²å¤è¿¹': '#d7191c',
                    'æ–‡åŒ–åœºæ‰€': '#fdae61',
                    'è´­ç‰©åŒºåŸŸ': '#abd9e9',
                    'ç¾é£Ÿè¡—åŒº': '#66bd63',
                    'æ™¯ç‚¹': '#42a5f5',
                    'å¤è¿¹': '#ef5350',
                    'æ–‡åŒ–ä½“éªŒ': '#5c6bc0',
                    'å†å²é—å€': '#66bb6a',
                    'åšç‰©é¦†': '#ec407a',
                    'èŒ¶é¦†': '#ffa726',
                    'å†å²å»ºç­‘': '#8d6e63'
                };
                
                // å›¾ä¾‹æ ‡é¢˜
                const title = document.createElement('div');
                title.textContent = 'æ™¯ç‚¹åˆ†ç±»';
                title.style.fontWeight = 'bold';
                title.style.marginBottom = '10px';
                title.style.fontSize = '14px';
                title.style.borderBottom = '2px solid #e1e1e1';
                title.style.paddingBottom = '8px';
                title.style.color = '#1a237e';
                legend.appendChild(title);
                
                // æ·»åŠ èŠ‚ç‚¹ç±»å‹å›¾ä¾‹
                const categoryGrid = document.createElement('div');
                categoryGrid.style.display = 'grid';
                categoryGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
                categoryGrid.style.gap = '8px';
                categoryGrid.style.marginBottom = '10px';
                
                nodeTypes.forEach(type => {
                    const color = type.color || typeColors[type.name] || '#999';
                    
                    const legendItem = document.createElement('div');
                    legendItem.style.display = 'flex';
                    legendItem.style.alignItems = 'center';
                    legendItem.style.padding = '5px 8px';
                    legendItem.style.borderRadius = '4px';
                    legendItem.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                    legendItem.style.border = '1px solid ' + color;
                    legendItem.style.transition = 'all 0.2s ease';
                    
                    legendItem.addEventListener('mouseover', () => {
                        legendItem.style.backgroundColor = color + '22'; // æ·»åŠ é€æ˜åº¦
                        legendItem.style.transform = 'translateY(-2px)';
                        legendItem.style.boxShadow = '0 3px 8px rgba(0,0,0,0.1)';
                    });
                    
                    legendItem.addEventListener('mouseout', () => {
                        legendItem.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
                        legendItem.style.transform = 'translateY(0)';
                        legendItem.style.boxShadow = 'none';
                    });
                    
                    const colorBox = document.createElement('span');
                    colorBox.style.display = 'inline-block';
                    colorBox.style.width = '12px';
                    colorBox.style.height = '12px';
                    colorBox.style.marginRight = '8px';
                    colorBox.style.backgroundColor = color;
                    colorBox.style.borderRadius = '3px';
                    colorBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.2)';
                    
                    legendItem.appendChild(colorBox);
                    legendItem.appendChild(document.createTextNode(type.name));
                    categoryGrid.appendChild(legendItem);
                });
                
                legend.appendChild(categoryGrid);
                
                // æ·»åŠ è·¯çº¿POIå›¾ä¾‹
                if (routePoiIds.length > 0) {
                    const statusTitle = document.createElement('div');
                    statusTitle.textContent = 'èŠ‚ç‚¹çŠ¶æ€';
                    statusTitle.style.fontWeight = 'bold';
                    statusTitle.style.marginTop = '15px';
                    statusTitle.style.marginBottom = '10px';
                    statusTitle.style.fontSize = '14px';
                    statusTitle.style.borderBottom = '2px solid #e1e1e1';
                    statusTitle.style.paddingBottom = '8px';
                    statusTitle.style.color = '#1a237e';
                    legend.appendChild(statusTitle);
                    
                    const routeItem = document.createElement('div');
                    routeItem.style.display = 'flex';
                    routeItem.style.alignItems = 'center';
                    routeItem.style.padding = '5px 8px';
                    routeItem.style.marginBottom = '8px';
                    routeItem.style.borderRadius = '4px';
                    routeItem.style.backgroundColor = 'rgba(255, 87, 34, 0.1)';
                    routeItem.style.border = '1px solid #ff5722';
                    
                    const routeBox = document.createElement('span');
                    routeBox.style.display = 'inline-block';
                    routeBox.style.width = '12px';
                    routeBox.style.height = '12px';
                    routeBox.style.marginRight = '8px';
                    routeBox.style.border = '2px solid #ff5722';
                    routeBox.style.borderRadius = '50%';
                    routeBox.style.backgroundColor = 'rgba(255, 87, 34, 0.3)';
                    routeBox.style.boxShadow = '0 0 8px rgba(255, 87, 34, 0.5)';
                    
                    routeItem.appendChild(routeBox);
                    routeItem.appendChild(document.createTextNode('è·¯çº¿ä¸­çš„æ™¯ç‚¹'));
                    legend.appendChild(routeItem);
                    
                    // æ·»åŠ é€‰ä¸­å›¾ä¾‹
                    const selectedItem = document.createElement('div');
                    selectedItem.style.display = 'flex';
                    selectedItem.style.alignItems = 'center';
                    selectedItem.style.padding = '5px 8px';
                    selectedItem.style.borderRadius = '4px';
                    selectedItem.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                    selectedItem.style.border = '1px solid #333';
                    
                    const selectedBox = document.createElement('span');
                    selectedBox.style.display = 'inline-block';
                    selectedBox.style.width = '12px';
                    selectedBox.style.height = '12px';
                    selectedBox.style.marginRight = '8px';
                    selectedBox.style.border = '2px solid #333';
                    selectedBox.style.borderRadius = '50%';
                    selectedBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                    
                    selectedItem.appendChild(selectedBox);
                    selectedItem.appendChild(document.createTextNode('é€‰ä¸­çš„æ™¯ç‚¹'));
                    legend.appendChild(selectedItem);
                } else {
                    // ç®€åŒ–ç‰ˆï¼šåªæ˜¾ç¤ºé€‰ä¸­å›¾ä¾‹
                    const selectedItem = document.createElement('div');
                    selectedItem.style.display = 'flex';
                    selectedItem.style.alignItems = 'center';
                    selectedItem.style.marginTop = '15px';
                    selectedItem.style.padding = '5px 8px';
                    selectedItem.style.borderRadius = '4px';
                    selectedItem.style.backgroundColor = 'rgba(0, 0, 0, 0.05)';
                    selectedItem.style.border = '1px solid #333';
                    
                    const selectedBox = document.createElement('span');
                    selectedBox.style.display = 'inline-block';
                    selectedBox.style.width = '12px';
                    selectedBox.style.height = '12px';
                    selectedBox.style.marginRight = '8px';
                    selectedBox.style.border = '2px solid #333';
                    selectedBox.style.borderRadius = '50%';
                    selectedBox.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
                    
                    selectedItem.appendChild(selectedBox);
                    selectedItem.appendChild(document.createTextNode('é€‰ä¸­çš„æ™¯ç‚¹'));
                    legend.appendChild(selectedItem);
                }
                
                // æ·»åŠ å›¾ä¾‹åˆ°å®¹å™¨
                graphContainer.appendChild(legend);
                
                // è®¾ç½® SVG å°ºå¯¸
                const width = graphContainer.clientWidth;
                const height = graphContainer.clientHeight;
                
                // åˆ›å»º SVG å…ƒç´ 
                const svg = d3.select(graphContainer)
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("class", "kg-svg");
                
                // åˆ›å»ºå·¥å…·æç¤º
                const tooltip = d3.select(graphContainer)
                    .append("div")
                    .attr("class", "kg-tooltip")
                    .style("position", "absolute")
                    .style("visibility", "hidden")
                    .style("background-color", "rgba(30, 30, 50, 0.9)")
                    .style("color", "white")
                    .style("padding", "10px 15px")
                    .style("border-radius", "6px")
                    .style("box-shadow", "0 4px 15px rgba(0, 0, 0, 0.3)")
                    .style("font-size", "14px")
                    .style("max-width", "300px")
                    .style("backdrop-filter", "blur(5px)")
                    .style("z-index", "1000")
                    .style("pointer-events", "none")
                    .style("opacity", 0);
                
                // æ›´æ–°å·¥å…·æç¤ºå†…å®¹å’Œä½ç½®çš„å‡½æ•°
                function updateTooltip(d, pageX, pageY) {
                    // è·å–èŠ‚ç‚¹çš„ç±»åˆ«ä¿¡æ¯
                    const category = categories.find(c => c.name === d.category);
                    const categoryColor = category ? category.color : typeColors[d.category] || '#999';
                    
                    // åˆ›å»ºå·¥å…·æç¤ºå†…å®¹
                    let html = `
                        <div style="margin-bottom: 8px; border-bottom: 2px solid ${categoryColor}; padding-bottom: 5px;">
                            <span style="font-weight: bold; font-size: 16px;">${d.name}</span>
                        </div>
                        <div style="margin-bottom: 5px;">
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: ${categoryColor}; border-radius: 2px; margin-right: 5px;"></span>
                            <span style="font-weight: 500;">${d.category}</span>
                        </div>
                    `;
                    
                    // æ·»åŠ æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (d.description) {
                        html += `<div style="margin-top: 8px; font-size: 13px; line-height: 1.4;">${d.description.substring(0, 100)}${d.description.length > 100 ? '...' : ''}</div>`;
                    }
                    
                    // æ·»åŠ å±æ€§ä¿¡æ¯ï¼ˆå¦‚è¯„åˆ†ã€ç¥¨ä»·ç­‰ï¼‰
                    html += '<div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 12px;">';
                    
                    if (d.rating) {
                        const stars = 'â˜…'.repeat(Math.round(d.rating)) + 'â˜†'.repeat(5 - Math.round(d.rating));
                        html += `<div><span style="opacity: 0.8;">è¯„åˆ†:</span> <span style="color: #FFC107;">${stars}</span></div>`;
                    }
                    
                    if (d.properties && d.properties.price !== undefined) {
                        html += `<div><span style="opacity: 0.8;">ç¥¨ä»·:</span> ${d.properties.price > 0 ? 'Â¥' + d.properties.price : 'å…è´¹'}</div>`;
                    }
                    
                    if (d.properties && d.properties.visit_time) {
                        html += `<div><span style="opacity: 0.8;">æ¸¸è§ˆæ—¶é—´:</span> ${d.properties.visit_time}åˆ†é’Ÿ</div>`;
                    }
                    
                    html += '</div>';
                    
                    // å¦‚æœæ˜¯åœ¨è·¯çº¿ä¸­çš„POIï¼Œæ·»åŠ æŒ‡ç¤º
                    if (d.inRoute) {
                        html += `<div style="margin-top: 10px; padding: 5px; background-color: rgba(255,87,34,0.2); border-radius: 4px; font-size: 12px; color: #ff5722;">æ­¤æ™¯ç‚¹åœ¨æ‚¨çš„æ—…è¡Œè·¯çº¿ä¸­</div>`;
                    }
                    
                    // æ›´æ–°å·¥å…·æç¤ºå†…å®¹
                    tooltip.html(html);
                    
                    // ç¡®å®šæœ€ä½³å·¥å…·æç¤ºä½ç½®
                    const tooltipWidth = 300; // ä¼°è®¡çš„å®½åº¦
                    const tooltipHeight = 180; // ä¼°è®¡çš„é«˜åº¦
                    
                    // è®¡ç®—ç›¸å¯¹äºè§†å£çš„æœ€ä½³ä½ç½®
                    let left = pageX + 15;
                    let top = pageY - 10;
                    
                    // ç¡®ä¿ä¸è¶…å‡ºå³è¾¹ç•Œ
                    if (left + tooltipWidth > window.innerWidth) {
                        left = pageX - tooltipWidth - 10;
                    }
                    
                    // ç¡®ä¿ä¸è¶…å‡ºåº•éƒ¨è¾¹ç•Œ
                    if (top + tooltipHeight > window.innerHeight) {
                        top = window.innerHeight - tooltipHeight - 10;
                    }
                    
                    // è®¾ç½®ä½ç½®
                    tooltip.style("left", left + "px")
                           .style("top", top + "px");
                }
                
                // åˆ›å»ºç®­å¤´æ ‡è®°
                svg.append("defs").append("marker")
                    .attr("id", "arrowhead")
                    .attr("viewBox", "-0 -5 10 10")
                    .attr("refX", 25) // è°ƒæ•´ç®­å¤´ä½ç½®ï¼Œä½¿å…¶åˆšå¥½åœ¨èŠ‚ç‚¹è¾¹ç¼˜
                    .attr("refY", 0)
                    .attr("orient", "auto")
                    .attr("markerWidth", 8)
                    .attr("markerHeight", 8)
                    .attr("xoverflow", "visible")
                    .append("path")
                    .attr("d", "M 0,-5 L 10 ,0 L 0,5")
                    .attr("fill", "#999")
                    .style("stroke", "none");
                
                // å®šä¹‰ç¼©æ”¾è¡Œä¸º
                const zoom = d3.zoom()
                    .scaleExtent([0.3, 4]) // å…è®¸æ›´å¤§èŒƒå›´çš„ç¼©æ”¾
                    .on("zoom", (event) => {
                        // åº”ç”¨ç¼©æ”¾å’Œå¹³ç§»å˜æ¢
                        container.attr("transform", event.transform);
                    });
                
                // å¯ç”¨ç¼©æ”¾
                svg.call(zoom);
                
                // åˆ›å»ºä¸€ä¸ªå®¹å™¨æ¥åŒ…å«æ‰€æœ‰å…ƒç´ ï¼Œä½¿å®ƒä»¬ä¸€èµ·ç¼©æ”¾å’Œå¹³ç§»
                const container = svg.append("g")
                    .attr("class", "container");
                
                // åˆ›å»ºå…³ç³»è¿çº¿
                const links = container.selectAll(".link")
                    .data(graphData.links)
                    .enter()
                    .append("line")
                    .attr("class", "kg-link")
                    .style("stroke", "#999")
                    .style("stroke-width", d => {
                        // å¼ºè°ƒè¿æ¥è·¯çº¿ä¸­POIçš„è¿çº¿
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (sourceInRoute && targetInRoute) {
                                return Math.max(2, (d.strength || 0.5) * 3);
                            }
                        }
                        return Math.max(1, d.strength * 2 || 1);
                    })
                    .style("stroke-opacity", d => {
                        // å¼±åŒ–éè·¯çº¿ç›¸å…³çš„è¿çº¿
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (!sourceInRoute && !targetInRoute) {
                                return 0.3;
                            }
                        }
                        return 0.6;
                    })
                    .attr("marker-end", "url(#arrowhead)");
                
                // è·å–èŠ‚ç‚¹åŠå¾„çš„å‡½æ•°
                const getNodeRadius = d => {
                    // çªå‡ºè·¯çº¿ä¸Šçš„èŠ‚ç‚¹
                    if (d.inRoute) return 14;
                    
                    // æ ¹æ®èŠ‚ç‚¹æ˜¯å¦è¢«é«˜äº®æˆ–é€‰æ‹©æ¥å†³å®šå¤§å°
                    const baseRadius = d.highlighted ? 12 : 8;
                    
                    // å¯ä»¥æ ¹æ®å…¶ä»–å±æ€§è¿›ä¸€æ­¥è°ƒæ•´å¤§å°ï¼Œæ¯”å¦‚è¯„åˆ†æˆ–é‡è¦æ€§
                    return baseRadius + (d.rating ? (d.rating / 5) * 4 : 0);
                };
                
                // æ·»åŠ å¾„å‘æ¸å˜å®šä¹‰
                const defs = svg.append("defs");
                
                // ä¸ºæ¯ç§ç±»åˆ«åˆ›å»ºå¾„å‘æ¸å˜
                categories.forEach(category => {
                    const gradientId = "gradient-" + category.name.replace(/\s+/g, '-').toLowerCase();
                    
                    // æå–åŸºç¡€é¢œè‰²
                    const baseColor = category.color || typeColors[category.name] || '#999';
                    
                    // è®¡ç®—æ¸å˜çš„äº®è‰²å’Œæš—è‰²ç‰ˆæœ¬
                    const lighterColor = pSBC(0.2, baseColor); // æ›´äº®çš„ç‰ˆæœ¬
                    const darkerColor = pSBC(-0.2, baseColor); // æ›´æš—çš„ç‰ˆæœ¬
                    
                    const gradient = defs.append("radialGradient")
                        .attr("id", gradientId)
                        .attr("cx", "50%")
                        .attr("cy", "50%")
                        .attr("r", "50%")
                        .attr("fx", "50%")
                        .attr("fy", "50%");
                        
                    gradient.append("stop")
                        .attr("offset", "0%")
                        .attr("stop-color", lighterColor);
                        
                    gradient.append("stop")
                        .attr("offset", "100%")
                        .attr("stop-color", darkerColor);
                });
                
                // æ·»åŠ å‘å…‰æ•ˆæœæ»¤é•œ
                const glowFilter = defs.append("filter")
                    .attr("id", "glow")
                    .attr("height", "300%")
                    .attr("width", "300%")
                    .attr("x", "-100%")
                    .attr("y", "-100%");
                    
                glowFilter.append("feGaussianBlur")
                    .attr("stdDeviation", "5")
                    .attr("result", "coloredBlur");
                    
                const glowMerge = glowFilter.append("feMerge");
                glowMerge.append("feMergeNode").attr("in", "coloredBlur");
                glowMerge.append("feMergeNode").attr("in", "SourceGraphic");
                
                // æ·»åŠ æ›´å¼ºçš„å‘å…‰æ•ˆæœ
                const strongGlowFilter = defs.append("filter")
                    .attr("id", "strongGlow")
                    .attr("height", "300%")
                    .attr("width", "300%")
                    .attr("x", "-100%")
                    .attr("y", "-100%");
                    
                strongGlowFilter.append("feGaussianBlur")
                    .attr("stdDeviation", "10")
                    .attr("result", "coloredBlur");
                    
                const strongGlowMerge = strongGlowFilter.append("feMerge");
                strongGlowMerge.append("feMergeNode").attr("in", "coloredBlur");
                strongGlowMerge.append("feMergeNode").attr("in", "SourceGraphic");
                
                // åˆ›å»ºèŠ‚ç‚¹åˆ†ç»„ï¼Œä½¿ç”¨æ¸å˜è‰²å’Œå‘å…‰æ•ˆæœ
                const nodeGroups = container.selectAll(".node")
                    .data(graphData.nodes)
                    .enter()
                    .append("g")
                    .attr("class", d => {
                        let classes = "kg-node";
                        if (d.highlighted) classes += " highlighted";
                        if (d.inRoute) classes += " in-route";
                        return classes;
                    })
                    .style("opacity", d => {
                        // å¼±åŒ–ä¸åœ¨è·¯çº¿ä¸Šçš„èŠ‚ç‚¹
                        if (routePoiIds.length > 0 && !d.inRoute) {
                            return 0.4;
                        }
                        return 1;
                    })
                    .call(d3.drag()
                        .on("start", dragStarted)
                        .on("drag", dragged)
                        .on("end", dragEnded));
                
                // æ·»åŠ èŠ‚ç‚¹åœ†å½¢ï¼Œä½¿ç”¨æ¸å˜å’Œå‘å…‰æ•ˆæœ
                const circles = nodeGroups.append("circle")
                    .attr("r", getNodeRadius)
                    .style("fill", d => {
                        // ç›´æ¥ä½¿ç”¨åˆ†ç±»é¢œè‰²
                        const category = categories.find(c => c.name === d.category);
                        return category ? category.color : typeColors[d.category] || '#999';
                    })
                    .style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return d.highlighted ? "#ff5722" : "rgba(255,255,255,0.8)";
                    })
                    .style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return d.highlighted ? 3 : 1.5;
                    })
                    .style("filter", d => {
                        if (d.inRoute || d.highlighted) return "url(#strongGlow)";
                        return "";
                    });
                
                // æ·»åŠ è„‰åŠ¨åŠ¨ç”»åœ†åœˆ
                nodeGroups.filter(d => d.highlighted || d.inRoute).each(function(d) {
                    const node = d3.select(this);
                    const radius = getNodeRadius(d);
                    
                    // æ·»åŠ è„‰åŠ¨ç¯
                    const pulseRing = node.append("circle")
                        .attr("r", radius + 5)
                        .style("fill", "none")
                        .style("stroke", d.inRoute ? "#ff5722" : "#f44336")
                        .style("stroke-width", 2)
                        .style("stroke-opacity", 0.7)
                        .style("stroke-dasharray", "5,5");
                        
                    // åº”ç”¨è„‰åŠ¨åŠ¨ç”»
                    pulseRing.append("animate")
                        .attr("attributeName", "r")
                        .attr("from", radius + 5)
                        .attr("to", radius + 15)
                        .attr("dur", "1.5s")
                        .attr("repeatCount", "indefinite");
                        
                    pulseRing.append("animate")
                        .attr("attributeName", "stroke-opacity")
                        .attr("from", "0.7")
                        .attr("to", "0")
                        .attr("dur", "1.5s")
                        .attr("repeatCount", "indefinite");
                        
                    // æ·»åŠ ç¬¬äºŒä¸ªé”™å¼€çš„è„‰åŠ¨ç¯ä»¥å¢å¼ºæ•ˆæœ
                    const pulseRing2 = node.append("circle")
                        .attr("r", radius + 10)
                        .style("fill", "none")
                        .style("stroke", d.inRoute ? "#ff5722" : "#f44336")
                        .style("stroke-width", 1.5)
                        .style("stroke-opacity", 0.5)
                        .style("stroke-dasharray", "3,3");
                        
                    pulseRing2.append("animate")
                        .attr("attributeName", "r")
                        .attr("from", radius + 10)
                        .attr("to", radius + 20)
                        .attr("dur", "2s")
                        .attr("repeatCount", "indefinite");
                        
                    pulseRing2.append("animate")
                        .attr("attributeName", "stroke-opacity")
                        .attr("from", "0.5")
                        .attr("to", "0")
                        .attr("dur", "2s")
                        .attr("repeatCount", "indefinite");
                });
                
                // æ·»åŠ æ–‡æœ¬æ ‡ç­¾
                nodeGroups.append("text")
                    .attr("dy", d => -getNodeRadius(d) - 5)
                    .attr("text-anchor", "middle")
                    .style("font-size", d => {
                        // çªå‡ºè·¯çº¿ä¸Šçš„èŠ‚ç‚¹æ ‡ç­¾
                        if (d.inRoute) return "14px";
                        return d.highlighted ? "13px" : "12px";
                    })
                    .style("font-weight", d => {
                        if (d.inRoute || d.highlighted) return "bold";
                        return "normal";
                    })
                    .style("pointer-events", "none")
                    .style("fill", "#333")
                    .style("text-shadow", "0px 0px 3px rgba(255,255,255,0.9), 0px 0px 5px rgba(255,255,255,0.7)")
                    .text(d => d.name);
                
                // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
                nodeGroups.on("click", function(event, d) {
                    event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    
                    // çªå‡ºæ˜¾ç¤ºå½“å‰èŠ‚ç‚¹åŠå…¶è¿æ¥
                    highlightNode(d);
                    
                    // æ˜¾ç¤ºå·¥å…·æç¤º
                    tooltip.transition()
                        .duration(200)
                        .style("visibility", "visible")
                        .style("opacity", 1);
                        
                    // æ›´æ–°å·¥å…·æç¤ºå†…å®¹å’Œä½ç½®
                    updateTooltip(d, event.pageX, event.pageY);
                });
                
                // é¼ æ ‡æ‚¬åœäº‹ä»¶
                nodeGroups.on("mouseover", function(event, d) {
                    d3.select(this).style("cursor", "pointer");
                    
                    // ä»…å½“å°šæœªç‚¹å‡»é€‰æ‹©ä»»ä½•èŠ‚ç‚¹æ—¶ï¼Œæ˜¾ç¤ºå·¥å…·æç¤º
                    if (!currentSelectedNode) {
                        tooltip.transition()
                            .duration(200)
                            .style("visibility", "visible")
                            .style("opacity", 0.9);
                            
                        updateTooltip(d, event.pageX, event.pageY);
                    }
                })
                .on("mouseout", function() {
                    // ä»…å½“å°šæœªç‚¹å‡»é€‰æ‹©ä»»ä½•èŠ‚ç‚¹æ—¶ï¼Œéšè—å·¥å…·æç¤º
                    if (!currentSelectedNode) {
                        tooltip.transition()
                            .duration(500)
                            .style("visibility", "hidden")
                            .style("opacity", 0);
                    }
                });
                
                // ç‚¹å‡»å›¾è°±èƒŒæ™¯æ—¶é‡ç½®è§†å›¾
                svg.on("click", (event) => {
                    if (event.target === svg.node() || event.target.tagName === "rect") {
                        // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„highlightedå±æ€§
                        graphData.nodes.forEach(node => {
                            node.highlighted = false;
                        });
                        
                        // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹æ ·å¼
                        circles.style("stroke", d => {
                            if (d.inRoute) return "#ff5722";
                            return "rgba(255,255,255,0.8)";
                        }).style("stroke-width", d => {
                            if (d.inRoute) return 3;
                            return 1.5;
                        }).style("filter", d => {
                            if (d.inRoute) return "url(#glow)";
                            return "none";
                        });
                        
                        // é‡ç½®æ‰€æœ‰è¿çº¿æ ·å¼
                        links.style("stroke", d => {
                            if (d.inRoute) return "#ff5722";
                            return "rgba(255, 255, 255, 0.2)";
                        }).style("stroke-width", d => {
                            if (d.inRoute) return 2.5;
                            return 1;
                        }).style("opacity", 0.6)
                        .style("filter", "none");
                        
                        // ç§»é™¤è¯¦ç»†ä¿¡æ¯å¡ç‰‡
                        d3.selectAll('.node-info-card').style("transform", "translateY(20px)")
                            .style("opacity", "0");
                        setTimeout(() => d3.selectAll('.node-info-card').remove(), 300);
                        
                        // éšè—æç¤ºæ¡†
                        tooltip.style("visibility", "hidden")
                            .style("opacity", 0);
                    }
                });
                
                // è·Ÿè¸ªå½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                let currentSelectedNode = null;
                
                // é«˜äº®èŠ‚ç‚¹åŠå…¶è¿æ¥
                function highlightNode(d) {
                    // è®¾ç½®å½“å‰é€‰ä¸­çš„èŠ‚ç‚¹
                    currentSelectedNode = d;
                    
                    // è®¡ç®—è¿æ¥å¼ºåº¦
                    const connectionStrength = {};
                    connectionStrength[d.id] = 1.0; // é€‰ä¸­çš„èŠ‚ç‚¹å¼ºåº¦ä¸º1
                    
                    // æ ‡è®°ç›´æ¥è¿æ¥çš„èŠ‚ç‚¹
                    const directConnections = {};
                    links.each(function(l) {
                        if (l.source.id === d.id) {
                            directConnections[l.target.id] = l.strength || 0.5;
                            connectionStrength[l.target.id] = l.strength || 0.5;
                        } else if (l.target.id === d.id) {
                            directConnections[l.source.id] = l.strength || 0.5;
                            connectionStrength[l.source.id] = l.strength || 0.5;
                        }
                    });
                    
                    // é«˜äº®è¿æ¥çš„èŠ‚ç‚¹ï¼Œå¼±åŒ–å…¶ä»–èŠ‚ç‚¹
                    nodeGroups.each(function(n) {
                        const strength = connectionStrength[n.id] || 0;
                        const opacity = strength > 0 ? Math.max(0.3, strength) : 0.15;
                        d3.select(this)
                          .style("opacity", opacity)
                          .style("filter", n.id === d.id ? "url(#strongGlow)" : "");
                    });
                    
                    // é«˜äº®è¿æ¥çš„è¿çº¿ï¼Œå¼±åŒ–å…¶ä»–è¿çº¿
                    links.style("stroke-opacity", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            return Math.min(1, (l.strength || 0.5) + 0.3);
                        }
                        return 0.05;
                    })
                    .style("stroke-width", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            return Math.max(2, (l.strength || 0.5) * 4);
                        }
                        return 1;
                    })
                    .style("stroke", l => {
                        if (l.source.id === d.id || l.target.id === d.id) {
                            // ä½¿ç”¨ç›®æ ‡èŠ‚ç‚¹çš„åˆ†ç±»é¢œè‰²
                            const targetNode = l.source.id === d.id ? l.target : l.source;
                            const category = categories.find(c => c.name === targetNode.category);
                            return category ? category.color : "#999";
                        }
                        return "#999";
                    });
                }
                
                // é‡ç½®é«˜äº®çš„å‡½æ•°
                function resetHighlight() {
                    // é‡ç½®èŠ‚ç‚¹ä¸é€æ˜åº¦
                    nodeGroups.style("opacity", d => {
                        if (routePoiIds.length > 0 && !d.inRoute) {
                            return 0.4;
                        }
                        return 1;
                    })
                    .style("filter", d => {
                        if (d.inRoute || d.highlighted) return "url(#strongGlow)";
                        return "";
                    });
                    
                    // é‡ç½®è¿çº¿ä¸é€æ˜åº¦
                    links.style("stroke-opacity", d => {
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (!sourceInRoute && !targetInRoute) {
                                return 0.3;
                            }
                        }
                        return 0.6;
                    })
                    .style("stroke-width", d => {
                        if (routePoiIds.length > 0) {
                            const sourceInRoute = routePoiIds.includes(d.source.id);
                            const targetInRoute = routePoiIds.includes(d.target.id);
                            if (sourceInRoute && targetInRoute) {
                                return Math.max(2, (d.strength || 0.5) * 3);
                            }
                        }
                        return Math.max(1, (d.strength || 0.5) * 2);
                    })
                    .style("stroke", "#999");
                    
                    // é‡ç½®èŠ‚ç‚¹è¾¹æ¡†æ ·å¼
                    circles.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return d.highlighted ? "#ff5722" : "rgba(255,255,255,0.8)";
                    })
                    .style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return d.highlighted ? 3 : 1.5;
                    });
                }
                
                // åˆ›å»ºåŠ›å¯¼å‘å›¾æ¨¡æ‹Ÿ
                const simulation = d3.forceSimulation(graphData.nodes)
                    .force("link", d3.forceLink(graphData.links)
                        .id(d => d.id)
                        .distance(100))
                    .force("charge", d3.forceManyBody().strength(-300))
                    .force("center", d3.forceCenter(width / 2, height / 2))
                    .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                    .on("tick", ticked);
                
                // æ›´æ–°èŠ‚ç‚¹å’Œè¿çº¿ä½ç½®çš„å‡½æ•°
                function ticked() {
                    links
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => {
                            // è®¡ç®—å‘é‡æ–¹å‘
                            const dx = d.target.x - d.source.x;
                            const dy = d.target.y - d.source.y;
                            const len = Math.sqrt(dx * dx + dy * dy);
                            // è°ƒæ•´ç»ˆç‚¹ä½ç½®ï¼Œä½¿çº¿æ¡ä¸è¦å®Œå…¨åˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹ä¸­å¿ƒ
                            const targetRadius = getNodeRadius(d.target);
                            return d.target.x - (dx / len) * targetRadius;
                        })
                        .attr("y2", d => {
                            // åŒä¸Šï¼Œå¤„ç†yåæ ‡
                            const dx = d.target.x - d.source.x;
                            const dy = d.target.y - d.source.y;
                            const len = Math.sqrt(dx * dx + dy * dy);
                            const targetRadius = getNodeRadius(d.target);
                            return d.target.y - (dy / len) * targetRadius;
                        });
                    
                    nodeGroups.attr("transform", d => `translate(${d.x}, ${d.y})`);
                }
                
                // æ‹–æ‹½ç›¸å…³å‡½æ•°
                function dragStarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }
                
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                
                function dragEnded(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
                
                // æ·»åŠ ç¼©æ”¾æ§åˆ¶æŒ‰é’®
                const zoomControls = document.createElement('div');
                zoomControls.className = 'zoom-controls';
                
                const zoomInBtn = document.createElement('button');
                zoomInBtn.innerHTML = '<i class="bi bi-plus"></i>';
                zoomInBtn.title = "æ”¾å¤§";
                zoomInBtn.onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 1.3);
                
                const zoomOutBtn = document.createElement('button');
                zoomOutBtn.innerHTML = '<i class="bi bi-dash"></i>';
                zoomOutBtn.title = "ç¼©å°";
                zoomOutBtn.onclick = () => svg.transition().duration(300).call(zoom.scaleBy, 0.7);
                
                const resetBtn = document.createElement('button');
                resetBtn.innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
                resetBtn.title = "é‡ç½®è§†å›¾";
                resetBtn.onclick = () => {
                    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
                    resetHighlight();
                    tooltip.style("visibility", "hidden").style("opacity", 0);
                };
                
                zoomControls.appendChild(zoomInBtn);
                zoomControls.appendChild(zoomOutBtn);
                zoomControls.appendChild(resetBtn);
                
                graphContainer.appendChild(zoomControls);
                
                // å°è¯•è‡ªåŠ¨è°ƒæ•´ç¼©æ”¾ä»¥é€‚åˆæ‰€æœ‰èŠ‚ç‚¹
                setTimeout(() => {
                    const bounds = svg.node().getBBox();
                    const dx = bounds.width;
                    const dy = bounds.height;
                    const x = bounds.x + dx / 2;
                    const y = bounds.y + dy / 2;
                    
                    // åªåœ¨èŠ‚ç‚¹è¾ƒå¤šæ—¶è‡ªåŠ¨è°ƒæ•´ç¼©æ”¾
                    if (graphData.nodes.length > 5) {
                        const scale = 0.9 / Math.max(dx / width, dy / height);
                        const translate = [width / 2 - scale * x, height / 2 - scale * y];
                        
                        svg.transition()
                            .duration(750)
                            .call(zoom.transform, d3.zoomIdentity
                                .translate(translate[0], translate[1])
                                .scale(scale));
                    }
                }, 100);

                // æ·»åŠ è¿çº¿åŠ¨ç”»å’Œæµå…‰æ•ˆæœ
                links.each(function(d) {
                    const link = d3.select(this);
                    
                    // ä¸ºè·¯çº¿ä¸­çš„è¿æ¥æ·»åŠ æµå…‰åŠ¨ç”»æ•ˆæœ
                    if (routePoiIds.length > 0) {
                        const sourceInRoute = routePoiIds.includes(d.source.id);
                        const targetInRoute = routePoiIds.includes(d.target.id);
                        
                        if (sourceInRoute && targetInRoute) {
                            // åˆ›å»ºæµå…‰çº¿æ¡
                            const flowLine = container.append("line")
                                .attr("class", "flow-line")
                                .style("stroke", "#ff5722")
                                .style("stroke-width", 2)
                                .style("stroke-linecap", "round")
                                .style("stroke-opacity", 0.6)
                                .style("stroke-dasharray", "5, 10");
                            
                            // æ·»åŠ æµå…‰åŠ¨ç”»
                            const totalLength = Math.sqrt(
                                Math.pow(d.target.x - d.source.x, 2) + 
                                Math.pow(d.target.y - d.source.y, 2)
                            );
                            
                            flowLine.attr("x1", d.source.x)
                                .attr("y1", d.source.y)
                                .attr("x2", d.source.x)
                                .attr("y2", d.source.y)
                                .transition()
                                .duration(2000)
                                .ease(d3.easeLinear)
                                .attr("x2", d.target.x)
                                .attr("y2", d.target.y)
                                .on("end", function repeat() {
                                    d3.select(this)
                                        .attr("x1", d.source.x)
                                        .attr("y1", d.source.y)
                                        .attr("x2", d.source.x)
                                        .attr("y2", d.source.y)
                                        .transition()
                                        .duration(2000)
                                        .ease(d3.easeLinear)
                                        .attr("x2", d.target.x)
                                        .attr("y2", d.target.y)
                                        .on("end", repeat);
                                });
                        }
                    }
                });

                // æ·»åŠ åŠ›å¯¼å‘å›¾æ§åˆ¶é¢æ¿
                const controlPanel = document.createElement('div');
                controlPanel.className = 'graph-control-panel';
                controlPanel.style.position = 'absolute';
                controlPanel.style.bottom = '15px';
                controlPanel.style.left = '15px';
                controlPanel.style.background = 'rgba(255, 255, 255, 0.9)';
                controlPanel.style.padding = '10px';
                controlPanel.style.borderRadius = '8px';
                controlPanel.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.1)';
                controlPanel.style.zIndex = '100';
                controlPanel.style.fontSize = '12px';
                controlPanel.style.backdropFilter = 'blur(5px)';
                controlPanel.style.border = '1px solid rgba(230, 230, 250, 0.7)';
                controlPanel.style.transition = 'all 0.3s ease';
                controlPanel.style.maxWidth = '220px';
                controlPanel.style.opacity = '0.8';

                // æ‚¬åœæ—¶å®Œå…¨æ˜¾ç¤º
                controlPanel.addEventListener('mouseenter', () => {
                    controlPanel.style.opacity = '1';
                });
                controlPanel.addEventListener('mouseleave', () => {
                    controlPanel.style.opacity = '0.8';
                });

                // æ·»åŠ æ§åˆ¶é¢æ¿æ ‡é¢˜
                const panelTitle = document.createElement('div');
                panelTitle.textContent = 'çŸ¥è¯†å›¾è°±è®¾ç½®';
                panelTitle.style.fontWeight = 'bold';
                panelTitle.style.marginBottom = '8px';
                panelTitle.style.color = '#1a237e';
                panelTitle.style.borderBottom = '2px solid #e1e1e1';
                panelTitle.style.paddingBottom = '5px';
                controlPanel.appendChild(panelTitle);

                // æ·»åŠ åŠ›å¯¼å‘æ§åˆ¶
                const forceGroup = document.createElement('div');
                forceGroup.style.marginBottom = '10px';

                // åŠ›å¼ºåº¦æ§åˆ¶
                const forceLabel = document.createElement('label');
                forceLabel.textContent = 'èŠ‚ç‚¹æ’æ–¥åŠ›:';
                forceLabel.style.display = 'block';
                forceLabel.style.marginBottom = '5px';
                forceGroup.appendChild(forceLabel);

                const forceSlider = document.createElement('input');
                forceSlider.type = 'range';
                forceSlider.min = '-800';
                forceSlider.max = '-100';
                forceSlider.value = '-300';
                forceSlider.style.width = '100%';
                forceSlider.addEventListener('input', function() {
                    // å®æ—¶æ›´æ–°åŠ›å¼ºåº¦
                    simulation.force("charge").strength(parseInt(this.value));
                    simulation.alpha(0.3).restart();
                });
                forceGroup.appendChild(forceSlider);

                // è¿æ¥è·ç¦»æ§åˆ¶
                const distanceLabel = document.createElement('label');
                distanceLabel.textContent = 'è¿æ¥è·ç¦»:';
                distanceLabel.style.display = 'block';
                distanceLabel.style.marginTop = '10px';
                distanceLabel.style.marginBottom = '5px';
                forceGroup.appendChild(distanceLabel);

                const distanceSlider = document.createElement('input');
                distanceSlider.type = 'range';
                distanceSlider.min = '50';
                distanceSlider.max = '200';
                distanceSlider.value = '100';
                distanceSlider.style.width = '100%';
                distanceSlider.addEventListener('input', function() {
                    // æ›´æ–°è¿æ¥è·ç¦»
                    simulation.force("link").distance(parseInt(this.value));
                    simulation.alpha(0.3).restart();
                });
                forceGroup.appendChild(distanceSlider);

                controlPanel.appendChild(forceGroup);

                // å¸ƒå±€æ¨¡å¼é€‰æ‹©
                const layoutGroup = document.createElement('div');
                layoutGroup.style.marginBottom = '10px';

                const layoutLabel = document.createElement('label');
                layoutLabel.textContent = 'å¸ƒå±€æ¨¡å¼:';
                layoutLabel.style.display = 'block';
                layoutLabel.style.marginBottom = '5px';
                layoutGroup.appendChild(layoutLabel);

                // åˆ›å»ºå¸ƒå±€é€‰æ‹©ä¸‹æ‹‰èœå•
                const layoutSelect = document.createElement('select');
                layoutSelect.style.width = '100%';
                layoutSelect.style.padding = '3px';
                layoutSelect.style.borderRadius = '4px';
                layoutSelect.style.border = '1px solid #ddd';
                layoutSelect.style.backgroundColor = 'white';

                // æ·»åŠ å¸ƒå±€é€‰é¡¹
                const layouts = [
                    { value: 'force', text: 'è‡ªç”±åŠ›å¯¼å‘' },
                    { value: 'circular', text: 'ç¯å½¢å¸ƒå±€' },
                    { value: 'radial', text: 'è¾å°„çŠ¶å¸ƒå±€' },
                    { value: 'grid', text: 'ç½‘æ ¼å¸ƒå±€' },
                    { value: 'cluster', text: 'æŒ‰ç±»åˆ«èšç±»' }
                ];

                layouts.forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.value;
                    option.textContent = layout.text;
                    layoutSelect.appendChild(option);
                });

                layoutSelect.addEventListener('change', function() {
                    // æ ¹æ®é€‰æ‹©åˆ‡æ¢å¸ƒå±€
                    applyLayout(this.value);
                });

                layoutGroup.appendChild(layoutSelect);
                controlPanel.appendChild(layoutGroup);

                // æ·»åŠ å¸ƒå±€åº”ç”¨å‡½æ•°
                function applyLayout(layoutType) {
                    // åœæ­¢å½“å‰æ¨¡æ‹Ÿ
                    simulation.stop();
                    
                    // æ ¹æ®å¸ƒå±€ç±»å‹é‡æ–°é…ç½®åŠ›
                    switch(layoutType) {
                        case 'force':
                            // é‡è®¾ä¸ºé»˜è®¤åŠ›å¯¼å‘
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(distanceSlider.value)))
                                .force("charge", d3.forceManyBody().strength(parseInt(forceSlider.value)))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5));
                            break;
                            
                        case 'circular':
                            // ç¯å½¢å¸ƒå±€
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(50))
                                .force("charge", d3.forceManyBody().strength(-100))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                                .force("radial", d3.forceRadial(Math.min(width, height) / 3, width / 2, height / 2).strength(0.8));
                            break;
                            
                        case 'radial':
                            // è¾å°„çŠ¶å¸ƒå±€
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(30))
                                .force("charge", d3.forceManyBody().strength(-100))
                                .force("center", d3.forceCenter(width / 2, height / 2))
                                .force("collision", d3.forceCollide().radius(d => getNodeRadius(d) + 5))
                                .force("r", d3.forceRadial(function(d) {
                                    // æ ¹æ®èŠ‚ç‚¹ç±»å‹ç¡®å®šå¾„å‘è·ç¦»
                                    const categoryIndex = categories.findIndex(c => c.name === d.category);
                                    return 100 + categoryIndex * 50;
                                }, width / 2, height / 2).strength(0.8));
                            break;
                            
                        case 'grid':
                            // ç½‘æ ¼å¸ƒå±€
                            const gridSize = Math.ceil(Math.sqrt(graphData.nodes.length));
                            const cellSize = Math.min(width, height) / gridSize;
                            
                            // å°†èŠ‚ç‚¹æ”¾ç½®åœ¨ç½‘æ ¼ä½ç½®
                            graphData.nodes.forEach((node, i) => {
                                const col = i % gridSize;
                                const row = Math.floor(i / gridSize);
                                node.fx = (col + 0.5) * cellSize;
                                node.fy = (row + 0.5) * cellSize;
                            });
                            
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(cellSize).strength(0.1))
                                .force("center", d3.forceCenter(width / 2, height / 2));
                            break;
                            
                        case 'cluster':
                            // æŒ‰ç±»åˆ«èšç±»
                            const uniqueCategories = [...new Set(graphData.nodes.map(d => d.category))];
                            const categoryCount = uniqueCategories.length;
                            const angleStep = 2 * Math.PI / categoryCount;
                            const radius = Math.min(width, height) / 3;
                            
                            // åˆ›å»ºç±»åˆ«åˆ°ä½ç½®çš„æ˜ å°„
                            const categoryPositions = {};
                            uniqueCategories.forEach((category, i) => {
                                const angle = i * angleStep;
                                categoryPositions[category] = {
                                    x: width / 2 + radius * Math.cos(angle),
                                    y: height / 2 + radius * Math.sin(angle)
                                };
                            });
                            
                            // å°†èŠ‚ç‚¹æ”¾ç½®åœ¨ç±»åˆ«ä¸­å¿ƒé™„è¿‘
                            graphData.nodes.forEach(node => {
                                const pos = categoryPositions[node.category];
                                const offset = 50;
                                node.fx = pos.x + (Math.random() - 0.5) * offset;
                                node.fy = pos.y + (Math.random() - 0.5) * offset;
                            });
                            
                            simulation
                                .force("link", d3.forceLink(graphData.links).id(d => d.id).distance(30).strength(0.1))
                                .force("center", d3.forceCenter(width / 2, height / 2));
                            break;
                    }
                    
                    // é‡å¯æ¨¡æ‹Ÿ
                    simulation.alpha(1).restart();
                    
                    // å¦‚æœä½¿ç”¨çš„æ˜¯ç½‘æ ¼æˆ–èšç±»å¸ƒå±€ï¼Œ5ç§’åé‡Šæ”¾å›ºå®šç‚¹
                    if (layoutType === 'grid' || layoutType === 'cluster') {
                        setTimeout(() => {
                            graphData.nodes.forEach(node => {
                                node.fx = null;
                                node.fy = null;
                            });
                            simulation.alpha(0.3).restart();
                        }, 5000);
                    }
                }

                // æ·»åŠ é‡ç½®æŒ‰é’®
                const resetLayoutBtn = document.createElement('button');
                resetLayoutBtn.textContent = 'é‡ç½®èŠ‚ç‚¹ä½ç½®';
                resetLayoutBtn.style.width = '100%';
                resetLayoutBtn.style.padding = '5px';
                resetLayoutBtn.style.marginTop = '10px';
                resetLayoutBtn.style.backgroundColor = '#1976d2';
                resetLayoutBtn.style.color = 'white';
                resetLayoutBtn.style.border = 'none';
                resetLayoutBtn.style.borderRadius = '4px';
                resetLayoutBtn.style.cursor = 'pointer';
                resetLayoutBtn.style.transition = 'background-color 0.2s';

                resetLayoutBtn.addEventListener('mouseenter', () => {
                    resetLayoutBtn.style.backgroundColor = '#1565c0';
                });
                resetLayoutBtn.addEventListener('mouseleave', () => {
                    resetLayoutBtn.style.backgroundColor = '#1976d2';
                });

                resetLayoutBtn.addEventListener('click', () => {
                    // è§£é™¤æ‰€æœ‰å›ºå®šä½ç½®å¹¶é‡å¯æ¨¡æ‹Ÿ
                    graphData.nodes.forEach(node => {
                        node.fx = null;
                        node.fy = null;
                    });
                    
                    // é‡è®¾ä¸ºé»˜è®¤åŠ›å¯¼å‘è®¾ç½®
                    forceSlider.value = '-300';
                    distanceSlider.value = '100';
                    layoutSelect.value = 'force';
                    
                    // é‡å¯æ¨¡æ‹Ÿ
                    applyLayout('force');
                    
                    // é‡ç½®ç¼©æ”¾å’Œå¹³ç§»
                    svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
                });

                controlPanel.appendChild(resetLayoutBtn);

                // æ·»åŠ æ§åˆ¶é¢æ¿åˆ°å›¾è°±å®¹å™¨
                graphContainer.appendChild(controlPanel);
            }
            
            // æ¸²æŸ“è·¯çº¿ä¿¡æ¯
            function renderRouteInfo(routes) {
                // æ£€æŸ¥è·¯çº¿æ•°æ®
                if (!routes || routes.length === 0) {
                    return;
                }
                
                // ç§»é™¤ç°æœ‰çš„è·¯çº¿ä¿¡æ¯é¢æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingPanel = document.querySelector('.route-info-panel');
                if (existingPanel) {
                    existingPanel.remove();
                }
                
                // åˆ›å»ºè·¯çº¿ä¿¡æ¯é¢æ¿
                const routeInfoPanel = document.createElement('div');
                routeInfoPanel.className = 'route-info-panel';
                routeInfoPanel.style.position = 'absolute';
                routeInfoPanel.style.top = '10px';
                routeInfoPanel.style.left = '10px';
                routeInfoPanel.style.background = 'rgba(255,255,255,0.9)';
                routeInfoPanel.style.padding = '15px';
                routeInfoPanel.style.borderRadius = '5px';
                routeInfoPanel.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                routeInfoPanel.style.maxWidth = '300px';
                routeInfoPanel.style.maxHeight = '80%';
                routeInfoPanel.style.overflowY = 'auto';
                routeInfoPanel.style.zIndex = '100';
                
                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('h5');
                title.textContent = 'æ¨èè·¯çº¿';
                title.style.marginTop = '0';
                title.style.marginBottom = '10px';
                title.style.color = '#333';
                routeInfoPanel.appendChild(title);
                
                // æ·»åŠ å…³é—­æŒ‰é’®
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Ã—';
                closeButton.style.position = 'absolute';
                closeButton.style.top = '5px';
                closeButton.style.right = '5px';
                closeButton.style.background = 'none';
                closeButton.style.border = 'none';
                closeButton.style.color = '#999';
                closeButton.style.fontSize = '16px';
                closeButton.style.cursor = 'pointer';
                routeInfoPanel.appendChild(closeButton);
                
                closeButton.addEventListener('click', function() {
                    routeInfoPanel.remove();
                });
                
                // ä¸ºæ¯æ¡è·¯çº¿åˆ›å»ºä¿¡æ¯
                routes.forEach((route, index) => {
                    const routeDiv = document.createElement('div');
                    routeDiv.className = 'route-item';
                    routeDiv.style.marginBottom = '15px';
                    routeDiv.style.paddingBottom = '15px';
                    routeDiv.style.borderBottom = index < routes.length - 1 ? '1px solid #eee' : 'none';
                    
                    // è·¯çº¿åç§°
                    const routeName = document.createElement('h6');
                    routeName.textContent = `è·¯çº¿ ${index + 1}${route.name ? ': ' + route.name : ''}`;
                    routeName.style.margin = '0 0 8px 0';
                    routeName.style.color = '#444';
                    routeDiv.appendChild(routeName);
                    
                    // è·¯çº¿è¯¦æƒ…
                    if (route.description) {
                        const description = document.createElement('p');
                        description.textContent = route.description;
                        description.style.fontSize = '13px';
                        description.style.margin = '0 0 8px 0';
                        description.style.color = '#666';
                        routeDiv.appendChild(description);
                    }
                    
                    // è·¯çº¿ä¿¡æ¯
                    const routeInfo = document.createElement('div');
                    routeInfo.style.fontSize = '12px';
                    routeInfo.style.margin = '8px 0';
                    
                    // æ€»è·ç¦»
                    if (route.total_distance) {
                        const distance = document.createElement('p');
                        distance.style.margin = '2px 0';
                        distance.innerHTML = `<strong>æ€»è·ç¦»:</strong> ${route.total_distance}`;
                        routeInfo.appendChild(distance);
                    }
                    
                    // ä¼°è®¡æ—¶é—´
                    if (route.estimated_time) {
                        const time = document.createElement('p');
                        time.style.margin = '2px 0';
                        time.innerHTML = `<strong>ä¼°è®¡æ—¶é—´:</strong> ${route.estimated_time}`;
                        routeInfo.appendChild(time);
                    }
                    
                    // éš¾åº¦çº§åˆ«
                    if (route.difficulty) {
                        const difficulty = document.createElement('p');
                        difficulty.style.margin = '2px 0';
                        difficulty.innerHTML = `<strong>éš¾åº¦çº§åˆ«:</strong> ${route.difficulty}`;
                        routeInfo.appendChild(difficulty);
                    }
                    
                    routeDiv.appendChild(routeInfo);
                    
                    // è·¯çº¿ç‚¹åˆ—è¡¨
                    if (route.points && route.points.length > 0) {
                        const pointsTitle = document.createElement('p');
                        pointsTitle.textContent = 'æ™¯ç‚¹é¡ºåº:';
                        pointsTitle.style.fontWeight = 'bold';
                        pointsTitle.style.margin = '8px 0 4px 0';
                        pointsTitle.style.fontSize = '12px';
                        routeDiv.appendChild(pointsTitle);
                        
                        const pointsList = document.createElement('ol');
                        pointsList.style.margin = '0';
                        pointsList.style.paddingLeft = '20px';
                        pointsList.style.fontSize = '12px';
                        
                        route.points.forEach(point => {
                            const pointItem = document.createElement('li');
                            pointItem.textContent = point.name;
                            pointItem.style.margin = '2px 0';
                            
                            // å¦‚æœæœ‰åœç•™æ—¶é—´ï¼Œæ·»åŠ 
                            if (point.time) {
                                const timeSpan = document.createElement('span');
                                timeSpan.textContent = ` (${point.time})`;
                                timeSpan.style.color = '#777';
                                pointItem.appendChild(timeSpan);
                            }
                            
                            pointsList.appendChild(pointItem);
                        });
                        
                        routeDiv.appendChild(pointsList);
                    }
                    
                    routeInfoPanel.appendChild(routeDiv);
                });
                
                // æ·»åŠ åˆ°åœ°å›¾å®¹å™¨
                mapContainer.appendChild(routeInfoPanel);
            }

            // ç²’å­æ•ˆæœåˆå§‹åŒ–
            function initializeParticles() {
                const particlesContainer = document.createElement('div');
                particlesContainer.className = 'particles';
                document.querySelector('.graph-container').appendChild(particlesContainer);
                
                const particleCount = 40; // ç²’å­æ•°é‡
                const colors = ['#1976d2', '#64b5f6', '#bbdefb', '#e3f2fd']; // ç²’å­é¢œè‰²
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.position = 'absolute';
                    particle.style.width = Math.random() * 4 + 1 + 'px';
                    particle.style.height = particle.style.width;
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.borderRadius = '50%';
                    particle.style.opacity = Math.random() * 0.5 + 0.2;
                    particle.style.top = Math.random() * 100 + '%';
                    particle.style.left = Math.random() * 100 + '%';
                    
                    // è®¾ç½®åŠ¨ç”»
                    const duration = Math.random() * 20 + 10;
                    const delay = Math.random() * 5;
                    
                    particle.style.animation = `float ${duration}s ${delay}s infinite linear`;
                    
                    particlesContainer.appendChild(particle);
                }
                
                // æ·»åŠ åŠ¨ç”»å…³é”®å¸§
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes float {
                        0% {
                            transform: translateY(0) translateX(0) rotate(0deg);
                            opacity: 0.2;
                        }
                        25% {
                            transform: translateY(-20px) translateX(10px) rotate(90deg);
                            opacity: 0.5;
                        }
                        50% {
                            transform: translateY(-40px) translateX(0) rotate(180deg);
                            opacity: 0.3;
                        }
                        75% {
                            transform: translateY(-20px) translateX(-10px) rotate(270deg);
                            opacity: 0.5;
                        }
                        100% {
                            transform: translateY(0) translateX(0) rotate(360deg);
                            opacity: 0.2;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            // åœ¨å›¾è°±åˆå§‹åŒ–å®Œæˆåè°ƒç”¨ç²’å­æ•ˆæœ
            setTimeout(initializeParticles, 1000);

            // å¢å¼ºèŠ‚ç‚¹ä¿¡æ¯å¡ç‰‡æ•ˆæœ
            const createInfoCard = (node) => {
                // ç§»é™¤ç°æœ‰å¡ç‰‡
                d3.selectAll('.node-info-card').remove();
                
                // åˆ›å»ºæ–°å¡ç‰‡
                const card = document.createElement('div');
                card.className = 'node-info-card';
                card.style.position = 'absolute';
                card.style.top = '70px';
                card.style.right = '15px';
                card.style.width = '280px';
                card.style.background = 'rgba(255, 255, 255, 0.95)';
                card.style.borderRadius = '10px';
                card.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.15)';
                card.style.padding = '0';
                card.style.overflow = 'hidden';
                card.style.zIndex = '200';
                card.style.transition = 'all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1)';
                card.style.transform = 'translateY(20px)';
                card.style.opacity = '0';
                card.style.backdropFilter = 'blur(10px)';
                card.style.border = '1px solid rgba(230, 230, 250, 0.7)';
                
                // åˆ›å»ºé¡¶éƒ¨è‰²å¸¦
                const category = categories.find(c => c.name === node.category);
                const color = category ? category.color : '#999';
                
                const colorBand = document.createElement('div');
                colorBand.style.height = '8px';
                colorBand.style.background = color;
                colorBand.style.width = '100%';
                card.appendChild(colorBand);
                
                // æ·»åŠ å†…å®¹åŒºåŸŸ
                const content = document.createElement('div');
                content.style.padding = '15px';
                card.appendChild(content);
                
                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('h4');
                title.textContent = node.name;
                title.style.margin = '0 0 10px 0';
                title.style.color = '#333';
                title.style.fontSize = '18px';
                title.style.fontWeight = 'bold';
                title.style.borderBottom = '2px solid ' + color;
                title.style.paddingBottom = '8px';
                content.appendChild(title);
                
                // æ·»åŠ ç±»åˆ«æ ‡ç­¾
                const categoryTag = document.createElement('div');
                categoryTag.textContent = node.category;
                categoryTag.style.display = 'inline-block';
                categoryTag.style.padding = '3px 8px';
                categoryTag.style.backgroundColor = color + '22'; // æ·»åŠ é€æ˜åº¦
                categoryTag.style.color = color;
                categoryTag.style.borderRadius = '4px';
                categoryTag.style.fontSize = '12px';
                categoryTag.style.marginBottom = '12px';
                categoryTag.style.border = '1px solid ' + color;
                content.appendChild(categoryTag);
                
                // æ·»åŠ æè¿°
                if (node.description) {
                    const desc = document.createElement('p');
                    desc.textContent = node.description;
                    desc.style.margin = '10px 0';
                    desc.style.fontSize = '14px';
                    desc.style.lineHeight = '1.5';
                    desc.style.color = '#555';
                    content.appendChild(desc);
                }
                
                // åˆ›å»ºè¡¨æ ¼å±•ç¤ºè¯¦ç»†ä¿¡æ¯
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.marginTop = '15px';
                table.style.fontSize = '13px';
                
                // æ·»åŠ è¯„åˆ†
                if (node.rating) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = 'è¯„åˆ†';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    cell1.style.width = '30%';
                    
                    // åˆ›å»ºæ˜Ÿçº§è¯„åˆ†
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                    
                    const stars = document.createElement('div');
                    stars.style.display = 'flex';
                    stars.style.alignItems = 'center';
                    
                    // æ·»åŠ å®å¿ƒæ˜Ÿæ˜Ÿ
                    const fullStars = Math.floor(node.rating);
                    for (let i = 0; i < fullStars; i++) {
                        const star = document.createElement('i');
                        star.className = 'bi bi-star-fill';
                        star.style.color = '#FFC107';
                        star.style.marginRight = '2px';
                        star.style.fontSize = '14px';
                        stars.appendChild(star);
                    }
                    
                    // æ·»åŠ åŠæ˜Ÿï¼ˆå¦‚æœæœ‰ï¼‰
                    if (node.rating % 1 >= 0.5) {
                        const halfStar = document.createElement('i');
                        halfStar.className = 'bi bi-star-half';
                        halfStar.style.color = '#FFC107';
                        halfStar.style.marginRight = '2px';
                        halfStar.style.fontSize = '14px';
                        stars.appendChild(halfStar);
                    }
                    
                    // æ·»åŠ ç©ºæ˜Ÿ
                    const remainingStars = 5 - Math.ceil(node.rating);
                    for (let i = 0; i < remainingStars; i++) {
                        const emptyStar = document.createElement('i');
                        emptyStar.className = 'bi bi-star';
                        emptyStar.style.color = '#FFC107';
                        emptyStar.style.marginRight = '2px';
                        emptyStar.style.fontSize = '14px';
                        stars.appendChild(emptyStar);
                    }
                    
                    // æ·»åŠ æ•°å­—è¯„åˆ†
                    const ratingText = document.createElement('span');
                    ratingText.textContent = ` ${node.rating.toFixed(1)}`;
                    ratingText.style.marginLeft = '5px';
                    ratingText.style.color = '#666';
                    stars.appendChild(ratingText);
                    
                    cell2.appendChild(stars);
                }
                
                // æ·»åŠ ä»·æ ¼ä¿¡æ¯
                if (node.properties && node.properties.price !== undefined) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = 'ä»·æ ¼';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    
                    // æ›´ç›´è§‚çš„ä»·æ ¼å±•ç¤º
                    const price = node.properties.price;
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                    
                    if (price === 0) {
                        cell2.textContent = 'å…è´¹';
                        cell2.style.color = '#4CAF50';
                    } else {
                        cell2.textContent = `Â¥${price}`;
                        cell2.style.color = price > 100 ? '#F44336' : price > 50 ? '#FF9800' : '#4CAF50';
                    }
                }
                
                // æ·»åŠ æ¸¸è§ˆæ—¶é—´
                if (node.properties && node.properties.visit_time !== undefined) {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    
                    cell1.textContent = 'æ¸¸è§ˆæ—¶é—´';
                    cell1.style.padding = '5px 10px 5px 0';
                    cell1.style.borderBottom = '1px solid #eee';
                    cell1.style.fontWeight = 'bold';
                    cell1.style.color = '#666';
                    
                    // æ ¼å¼åŒ–æ—¶é—´å±•ç¤º
                    const minutes = node.properties.visit_time;
                    const hours = Math.floor(minutes / 60);
                    const remainingMinutes = minutes % 60;
                    
                    let timeText = '';
                    if (hours > 0) {
                        timeText += `${hours}å°æ—¶`;
                    }
                    if (remainingMinutes > 0 || hours === 0) {
                        timeText += `${remainingMinutes}åˆ†é’Ÿ`;
                    }
                    
                    cell2.textContent = timeText;
                    cell2.style.padding = '5px 0';
                    cell2.style.borderBottom = '1px solid #eee';
                }
                
                content.appendChild(table);
                
                // æ·»åŠ è¿æ¥å±•ç¤º
                if (graphData.links.some(link => link.source.id === node.id || link.target.id === node.id)) {
                    const connectionsTitle = document.createElement('h5');
                    connectionsTitle.textContent = 'ç›¸å…³æ™¯ç‚¹';
                    connectionsTitle.style.margin = '15px 0 10px 0';
                    connectionsTitle.style.fontSize = '14px';
                    connectionsTitle.style.color = '#333';
                    content.appendChild(connectionsTitle);
                    
                    const connections = document.createElement('div');
                    connections.style.display = 'flex';
                    connections.style.flexWrap = 'wrap';
                    connections.style.gap = '5px';
                    
                    // æŸ¥æ‰¾å…³è”èŠ‚ç‚¹
                    const relatedNodes = new Set();
                    graphData.links.forEach(link => {
                        if (link.source.id === node.id) {
                            relatedNodes.add(link.target.id);
                        } else if (link.target.id === node.id) {
                            relatedNodes.add(link.source.id);
                        }
                    });
                    
                    // ä¸ºæ¯ä¸ªå…³è”èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ ‡ç­¾
                    graphData.nodes.forEach(relatedNode => {
                        if (relatedNodes.has(relatedNode.id)) {
                            const tag = document.createElement('span');
                            tag.textContent = relatedNode.name;
                            tag.style.display = 'inline-block';
                            tag.style.padding = '2px 8px';
                            tag.style.backgroundColor = '#f5f5f5';
                            tag.style.color = '#333';
                            tag.style.borderRadius = '15px';
                            tag.style.fontSize = '12px';
                            tag.style.border = '1px solid #ddd';
                            tag.style.cursor = 'pointer';
                            tag.style.transition = 'all 0.2s ease';
                            
                            // æ‚¬åœæ•ˆæœ
                            tag.addEventListener('mouseenter', () => {
                                tag.style.backgroundColor = '#e0e0e0';
                                tag.style.transform = 'translateY(-2px)';
                                tag.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                            });
                            
                            tag.addEventListener('mouseleave', () => {
                                tag.style.backgroundColor = '#f5f5f5';
                                tag.style.transform = 'translateY(0)';
                                tag.style.boxShadow = 'none';
                            });
                            
                            // ç‚¹å‡»åˆ‡æ¢åˆ°è¯¥èŠ‚ç‚¹
                            tag.addEventListener('click', () => {
                                // ç§»é™¤å½“å‰å¡ç‰‡
                                card.remove();
                                
                                // æŸ¥æ‰¾å¹¶é«˜äº®æ–°èŠ‚ç‚¹
                                const targetNode = nodeGroups.filter(d => d.id === relatedNode.id).node();
                                if (targetNode) {
                                    // è§¦å‘ç‚¹å‡»äº‹ä»¶
                                    d3.select(targetNode).dispatch('click');
                                }
                            });
                            
                            connections.appendChild(tag);
                        }
                    });
                    
                    content.appendChild(connections);
                }
                
                // æ·»åŠ åº•éƒ¨æŒ‰é’®åŒºåŸŸ
                const buttonArea = document.createElement('div');
                buttonArea.style.padding = '10px 15px 15px';
                buttonArea.style.display = 'flex';
                buttonArea.style.justifyContent = 'flex-end';
                buttonArea.style.gap = '10px';
                
                // æ·»åŠ å…³é—­æŒ‰é’®
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'å…³é—­';
                closeBtn.style.padding = '5px 12px';
                closeBtn.style.border = '1px solid #ddd';
                closeBtn.style.borderRadius = '4px';
                closeBtn.style.backgroundColor = '#f5f5f5';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.fontSize = '12px';
                closeBtn.style.transition = 'all 0.2s ease';
                
                closeBtn.addEventListener('mouseenter', () => {
                    closeBtn.style.backgroundColor = '#e0e0e0';
                });
                
                closeBtn.addEventListener('mouseleave', () => {
                    closeBtn.style.backgroundColor = '#f5f5f5';
                });
                
                closeBtn.addEventListener('click', () => {
                    card.style.transform = 'translateY(20px)';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 300);
                });
                
                buttonArea.appendChild(closeBtn);
                card.appendChild(buttonArea);
                
                // æ·»åŠ åˆ°å›¾è°±å®¹å™¨
                graphContainer.appendChild(card);
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    card.style.transform = 'translateY(0)';
                    card.style.opacity = '1';
                }, 10);
                
                return card;
            };

            // æ·»åŠ è¿æ¥é«˜äº®åŠŸèƒ½
            const highlightConnections = (node) => {
                // é‡ç½®æ‰€æœ‰è¿çº¿æ ·å¼
                links.style("stroke", d => {
                    if (d.inRoute) return "#ff5722";
                    return "rgba(255, 255, 255, 0.2)";
                }).style("stroke-width", d => {
                    if (d.inRoute) return 2.5;
                    return 1;
                }).style("opacity", 0.6)
                .style("filter", "none");
                
                // é«˜äº®å½“å‰èŠ‚ç‚¹çš„è¿çº¿
                links.filter(d => d.source.id === node.id || d.target.id === node.id)
                    .style("stroke", "#ffeb3b")
                    .style("stroke-width", 2.5)
                    .style("opacity", 1)
                    .style("filter", "url(#glow)");
                
                // é«˜äº®ç›¸å…³èŠ‚ç‚¹
                graphData.links.forEach(link => {
                    if (link.source.id === node.id) {
                        // ç›®æ ‡èŠ‚ç‚¹æ·»åŠ highlightedå±æ€§
                        const targetNode = graphData.nodes.find(n => n.id === link.target.id);
                        if (targetNode) {
                            targetNode.highlighted = true;
                        }
                    } else if (link.target.id === node.id) {
                        // æºèŠ‚ç‚¹æ·»åŠ highlightedå±æ€§
                        const sourceNode = graphData.nodes.find(n => n.id === link.source.id);
                        if (sourceNode) {
                            sourceNode.highlighted = true;
                        }
                    }
                });
                
                // æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„è§†è§‰æ ·å¼
                circles.style("stroke", d => {
                    if (d.id === node.id) return "#ff5722";
                    if (d.inRoute) return "#ff5722";
                    return d.highlighted ? "#ffeb3b" : "rgba(255,255,255,0.8)";
                }).style("stroke-width", d => {
                    if (d.id === node.id) return 3;
                    if (d.inRoute) return 3;
                    return d.highlighted ? 2.5 : 1.5;
                }).style("filter", d => {
                    if (d.id === node.id) return "url(#strongGlow)";
                    if (d.highlighted) return "url(#glow)";
                    return "none";
                });
            };

            // ç‚¹å‡»ç©ºç™½åŒºåŸŸå–æ¶ˆé«˜äº®
            svg.on("click", (event) => {
                if (event.target === svg.node() || event.target.tagName === "rect") {
                    // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„highlightedå±æ€§
                    graphData.nodes.forEach(node => {
                        node.highlighted = false;
                    });
                    
                    // é‡ç½®æ‰€æœ‰èŠ‚ç‚¹æ ·å¼
                    circles.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return "rgba(255,255,255,0.8)";
                    }).style("stroke-width", d => {
                        if (d.inRoute) return 3;
                        return 1.5;
                    }).style("filter", d => {
                        if (d.inRoute) return "url(#glow)";
                        return "none";
                    });
                    
                    // é‡ç½®æ‰€æœ‰è¿çº¿æ ·å¼
                    links.style("stroke", d => {
                        if (d.inRoute) return "#ff5722";
                        return "rgba(255, 255, 255, 0.2)";
                    }).style("stroke-width", d => {
                        if (d.inRoute) return 2.5;
                        return 1;
                    }).style("opacity", 0.6)
                    .style("filter", "none");
                    
                    // ç§»é™¤è¯¦ç»†ä¿¡æ¯å¡ç‰‡
                    d3.selectAll('.node-info-card').style("transform", "translateY(20px)")
                        .style("opacity", "0");
                    setTimeout(() => d3.selectAll('.node-info-card').remove(), 300);
                    
                    // éšè—æç¤ºæ¡†
                    tooltip.style("visibility", "hidden")
                        .style("opacity", 0);
                }
            });

            // è¾…åŠ©å‡½æ•°ï¼šå®‰å…¨çš„è‰²å½©æ··åˆè®¡ç®—
            function pSBC(p, c0, c1, l) {
                let r, g, b, P, f, t, h, i=parseInt, m=Math.round, a=typeof(c1)=="string";
                if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
                if(!this.pSBCr)this.pSBCr=(d)=>{
                    let n=d.length,x={};
                    if(n>9){
                        [r,g,b,a]=d.match(/\d+/g).map(v=>Number(v));
                        return r>255||g>255||b>255||isNaN(r)||isNaN(g)||isNaN(b)?null:[r,g,b,a/255];
                    }else{
                        if(n==8||n==6||n<4)return null;
                        if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
                        d=i(d.slice(1),16);
                        if(n==9||n==5)return[d>>24&255,d>>16&255,d>>8&255,(d&255)/0.255];
                        return[d>>16,d>>8&255,d&255,1];
                    }
                };
                h=c0.length>9;
                h=a?c1.length>9?true:c1=="c"?!h:false:h;
                f=this.pSBCr(c0);P=p<0;t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1};
                p=P?p*-1:p;P=1-p;
                if(!f||!t)return null;
                if(l)r=m(P*f[0]+p*t[0]),g=m(P*f[1]+p*t[1]),b=m(P*f[2]+p*t[2]);
                else r=m((P*f[0]**2+p*t[0]**2)**0.5),g=m((P*f[1]**2+p*t[1]**2)**0.5),b=m((P*f[2]**2+p*t[2]**2)**0.5);
                a=f[3]*P+t[3]*p;a=a<0?0:a>1?1:a;
                return"rgb"+(a<1?"a(":"(")+r+","+g+","+b+(a<1?","+a:"")+")"
            }

            // æ·»åŠ ä¸€ä¸ªåŠ›å¯¼å‘å›¾æ§åˆ¶é¢æ¿
            const createForceControls = () => {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'graph-controls';
                controlsDiv.style.cssText = `
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    padding: 15px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    color: white;
                    font-size: 14px;
                    z-index: 1000;
                    width: 230px;
                    transition: all 0.3s ease;
                `;
                
                // æ·»åŠ æ ‡é¢˜
                const title = document.createElement('div');
                title.style.cssText = `
                    font-weight: bold;
                    margin-bottom: 15px;
                    font-size: 16px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                title.innerHTML = '<span>åŠ›å¯¼å‘å›¾æ§åˆ¶é¢æ¿</span>';
                
                // æ·»åŠ æœ€å°åŒ–æŒ‰é’®
                const minimizeBtn = document.createElement('button');
                minimizeBtn.innerHTML = 'âˆ’';
                minimizeBtn.style.cssText = `
                    background: none;
                    border: none;
                    color: white;
                    font-size: 16px;
                    cursor: pointer;
                    padding: 0 5px;
                `;
                title.appendChild(minimizeBtn);
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'controls-content';
                contentDiv.style.transition = 'max-height 0.3s ease, opacity 0.3s ease';
                
                // èŠ‚ç‚¹æ’æ–¥åŠ›æ§åˆ¶
                const chargeDiv = document.createElement('div');
                chargeDiv.className = 'control-group';
                chargeDiv.style.cssText = `margin-bottom: 15px;`;
                
                const chargeLabel = document.createElement('label');
                chargeLabel.innerHTML = 'èŠ‚ç‚¹æ’æ–¥åŠ›: <span class="value">-200</span>';
                
                const chargeSlider = document.createElement('input');
                chargeSlider.type = 'range';
                chargeSlider.min = '-500';
                chargeSlider.max = '-50';
                chargeSlider.value = '-200';
                chargeSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                // æ·»åŠ è‡ªå®šä¹‰æ ·å¼
                const sliderStyle = document.createElement('style');
                sliderStyle.textContent = `
                    input[type=range]::-webkit-slider-thumb {
                        -webkit-appearance: none;
                        appearance: none;
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #4CAF50;
                        cursor: pointer;
                        box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    }
                    input[type=range]::-moz-range-thumb {
                        width: 16px;
                        height: 16px;
                        border-radius: 50%;
                        background: #4CAF50;
                        cursor: pointer;
                        box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    }
                `;
                document.head.appendChild(sliderStyle);
                
                chargeDiv.appendChild(chargeLabel);
                chargeDiv.appendChild(chargeSlider);
                
                // è¿æ¥è·ç¦»æ§åˆ¶
                const linkDistDiv = document.createElement('div');
                linkDistDiv.className = 'control-group';
                linkDistDiv.style.cssText = `margin-bottom: 15px;`;
                
                const linkLabel = document.createElement('label');
                linkLabel.innerHTML = 'è¿æ¥è·ç¦»: <span class="value">50</span>';
                
                const linkSlider = document.createElement('input');
                linkSlider.type = 'range';
                linkSlider.min = '10';
                linkSlider.max = '200';
                linkSlider.value = '50';
                linkSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                linkDistDiv.appendChild(linkLabel);
                linkDistDiv.appendChild(linkSlider);
                
                // åŠ›å¼ºåº¦æ§åˆ¶
                const strengthDiv = document.createElement('div');
                strengthDiv.className = 'control-group';
                strengthDiv.style.cssText = `margin-bottom: 15px;`;
                
                const strengthLabel = document.createElement('label');
                strengthLabel.innerHTML = 'åŠ›å¼ºåº¦: <span class="value">0.5</span>';
                
                const strengthSlider = document.createElement('input');
                strengthSlider.type = 'range';
                strengthSlider.min = '0.1';
                strengthSlider.max = '1';
                strengthSlider.value = '0.5';
                strengthSlider.step = '0.1';
                strengthSlider.style.cssText = `
                    width: 100%;
                    margin-top: 8px;
                    background: #444;
                    -webkit-appearance: none;
                    height: 6px;
                    border-radius: 3px;
                    outline: none;
                `;
                
                strengthDiv.appendChild(strengthLabel);
                strengthDiv.appendChild(strengthSlider);
                
                // å¸ƒå±€ç±»å‹é€‰æ‹©
                const layoutDiv = document.createElement('div');
                layoutDiv.className = 'control-group';
                
                const layoutLabel = document.createElement('label');
                layoutLabel.innerHTML = 'å¸ƒå±€ç±»å‹:';
                layoutLabel.style.display = 'block';
                layoutLabel.style.marginBottom = '8px';
                
                const layoutSelect = document.createElement('select');
                layoutSelect.style.cssText = `
                    width: 100%;
                    padding: 5px 8px;
                    background: #333;
                    color: white;
                    border: 1px solid #555;
                    border-radius: 4px;
                    outline: none;
                `;
                
                const layouts = [
                    { value: 'force', label: 'åŠ›å¯¼å‘å›¾' },
                    { value: 'circular', label: 'ç¯å½¢å¸ƒå±€' },
                    { value: 'radial', label: 'æ”¾å°„çŠ¶å¸ƒå±€' },
                    { value: 'grid', label: 'ç½‘æ ¼å¸ƒå±€' }
                ];
                
                layouts.forEach(layout => {
                    const option = document.createElement('option');
                    option.value = layout.value;
                    option.textContent = layout.label;
                    layoutSelect.appendChild(option);
                });
                
                layoutDiv.appendChild(layoutLabel);
                layoutDiv.appendChild(layoutSelect);
                
                // æ·»åŠ äº‹ä»¶å¤„ç†
                chargeSlider.addEventListener('input', function() {
                    const value = this.value;
                    chargeLabel.querySelector('.value').textContent = value;
                    simulation.force('charge').strength(parseInt(value));
                    simulation.alpha(1).restart();
                });
                
                linkSlider.addEventListener('input', function() {
                    const value = this.value;
                    linkLabel.querySelector('.value').textContent = value;
                    simulation.force('link').distance(parseInt(value));
                    simulation.alpha(1).restart();
                });
                
                strengthSlider.addEventListener('input', function() {
                    const value = this.value;
                    strengthLabel.querySelector('.value').textContent = value;
                    simulation.velocityDecay(1 - parseFloat(value));
                    simulation.alpha(1).restart();
                });
                
                layoutSelect.addEventListener('change', function() {
                    const value = this.value;
                    
                    // åœæ­¢å½“å‰æ¨¡æ‹Ÿ
                    simulation.stop();
                    
                    // æ ¹æ®é€‰æ‹©çš„å¸ƒå±€ç±»å‹é‡æ–°é…ç½®åŠ›
                    switch(value) {
                        case 'force':
                            // æ ‡å‡†åŠ›å¯¼å‘å›¾
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value)))
                                .force('center', d3.forceCenter(width / 2, height / 2));
                            break;
                        case 'circular':
                            // ç¯å½¢å¸ƒå±€
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 3))
                                .force('r', d3.forceRadial(Math.min(width, height) / 3, width / 2, height / 2));
                            break;
                        case 'radial':
                            // æ”¾å°„çŠ¶å¸ƒå±€ï¼ˆæ ¹æ®ç±»åˆ«ï¼‰
                            const categories = [...new Set(graphData.nodes.map(d => d.category))];
                            const angleStep = (2 * Math.PI) / categories.length;
                            
                            // ä¸ºæ¯ä¸ªç±»åˆ«åˆ†é…ä¸€ä¸ªè§’åº¦
                            const categoryAngles = {};
                            categories.forEach((cat, i) => {
                                categoryAngles[cat] = i * angleStep;
                            });
                            
                            // åˆ›å»ºå¾„å‘åŠ›ï¼ŒåŸºäºèŠ‚ç‚¹ç±»åˆ«
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 2))
                                .force('r', d3.forceRadial(d => {
                                    // å†…éƒ¨èŠ‚ç‚¹é è¿‘ä¸­å¿ƒï¼Œå¤–éƒ¨èŠ‚ç‚¹é è¿‘è¾¹ç¼˜
                                    return d.degree > 3 ? Math.min(width, height) / 4 : Math.min(width, height) / 2.5;
                                }, width / 2, height / 2))
                                .force('angle', alpha => {
                                    const centerX = width / 2;
                                    const centerY = height / 2;
                                    const strength = 0.1;
                                    
                                    graphData.nodes.forEach(node => {
                                        if (!node.category) return;
                                        
                                        // è®¡ç®—èŠ‚ç‚¹åº”è¯¥çš„è§’åº¦
                                        const targetAngle = categoryAngles[node.category];
                                        const radius = Math.sqrt(Math.pow(node.x - centerX, 2) + Math.pow(node.y - centerY, 2));
                                        
                                        // ç›®æ ‡ä½ç½®
                                        const targetX = centerX + radius * Math.cos(targetAngle);
                                        const targetY = centerY + radius * Math.sin(targetAngle);
                                        
                                        // å‘ç›®æ ‡ä½ç½®ç§»åŠ¨
                                        node.vx += (targetX - node.x) * strength * alpha;
                                        node.vy += (targetY - node.y) * strength * alpha;
                                    });
                                });
                            break;
                        case 'grid':
                            // ç½‘æ ¼å¸ƒå±€
                            const gridSize = Math.ceil(Math.sqrt(graphData.nodes.length));
                            const cellWidth = width / gridSize;
                            const cellHeight = height / gridSize;
                            
                            // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…ç½‘æ ¼ä½ç½®
                            graphData.nodes.forEach((node, i) => {
                                const row = Math.floor(i / gridSize);
                                const col = i % gridSize;
                                node.fx = col * cellWidth + cellWidth / 2;
                                node.fy = row * cellHeight + cellHeight / 2;
                            });
                            
                            // è¾ƒå¼±çš„åŠ›ä»¥å…è®¸æœ‰äº›è‡ªç”±ç§»åŠ¨
                            simulation
                                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(parseInt(linkSlider.value)))
                                .force('charge', d3.forceManyBody().strength(parseInt(chargeSlider.value) / 5));
                            
                            // 2ç§’åé‡Šæ”¾å›ºå®šä½ç½®
                            setTimeout(() => {
                                graphData.nodes.forEach(node => {
                                    node.fx = null;
                                    node.fy = null;
                                });
                            }, 2000);
                            break;
                    }
                    
                    // é‡å¯æ¨¡æ‹Ÿ
                    simulation.alpha(1).restart();
                });
                
                // æœ€å°åŒ–/æœ€å¤§åŒ–åŠŸèƒ½
                minimizeBtn.addEventListener('click', function() {
                    if (contentDiv.style.maxHeight) {
                        // å±•å¼€é¢æ¿
                        contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                        contentDiv.style.opacity = "1";
                        minimizeBtn.innerHTML = 'âˆ’';
                        setTimeout(() => {
                            contentDiv.style.maxHeight = null; // å…è®¸è‡ªåŠ¨é«˜åº¦
                        }, 300);
                    } else {
                        // æŠ˜å é¢æ¿
                        contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                        setTimeout(() => {
                            contentDiv.style.maxHeight = "0px";
                            contentDiv.style.opacity = "0";
                            minimizeBtn.innerHTML = '+';
                        }, 10);
                    }
                });
                
                // æ·»åŠ æ‰€æœ‰æ§ä»¶
                contentDiv.appendChild(chargeDiv);
                contentDiv.appendChild(linkDistDiv);
                contentDiv.appendChild(strengthDiv);
                contentDiv.appendChild(layoutDiv);
                
                controlsDiv.appendChild(title);
                controlsDiv.appendChild(contentDiv);
                
                // æ·»åŠ åˆ°åœ°å›¾å®¹å™¨
                document.querySelector('.map-container').appendChild(controlsDiv);
                
                // åœ¨çª—å£è°ƒæ•´å¤§å°æ—¶é‡æ–°å¸ƒå±€
                window.addEventListener('resize', () => {
                    width = window.innerWidth;
                    height = window.innerHeight;
                    simulation.force('center', d3.forceCenter(width / 2, height / 2));
                    simulation.alpha(1).restart();
                });
            };

            // åœ¨æ¸²æŸ“å›¾å®Œæˆåè°ƒç”¨åˆ›å»ºæ§åˆ¶é¢æ¿
            const originalRenderGraph = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraph(data);
                createForceControls();
                return result;
            };

            // æ·»åŠ æœç´¢åŠŸèƒ½
            const createSearchFunction = () => {
                const searchContainer = document.createElement('div');
                searchContainer.className = 'search-container';
                searchContainer.style.cssText = `
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    z-index: 1000;
                    width: 250px;
                    transition: all 0.3s ease;
                `;
                
                // æœç´¢è¾“å…¥æ¡†
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'æœç´¢èŠ‚ç‚¹...';
                searchInput.style.cssText = `
                    width: 100%;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 30px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    color: white;
                    font-size: 14px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                    outline: none;
                    transition: all 0.3s ease;
                `;
                
                // æœç´¢ç»“æœå®¹å™¨
                const resultsContainer = document.createElement('div');
                resultsContainer.className = 'search-results';
                resultsContainer.style.cssText = `
                    margin-top: 10px;
                    max-height: 0;
                    overflow-y: auto;
                    background: rgba(30, 30, 50, 0.9);
                    backdrop-filter: blur(5px);
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                    opacity: 0;
                    transition: all 0.3s ease;
                `;
                
                // æ·»åŠ åˆ°DOM
                searchContainer.appendChild(searchInput);
                searchContainer.appendChild(resultsContainer);
                document.querySelector('.map-container').appendChild(searchContainer);
                
                // æœç´¢åŠŸèƒ½
                searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase().trim();
                    
                    // æ¸…ç©ºç»“æœå®¹å™¨
                    resultsContainer.innerHTML = '';
                    
                    if (query.length < 2) {
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                        return;
                    }
                    
                    // æŸ¥æ‰¾åŒ¹é…çš„èŠ‚ç‚¹
                    const matchedNodes = graphData.nodes.filter(node => 
                        node.name.toLowerCase().includes(query) || 
                        (node.description && node.description.toLowerCase().includes(query))
                    );
                    
                    if (matchedNodes.length === 0) {
                        resultsContainer.innerHTML = '<div class="no-results" style="padding: 10px 15px; color: #ccc;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹</div>';
                    } else {
                        // åˆ›å»ºç»“æœåˆ—è¡¨
                        matchedNodes.slice(0, 10).forEach(node => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item';
                            resultItem.style.cssText = `
                                padding: 10px 15px;
                                cursor: pointer;
                                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                                transition: background 0.2s;
                            `;
                            
                            // æ·»åŠ åˆ†ç±»é¢œè‰²æ ‡è®°
                            const categoryColor = getCategoryColor(node.category);
                            resultItem.innerHTML = `
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 12px; height: 12px; border-radius: 50%; background: ${categoryColor}; margin-right: 10px;"></div>
                                    <div>
                                        <div style="font-weight: bold;">${node.name}</div>
                                        ${node.description ? `<div style="font-size: 12px; color: #ccc; margin-top: 3px;">${node.description.substring(0, 60)}${node.description.length > 60 ? '...' : ''}</div>` : ''}
                                    </div>
                                </div>
                            `;
                            
                            // é¼ æ ‡æ‚¬åœæ•ˆæœ
                            resultItem.addEventListener('mouseover', () => {
                                resultItem.style.background = 'rgba(255, 255, 255, 0.1)';
                            });
                            
                            resultItem.addEventListener('mouseout', () => {
                                resultItem.style.background = 'transparent';
                            });
                            
                            // ç‚¹å‡»è·³è½¬åˆ°èŠ‚ç‚¹
                            resultItem.addEventListener('click', () => {
                                // æ‰¾åˆ°ç›¸åº”çš„èŠ‚ç‚¹DOMå…ƒç´ 
                                const nodeElement = d3.select(`circle[data-id="${node.id}"]`);
                                if (!nodeElement.empty()) {
                                    // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                                    d3.selectAll('.node circle').classed('highlighted', false);
                                    
                                    // é«˜äº®å½“å‰èŠ‚ç‚¹
                                    nodeElement.classed('highlighted', true);
                                    
                                    // è®¡ç®—ç¼©æ”¾å¹¶å±…ä¸­
                                    const currentScale = d3.zoomTransform(svg.node()).k;
                                    const targetX = node.x * currentScale;
                                    const targetY = node.y * currentScale;
                                    
                                    // å¹³æ»‘è¿‡æ¸¡åˆ°ç›®æ ‡ä½ç½®
                                    svg.transition()
                                        .duration(750)
                                        .call(
                                            zoom.transform,
                                            d3.zoomIdentity
                                                .translate(width / 2 - targetX, height / 2 - targetY)
                                                .scale(currentScale * 1.5) // ç¨å¾®æ”¾å¤§
                                        );
                                        
                                    // æ˜¾ç¤ºèŠ‚ç‚¹ä¿¡æ¯
                                    showNodeInfo(node);
                                    
                                    // æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Œçªå‡ºæ˜¾ç¤ºæ‰¾åˆ°çš„èŠ‚ç‚¹
                                    const pulseCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                                    pulseCircle.setAttribute('cx', node.x);
                                    pulseCircle.setAttribute('cy', node.y);
                                    pulseCircle.setAttribute('r', 20);
                                    pulseCircle.setAttribute('fill', 'none');
                                    pulseCircle.setAttribute('stroke', '#fff');
                                    pulseCircle.setAttribute('stroke-width', '3');
                                    pulseCircle.setAttribute('opacity', '1');
                                    
                                    // æ·»åŠ åˆ°SVG
                                    svg.node().appendChild(pulseCircle);
                                    
                                    // åŠ¨ç”»æ•ˆæœ
                                    d3.select(pulseCircle)
                                        .transition()
                                        .duration(1000)
                                        .attr('r', 40)
                                        .attr('opacity', 0)
                                        .remove();
                                        
                                    // æ¸…ç©ºæœç´¢æ¡†
                                    searchInput.value = '';
                                    resultsContainer.style.maxHeight = '0';
                                    resultsContainer.style.opacity = '0';
                                }
                            });
                            
                            resultsContainer.appendChild(resultItem);
                        });
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    resultsContainer.style.maxHeight = '300px';
                    resultsContainer.style.opacity = '1';
                });
                
                // ç‚¹å‡»å¤–éƒ¨æ—¶éšè—ç»“æœ
                document.addEventListener('click', function(e) {
                    if (!searchContainer.contains(e.target)) {
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                    }
                });
                
                // æŒ‰ESCé”®æ¸…ç©ºæœç´¢
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        resultsContainer.style.maxHeight = '0';
                        resultsContainer.style.opacity = '0';
                    }
                });
                
                // ç„¦ç‚¹æ ·å¼
                searchInput.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 2px rgba(77, 144, 254, 0.5), 0 4px 15px rgba(0, 0, 0, 0.2)';
                });
                
                searchInput.addEventListener('blur', function() {
                    this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                });
            };

            // åœ¨æ¸²æŸ“å›¾å®Œæˆåè°ƒç”¨åˆ›å»ºæœç´¢åŠŸèƒ½
            const originalRenderGraphWithControls = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraphWithControls(data);
                createSearchFunction();
                return result;
            };

            // æ·»åŠ å¯¼å‡ºå›¾ç‰‡åŠŸèƒ½
            const createExportButton = () => {
                const exportButton = document.createElement('button');
                exportButton.className = 'export-button';
                exportButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    å¯¼å‡ºå›¾ç‰‡
                `;
                exportButton.style.cssText = `
                    position: absolute;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 15px;
                    border: none;
                    border-radius: 30px;
                    background: rgba(30, 30, 50, 0.8);
                    backdrop-filter: blur(5px);
                    color: white;
                    font-size: 14px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                // æ‚¬åœæ•ˆæœ
                exportButton.addEventListener('mouseover', () => {
                    exportButton.style.background = 'rgba(40, 40, 70, 0.9)';
                    exportButton.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.3)';
                });
                
                exportButton.addEventListener('mouseout', () => {
                    exportButton.style.background = 'rgba(30, 30, 50, 0.8)';
                    exportButton.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                });
                
                // ç‚¹å‡»å¯¼å‡ºå›¾ç‰‡
                exportButton.addEventListener('click', () => {
                    // åˆ›å»ºåŠ è½½æç¤º
                    const loadingToast = document.createElement('div');
                    loadingToast.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 15px 25px;
                        border-radius: 8px;
                        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                        z-index: 2000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    `;
                    
                    const spinner = document.createElement('div');
                    spinner.style.cssText = `
                        width: 20px;
                        height: 20px;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                        border-radius: 50%;
                        border-top-color: white;
                        animation: spin 1s linear infinite;
                    `;
                    
                    const loadingText = document.createElement('div');
                    loadingText.textContent = 'æ­£åœ¨å‡†å¤‡å›¾ç‰‡...';
                    
                    loadingToast.appendChild(spinner);
                    loadingToast.appendChild(loadingText);
                    document.body.appendChild(loadingToast);
                    
                    // æ·»åŠ spinneråŠ¨ç”»
                    const style = document.createElement('style');
                    style.textContent = `
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                    
                    // ä½¿ç”¨html2canvasåº“å¯¼å‡ºSVGä¸ºå›¾ç‰‡
                    setTimeout(() => {
                        // ä½¿ç”¨svg-crowbaræŠ€æœ¯å¯¼å‡ºSVG
                        const svgElement = document.querySelector('svg');
                        const svgData = new XMLSerializer().serializeToString(svgElement);
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºSVGå¤§å°
                        const svgRect = svgElement.getBoundingClientRect();
                        canvas.width = svgRect.width;
                        canvas.height = svgRect.height;
                        
                        // åˆ›å»ºå›¾åƒ
                        const img = new Image();
                        img.onload = function() {
                            // å¡«å……èƒŒæ™¯
                            ctx.fillStyle = '#121220';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // ç»˜åˆ¶SVG
                            ctx.drawImage(img, 0, 0);
                            
                            // è½¬æ¢ä¸ºData URLå¹¶ä¸‹è½½
                            const dataUrl = canvas.toDataURL('image/png');
                            
                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const downloadLink = document.createElement('a');
                            downloadLink.href = dataUrl;
                            downloadLink.download = 'çŸ¥è¯†å›¾è°±_' + new Date().toISOString().slice(0, 10) + '.png';
                            
                            // ç§»é™¤åŠ è½½æç¤º
                            document.body.removeChild(loadingToast);
                            
                            // æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½
                            downloadLink.click();
                        };
                        
                        // SVGæ•°æ®è½¬æ¢ä¸ºBase64
                        const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                        const url = URL.createObjectURL(svgBlob);
                        img.src = url;
                    }, 500);
                });
                
                document.querySelector('.map-container').appendChild(exportButton);
            };

            // ä¿®æ”¹renderGraphå‡½æ•°è°ƒç”¨æ¥æ·»åŠ å¯¼å‡ºæŒ‰é’®
            const originalRenderGraphWithExport = renderGraph;
            renderGraph = function(data) {
                const result = originalRenderGraphWithExport(data);
                createExportButton();
                return result;
            };

            // æ—…è¡Œå»ºè®®å¡ç‰‡å‡½æ•°
            function createTravelSuggestionCard(suggestion) {
                const card = document.createElement('div');
                card.className = 'travel-suggestion-card';
                
                const title = document.createElement('div');
                title.className = 'travel-suggestion-title';
                title.innerHTML = '<i class="bi bi-map"></i>æ—…è¡Œå»ºè®®';
                card.appendChild(title);
                
                // å¦‚æœæœ‰å…´è¶£ç‚¹
                if (suggestion.pois && suggestion.pois.length > 0) {
                    const poiTitle = document.createElement('div');
                    poiTitle.textContent = 'æ¨èæ™¯ç‚¹:';
                    poiTitle.style.fontWeight = '600';
                    poiTitle.style.marginTop = '0.8rem';
                    card.appendChild(poiTitle);
                    
                    const poiList = document.createElement('ul');
                    poiList.className = 'poi-list';
                    
                    suggestion.pois.forEach(poi => {
                        const poiItem = document.createElement('li');
                        poiItem.className = 'poi-item';
                        
                        const poiIcon = document.createElement('div');
                        poiIcon.className = 'poi-icon';
                        poiIcon.style.backgroundColor = getCategoryColor(poi.category);
                        poiIcon.textContent = poi.category.charAt(0);
                        
                        const poiInfo = document.createElement('div');
                        poiInfo.className = 'poi-info';
                        
                        const poiName = document.createElement('div');
                        poiName.className = 'poi-name';
                        poiName.textContent = poi.name;
                        
                        const poiDesc = document.createElement('div');
                        poiDesc.className = 'poi-desc';
                        poiDesc.textContent = poi.description || '';
                        
                        poiInfo.appendChild(poiName);
                        poiInfo.appendChild(poiDesc);
                        poiItem.appendChild(poiIcon);
                        poiItem.appendChild(poiInfo);
                        poiList.appendChild(poiItem);
                    });
                    
                    card.appendChild(poiList);
                }
                
                // å¦‚æœæœ‰æ—…è¡Œæç¤º
                if (suggestion.tips && suggestion.tips.length > 0) {
                    const tipsContainer = document.createElement('div');
                    tipsContainer.className = 'travel-tips';
                    
                    const tipsTitle = document.createElement('div');
                    tipsTitle.className = 'travel-tips-title';
                    tipsTitle.innerHTML = '<i class="bi bi-lightbulb"></i>æ—…è¡Œè´´å£«';
                    tipsContainer.appendChild(tipsTitle);
                    
                    const tipsList = document.createElement('ul');
                    tipsList.style.paddingLeft = '1.5rem';
                    tipsList.style.marginTop = '0.5rem';
                    
                    suggestion.tips.forEach(tip => {
                        const tipItem = document.createElement('li');
                        tipItem.textContent = tip;
                        tipsList.appendChild(tipItem);
                    });
                    
                    tipsContainer.appendChild(tipsList);
                    card.appendChild(tipsContainer);
                }
                
                return card;
            }

            // æ ¹æ®åˆ†ç±»è·å–é¢œè‰²
            function getCategoryColor(category) {
                const colors = {
                    'è‡ªç„¶æ™¯è§‚': '#2c7bb6',
                    'å†å²å¤è¿¹': '#d7191c',
                    'æ–‡åŒ–åœºæ‰€': '#fdae61',
                    'è´­ç‰©åŒºåŸŸ': '#abd9e9',
                    'ç¾é£Ÿè¡—åŒº': '#66bd63'
                };
                
                return colors[category] || '#888888';
            }

            // è·å–ç›®çš„åœ°å¤©æ°”ä¿¡æ¯å¹¶æ˜¾ç¤º
            function getDestinationWeather(location) {
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) {
                    console.error("æ— æ³•æ‰¾åˆ°responseElementå…ƒç´ ");
                    return;
                }
                
                console.log("å¼€å§‹è·å–å¤©æ°”ä¿¡æ¯: " + location);
                
                // ç›´æ¥æ·»åŠ ä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨ï¼Œç¡®è®¤å‡½æ•°è¢«è°ƒç”¨
                const weatherLoadingHTML = `
                <div class="weather-loading mt-3 mb-3 p-3 text-center" style="background-color: #f8f9fa; border-radius: 8px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">åŠ è½½å¤©æ°”æ•°æ®...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½ ${location} çš„å¤©æ°”æ•°æ®...</p>
                </div>`;
                
                // å…ˆæ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
                if (responseElement.innerHTML.indexOf('travel-suggestion-card') > -1) {
                    responseElement.innerHTML = responseElement.innerHTML.replace(
                        '<div class="travel-suggestion-card mt-4">',
                        weatherLoadingHTML + '<div class="travel-suggestion-card mt-4">'
                    );
                } else {
                    responseElement.innerHTML += weatherLoadingHTML;
                }
                
                // è°ƒç”¨åç«¯å¤©æ°”API
                const weatherApiUrl = `/api/weather?location=${encodeURIComponent(location)}`;
                console.log("å¤©æ°”API URL: " + weatherApiUrl);
                
                fetch(weatherApiUrl)
                    .then(response => {
                        console.log("å¤©æ°”APIå“åº”çŠ¶æ€: ", response.status);
                        if (!response.ok) {
                            throw new Error(`å¤©æ°”APIé”™è¯¯: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(weatherData => {
                        console.log("è·å–åˆ°å¤©æ°”æ•°æ®:", weatherData);
                        
                        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                        const weatherLoading = responseElement.querySelector('.weather-loading');
                        if (weatherLoading) {
                            weatherLoading.remove();
                        }
                        
                        // æ·»åŠ å¤©æ°”ä¿¡æ¯åˆ°å“åº”ä¸­
                        const weatherHTML = createWeatherWidget(weatherData);
                        
                        // æ·»åŠ å¤©æ°”ä¿¡æ¯åˆ°å½“å‰å“åº”ä¸­
                        if (responseElement.innerHTML.indexOf('travel-suggestion-card') > -1) {
                            // åœ¨è·¯çº¿æ¨èå‰æ’å…¥å¤©æ°”ä¿¡æ¯
                            responseElement.innerHTML = responseElement.innerHTML.replace(
                                '<div class="travel-suggestion-card mt-4">',
                                weatherHTML + '<div class="travel-suggestion-card mt-4">'
                            );
                            
                            // ä¸ºäº†åœ¨DeepSeekåŠ©æ‰‹å›ç­”ä¸­åŠ å…¥å¤©æ°”ç›¸å…³å»ºè®®
                            // ä¿å­˜å¤©æ°”æ•°æ®åˆ°å…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
                            window.lastWeatherData = weatherData;
                            
                            // æå–å½“å‰è·¯çº¿æ•°æ®ç”¨äºæ›´æ–°æ¨è
                            try {
                                // å¯»æ‰¾æ‰€æœ‰è·¯çº¿ä¿¡æ¯
                                const dayRoutes = Array.from(responseElement.querySelectorAll('.day-route')).map(dayEl => {
                                    return Array.from(dayEl.querySelectorAll('.poi-item')).map(poiEl => {
                                        const nameEl = poiEl.querySelector('.poi-name');
                                        const descEl = poiEl.querySelector('.poi-desc');
                                        return {
                                            name: nameEl?.textContent || '',
                                            description: descEl?.textContent || '',
                                            // å°è¯•åˆ¤æ–­æ˜¯å¦ä¸ºå®¤å†…æ™¯ç‚¹
                                            indoor: nameEl?.textContent.includes('åšç‰©é¦†') || 
                                                    nameEl?.textContent.includes('ç¾æœ¯é¦†') || 
                                                    nameEl?.textContent.includes('å±•è§ˆé¦†')
                                        };
                                    });
                                });
                                
                                if (dayRoutes.length > 0) {
                                    // æ›´æ–°è·¯çº¿æ¨èï¼ŒåŸºäºå¤©æ°”æƒ…å†µ
                                    updateRouteRecommendation(weatherData, dayRoutes, location);
                                }
                            } catch (e) {
                                console.error("è§£æè·¯çº¿æ•°æ®å¤±è´¥:", e);
                            }
                        } else {
                            // ç›´æ¥æ·»åŠ åˆ°å“åº”æœ«å°¾
                            responseElement.innerHTML += weatherHTML;
                        }
                    })
                    .catch(error => {
                        console.error("è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥:", error);
                        
                        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨å¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                        const weatherLoading = responseElement.querySelector('.weather-loading');
                        if (weatherLoading) {
                            weatherLoading.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                æ— æ³•åŠ è½½${location}å¤©æ°”ä¿¡æ¯: ${error.message}
                            </div>`;
                        }
                        
                        // 5ç§’åç§»é™¤é”™è¯¯æ¶ˆæ¯
                        setTimeout(() => {
                            const weatherLoading = responseElement.querySelector('.weather-loading');
                            if (weatherLoading) {
                                weatherLoading.remove();
                            }
                        }, 5000);
                    });
            }
            
            // åˆ›å»ºå¤©æ°”ä¿¡æ¯å°éƒ¨ä»¶
            function createWeatherWidget(weatherData) {
                // å¦‚æœæ²¡æœ‰å¤©æ°”æ•°æ®ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
                if (!weatherData || !weatherData.current) return '';
                
                const current = weatherData.current;
                const forecast = weatherData.forecast?.forecastday || [];
                
                // è·å–å¤©æ°”å›¾æ ‡
                const getWeatherIcon = (condition) => {
                    const code = condition?.code;
                    const isDay = condition?.is_day === 1;
                    
                    // åŸºäºå¤©æ°”ä»£ç å’Œæ—¶é—´è¿”å›å¯¹åº”çš„Bootstrapå›¾æ ‡
                    if (code >= 1000 && code <= 1003) { // æ™´/å¤šäº‘
                        return isDay ? 'bi-sun' : 'bi-moon-stars';
                    } else if (code >= 1004 && code <= 1009) { // é˜´/å¤šäº‘
                        return 'bi-cloud';
                    } else if (code >= 1030 && code <= 1039) { // é›¾/éœ¾
                        return 'bi-cloud-fog';
                    } else if (code >= 1063 && code <= 1069) { // å°é›¨
                        return 'bi-cloud-drizzle';
                    } else if (code >= 1180 && code <= 1195) { // ä¸­åˆ°å¤§é›¨
                        return 'bi-cloud-rain';
                    } else if (code >= 1196 && code <= 1201) { // å†»é›¨
                        return 'bi-cloud-sleet';
                    } else if (code >= 1204 && code <= 1237) { // é›ª/å†°é›¹
                        return 'bi-cloud-snow';
                    } else if (code >= 1273 && code <= 1282) { // é›·é›¨
                        return 'bi-cloud-lightning-rain';
                    }
                    
                    return 'bi-cloud'; // é»˜è®¤å›¾æ ‡
                };
                
                // åˆ›å»ºå¤©æ°”å°éƒ¨ä»¶HTML
                let html = `
                <div class="weather-widget mt-3 mb-3" style="background: linear-gradient(to right, #41C1F0, #2272EB); color: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="current-weather d-flex align-items-center">
                            <i class="${getWeatherIcon(current.condition)}" style="font-size: 2.5rem; margin-right: 15px;"></i>
                            <div>
                                <h5 class="mb-0" style="font-size: 20px; font-weight: bold;">${weatherData.location?.name || 'æœªçŸ¥ä½ç½®'}</h5>
                                <p class="mb-0" style="font-size: 14px;">${current.condition?.text || 'æœªçŸ¥å¤©æ°”'}, ${current.temp_c}Â°C</p>
                            </div>
                        </div>
                        <div class="weather-details text-end">
                            <p class="mb-0" style="font-size: 14px;">æ¹¿åº¦: ${current.humidity}%</p>
                            <p class="mb-0" style="font-size: 14px;">é£é€Ÿ: ${current.wind_kph} km/h</p>
                        </div>
                    </div>`;
                
                // æ·»åŠ æœªæ¥å¤©æ°”é¢„æŠ¥
                if (forecast.length > 0) {
                    html += `
                    <div class="weather-forecast mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.3);">
                        <h6 style="font-size: 16px; margin-bottom: 10px;">æœªæ¥å¤©æ°”é¢„æŠ¥</h6>
                        <div class="d-flex justify-content-between">`;
                    
                    // æœ€å¤šæ˜¾ç¤º3å¤©çš„é¢„æŠ¥
                    const maxDays = Math.min(forecast.length, 3);
                    for (let i = 0; i < maxDays; i++) {
                        const day = forecast[i];
                        const date = new Date(day.date);
                        const dayNames = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                        const dayName = dayNames[date.getDay()];
                        
                        html += `
                        <div class="forecast-day text-center" style="flex: 1;">
                            <p class="mb-1" style="font-size: 14px;">${dayName}</p>
                            <i class="${getWeatherIcon(day.day.condition)}" style="font-size: 1.5rem;"></i>
                            <p class="mb-0 mt-1" style="font-size: 14px;">${day.day.maxtemp_c}Â° / ${day.day.mintemp_c}Â°</p>
                        </div>`;
                    }
                    
                    html += `
                        </div>
                    </div>`;
                }
                
                // æ·»åŠ æ—…è¡Œå»ºè®®
                html += `
                    <div class="weather-travel-tips mt-3 pt-3" style="border-top: 1px solid rgba(255,255,255,0.3);">
                        <h6 style="font-size: 16px; margin-bottom: 10px;">å¤©æ°”æ—…è¡Œå»ºè®®</h6>
                        <p class="mb-0" style="font-size: 14px;">`;
                
                // æ ¹æ®å¤©æ°”çŠ¶å†µæä¾›å»ºè®®
                const condition = current.condition?.text || '';
                const temp = current.temp_c || 0;
                
                if (condition.includes('é›¨')) {
                    html += 'è®°å¾—æºå¸¦é›¨ä¼ï¼Œé€‰æ‹©å®¤å†…æ™¯ç‚¹æ¸¸è§ˆæ›´åˆé€‚ã€‚';
                } else if (condition.includes('é›ª')) {
                    html += 'è¯·æ³¨æ„ä¿æš–ï¼Œè·¯é¢å¯èƒ½æ¹¿æ»‘ï¼Œæ³¨æ„å®‰å…¨ã€‚';
                } else if (condition.includes('æ™´') && temp > 28) {
                    html += 'å¤©æ°”ç‚çƒ­ï¼Œè¯·åšå¥½é˜²æ™’ï¼Œå¤šè¡¥å……æ°´åˆ†ï¼Œé¿å…ä¸­åˆé«˜æ¸©æ—¶æ®µæˆ·å¤–æ´»åŠ¨ã€‚';
                } else if (condition.includes('æ™´') || condition.includes('å¤šäº‘')) {
                    html += 'å¤©æ°”é€‚å®œå‡ºè¡Œï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨å’Œæ‹ç…§ã€‚';
                } else if (condition.includes('é›¾') || condition.includes('éœ¾')) {
                    html += 'èƒ½è§åº¦è¾ƒä½ï¼Œæ³¨æ„äº¤é€šå®‰å…¨ï¼Œå¯è€ƒè™‘è°ƒæ•´ä¸ºå®¤å†…æ™¯ç‚¹ã€‚';
                } else {
                    html += 'å»ºè®®å…³æ³¨å®æ—¶å¤©æ°”å˜åŒ–ï¼Œçµæ´»è°ƒæ•´å‡ºè¡Œè®¡åˆ’ã€‚';
                }
                
                html += `
                        </p>
                    </div>
                </div>`;
                
                return html;
            }
            
            // æ›´æ–°å¤©æ°”ç›¸å…³çš„æ—…æ¸¸æ¨è
            function updateRouteRecommendation(weatherData, routes, city) {
                if (!weatherData || !weatherData.current || !routes || routes.length === 0) return;
                
                const responseElement = document.getElementById('currentResponse');
                if (!responseElement) return;
                
                const condition = weatherData.current.condition?.text || '';
                const temp = weatherData.current.temp_c || 0;
                
                // å¯»æ‰¾æ—…è¡Œå»ºè®®æ®µè½
                const travelTipsElements = responseElement.querySelectorAll('.travel-tips p');
                if (travelTipsElements.length === 0) return;
                
                // æ ¹æ®å¤©æ°”çŠ¶å†µæ·»åŠ ç‰¹å®šå»ºè®®
                let weatherSpecificTip = document.createElement('p');
                weatherSpecificTip.className = 'mb-1';
                weatherSpecificTip.style.fontSize = '14px';
                weatherSpecificTip.style.color = '#555';
                
                if (condition.includes('é›¨')) {
                    weatherSpecificTip.innerHTML = '<strong>å¤©æ°”æé†’ï¼š</strong> é¢„è®¡æœ‰é›¨ï¼Œå»ºè®®è°ƒæ•´ä¸ºå‚è§‚åšç‰©é¦†ã€ç¾æœ¯é¦†ç­‰å®¤å†…æ™¯ç‚¹ï¼Œæˆ–å‡†å¤‡é›¨å…·ã€‚';
                    
                    // åœ¨è·¯çº¿ä¸­æ‰¾åˆ°å®¤å†…æ™¯ç‚¹å¹¶æ·»åŠ æ ‡è®°
                    routes.forEach((dayRoute, dayIndex) => {
                        dayRoute.forEach((poi, poiIndex) => {
                            if (poi.indoor === true || 
                                (poi.name && (
                                    poi.name.includes('åšç‰©é¦†') || 
                                    poi.name.includes('ç¾æœ¯é¦†') || 
                                    poi.name.includes('å±•è§ˆ') ||
                                    poi.name.includes('èŒ¶é¦†')
                                ))) {
                                // æ‰¾åˆ°å¯¹åº”çš„POIé¡¹æ·»åŠ æ¨èæ ‡è®°
                                const poiItems = responseElement.querySelectorAll('.day-route');
                                if (poiItems.length > dayIndex) {
                                    const poiElements = poiItems[dayIndex].querySelectorAll('.poi-item');
                                    if (poiElements.length > poiIndex) {
                                        const nameElement = poiElements[poiIndex].querySelector('.poi-name');
                                        if (nameElement) {
                                            nameElement.innerHTML += ' <span style="color: #2196F3; font-size: 12px;">(é›¨å¤©æ¨è)</span>';
                                        }
                                    }
                                }
                            }
                        });
                    });
                } else if (condition.includes('æ™´') && temp > 28) {
                    weatherSpecificTip.innerHTML = '<strong>å¤©æ°”æé†’ï¼š</strong> å¤©æ°”ç‚çƒ­ï¼Œå»ºè®®é¿å¼€ä¸­åˆé«˜æ¸©æ—¶æ®µï¼Œé€‰æ‹©æ¸…æ™¨æˆ–å‚æ™šæ¸¸è§ˆæˆ·å¤–æ™¯ç‚¹ã€‚';
                } else if (condition.includes('é›¾') || condition.includes('éœ¾')) {
                    weatherSpecificTip.innerHTML = '<strong>å¤©æ°”æé†’ï¼š</strong> èƒ½è§åº¦è¾ƒä½ï¼Œæ‹ç…§æ•ˆæœå¯èƒ½å—å½±å“ï¼Œå»ºè®®è°ƒæ•´æœŸæœ›æˆ–é€‰æ‹©è¿‘è·ç¦»è§‚èµçš„æ™¯ç‚¹ã€‚';
                } else {
                    weatherSpecificTip.innerHTML = '<strong>å¤©æ°”æé†’ï¼š</strong> å¤©æ°”é€‚å®œï¼ŒæŒ‰è®¡åˆ’æ¸¸è§ˆå³å¯ï¼Œæ™¯è‰²ä¼šå¾ˆæ£’ï¼';
                }
                
                // æ·»åŠ åˆ°æ—…è¡Œå»ºè®®çš„æœ€å
                travelTipsElements[travelTipsElements.length - 1].parentNode.appendChild(weatherSpecificTip);
            }
        });
    </script>
    
    <!-- Markdownç¼–è¾‘å™¨å¢å¼ºåŠŸèƒ½ -->
    <script>
        // æ·»åŠ åˆ†å±Markdownç¼–è¾‘/é¢„è§ˆåŠŸèƒ½
        function enhanceMarkdownDisplay() {
            // æ·»åŠ å¿…è¦çš„CSSæ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .markdown-container {
                    display: flex;
                    flex-direction: column;
                    border: 1px solid #e1e4e8;
                    border-radius: 6px;
                    overflow: hidden;
                    margin-bottom: 20px;
                }
                
                .markdown-toolbar {
                    display: flex;
                    padding: 8px;
                    background-color: #f6f8fa;
                    border-bottom: 1px solid #e1e4e8;
                    flex-wrap: wrap;
                }
                
                .markdown-toolbar button {
                    background-color: transparent;
                    border: 1px solid #e1e4e8;
                    border-radius: 3px;
                    color: #24292e;
                    cursor: pointer;
                    font-size: 14px;
                    margin-right: 4px;
                    padding: 4px 8px;
                    transition: background-color 0.2s;
                }
                
                .markdown-toolbar button:hover {
                    background-color: #e1e4e8;
                }
                
                .markdown-toolbar button.active {
                    background-color: #ddf4ff;
                    border-color: #54aeff;
                    color: #0969da;
                }
                
                .markdown-view-options {
                    margin-left: auto;
                }
                
                .markdown-content-area {
                    display: flex;
                    height: 300px;
                    border-top: 1px solid #e1e4e8;
                }
                
                .markdown-editor {
                    flex: 1;
                    border: none;
                    padding: 16px;
                    resize: none;
                    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                    font-size: 14px;
                    line-height: 1.5;
                    overflow: auto;
                }
                
                .markdown-editor:focus {
                    outline: none;
                }
                
                .markdown-preview {
                    flex: 1;
                    padding: 16px;
                    border-left: 1px solid #e1e4e8;
                    overflow: auto;
                }
                
                .markdown-preview.hidden,
                .markdown-editor.hidden {
                    display: none;
                }
                
                .markdown-preview.full-width,
                .markdown-editor.full-width {
                    flex: 1;
                    border-left: none;
                }
                
                /* æ˜¾ç¤ºæºä»£ç çš„æ ·å¼ */
                .markdown-source-view pre {
                    margin: 0;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    background-color: #f6f8fa;
                    padding: 16px;
                    border-radius: 6px;
                    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
                    font-size: 14px;
                    line-height: 1.5;
                    color: #24292e;
                    overflow: auto;
                }
                
                /* é«˜äº®è¯­æ³•æ ·å¼ */
                .markdown-editor .keyword { color: #d73a49; }
                .markdown-editor .string { color: #032f62; }
                .markdown-editor .comment { color: #6a737d; }
                .markdown-editor .heading { color: #005cc5; font-weight: bold; }
                .markdown-editor .list { color: #6f42c1; }
            `;
            document.head.appendChild(style);
            
            // ä¿®æ”¹addMessageå‡½æ•°ï¼Œä¸ºå“åº”æ·»åŠ Markdownç¼–è¾‘å™¨ç•Œé¢
            const originalAddMessage = window.addMessage;
            window.addMessage = function(text, isUser, showReasoning = false) {
                // è°ƒç”¨åŸå§‹å‡½æ•°åˆ›å»ºæ¶ˆæ¯å®¹å™¨
                const messageContainer = originalAddMessage(text, isUser, showReasoning);
                
                // å¦‚æœæ˜¯AIå“åº”ï¼Œæ·»åŠ Markdownç¼–è¾‘å™¨ç•Œé¢
                if (!isUser && showReasoning) {
                    const responseElement = messageContainer.querySelector('#currentResponse');
                    const reasoningElement = messageContainer.querySelector('.reasoning-content');
                    
                    if (responseElement) {
                        // ä¿å­˜åŸå§‹å†…å®¹
                        const originalContent = responseElement.innerHTML;
                        
                        // æ¸…ç©ºåŸå§‹å†…å®¹
                        responseElement.innerHTML = '';
                        
                        // åˆ›å»ºMarkdownç¼–è¾‘å™¨å®¹å™¨
                        const markdownContainer = document.createElement('div');
                        markdownContainer.className = 'markdown-container';
                        
                        // åˆ›å»ºå·¥å…·æ 
                        const toolbar = document.createElement('div');
                        toolbar.className = 'markdown-toolbar';
                        
                        // å¸¸ç”¨çš„Markdownå¿«æ·æŒ‰é’®
                        const buttons = [
                            { icon: 'bi-type-bold', title: 'åŠ ç²—', action: 'bold', markup: '**æ–‡æœ¬**' },
                            { icon: 'bi-type-italic', title: 'æ–œä½“', action: 'italic', markup: '*æ–‡æœ¬*' },
                            { icon: 'bi-code', title: 'ä»£ç ', action: 'code', markup: '`ä»£ç `' },
                            { icon: 'bi-link', title: 'é“¾æ¥', action: 'link', markup: '[é“¾æ¥æ–‡æœ¬](http://...)' },
                            { icon: 'bi-list-ul', title: 'æ— åºåˆ—è¡¨', action: 'unordered-list', markup: '- åˆ—è¡¨é¡¹\n- åˆ—è¡¨é¡¹' },
                            { icon: 'bi-list-ol', title: 'æœ‰åºåˆ—è¡¨', action: 'ordered-list', markup: '1. åˆ—è¡¨é¡¹\n2. åˆ—è¡¨é¡¹' },
                            { icon: 'bi-blockquote-left', title: 'å¼•ç”¨', action: 'quote', markup: '> å¼•ç”¨æ–‡æœ¬' },
                            { icon: 'bi-code-square', title: 'ä»£ç å—', action: 'codeblock', markup: '```\nä»£ç å—\n```' },
                            { icon: 'bi-type-h1', title: 'æ ‡é¢˜1', action: 'h1', markup: '# æ ‡é¢˜1' },
                            { icon: 'bi-type-h2', title: 'æ ‡é¢˜2', action: 'h2', markup: '## æ ‡é¢˜2' },
                            { icon: 'bi-type-h3', title: 'æ ‡é¢˜3', action: 'h3', markup: '### æ ‡é¢˜3' },
                        ];
                        
                        buttons.forEach(btn => {
                            const button = document.createElement('button');
                            button.innerHTML = `<i class="${btn.icon}"></i>`;
                            button.title = btn.title;
                            button.dataset.action = btn.action;
                            button.dataset.markup = btn.markup;
                            button.addEventListener('click', (e) => insertMarkup(e.target.closest('button').dataset.markup));
                            toolbar.appendChild(button);
                        });
                        
                        // æ·»åŠ è§†å›¾åˆ‡æ¢é€‰é¡¹
                        const viewOptions = document.createElement('div');
                        viewOptions.className = 'markdown-view-options';
                        
                        const editBtn = document.createElement('button');
                        editBtn.innerHTML = '<i class="bi bi-pencil"></i> ç¼–è¾‘';
                        editBtn.title = 'ç¼–è¾‘æ¨¡å¼';
                        editBtn.dataset.view = 'edit';
                        editBtn.classList.add('active');
                        
                        const splitBtn = document.createElement('button');
                        splitBtn.innerHTML = '<i class="bi bi-layout-split"></i> åˆ†å±';
                        splitBtn.title = 'åˆ†å±æ¨¡å¼';
                        splitBtn.dataset.view = 'split';
                        
                        const previewBtn = document.createElement('button');
                        previewBtn.innerHTML = '<i class="bi bi-eye"></i> é¢„è§ˆ';
                        previewBtn.title = 'é¢„è§ˆæ¨¡å¼';
                        previewBtn.dataset.view = 'preview';
                        
                        // æ·»åŠ è§†å›¾åˆ‡æ¢äº‹ä»¶
                        [editBtn, splitBtn, previewBtn].forEach(btn => {
                            btn.addEventListener('click', function() {
                                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                                [editBtn, splitBtn, previewBtn].forEach(b => b.classList.remove('active'));
                                // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                                this.classList.add('active');
                                
                                // æ ¹æ®é€‰æ‹©çš„è§†å›¾è°ƒæ•´ç¼–è¾‘å™¨å’Œé¢„è§ˆåŒºåŸŸ
                                const view = this.dataset.view;
                                const editor = markdownContainer.querySelector('.markdown-editor');
                                const preview = markdownContainer.querySelector('.markdown-preview');
                                
                                if (view === 'edit') {
                                    editor.classList.remove('hidden');
                                    editor.classList.add('full-width');
                                    preview.classList.add('hidden');
                                    preview.classList.remove('full-width');
                                } else if (view === 'preview') {
                                    editor.classList.add('hidden');
                                    editor.classList.remove('full-width');
                                    preview.classList.remove('hidden');
                                    preview.classList.add('full-width');
                                } else { // split
                                    editor.classList.remove('hidden', 'full-width');
                                    preview.classList.remove('hidden', 'full-width');
                                }
                            });
                            viewOptions.appendChild(btn);
                        });
                        
                        toolbar.appendChild(viewOptions);
                        markdownContainer.appendChild(toolbar);
                        
                        // åˆ›å»ºç¼–è¾‘å’Œé¢„è§ˆåŒºåŸŸ
                        const contentArea = document.createElement('div');
                        contentArea.className = 'markdown-content-area';
                        
                        // åˆ›å»ºç¼–è¾‘å™¨
                        const editor = document.createElement('textarea');
                        editor.className = 'markdown-editor';
                        editor.placeholder = 'è¾“å…¥Markdownæ–‡æœ¬...';
                        // è®¾ç½®åˆå§‹æ–‡æœ¬
                        editor.value = originalContent.replace(/<[^>]*>/g, ''); // ç®€å•å»é™¤HTMLæ ‡ç­¾
                        
                        // åˆ›å»ºé¢„è§ˆåŒº
                        const preview = document.createElement('div');
                        preview.className = 'markdown-preview';
                        // è®¾ç½®åˆå§‹é¢„è§ˆå†…å®¹
                        try {
                            preview.innerHTML = window.renderMarkdown(editor.value);
                        } catch (error) {
                            preview.innerHTML = '<p>é¢„è§ˆåŠ è½½å¤±è´¥</p>';
                            console.error('é¢„è§ˆåŠ è½½å¤±è´¥:', error);
                        }
                        
                        // å½“ç¼–è¾‘å™¨å†…å®¹å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
                        editor.addEventListener('input', function() {
                            try {
                                const markdown = this.value;
                                preview.innerHTML = window.renderMarkdown(markdown);
                            } catch (error) {
                                preview.innerHTML = '<p>é¢„è§ˆåŠ è½½å¤±è´¥</p>';
                                console.error('é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                            }
                        });
                        
                        // æ’å…¥æ ‡è®°çš„å‡½æ•°
                        function insertMarkup(markup) {
                            const start = editor.selectionStart;
                            const end = editor.selectionEnd;
                            const selectedText = editor.value.substring(start, end);
                            
                            let replacement = markup;
                            if (selectedText) {
                                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ›¿æ¢æ‰æ ‡è®°ä¸­çš„å ä½ç¬¦
                                if (markup.includes('æ–‡æœ¬')) {
                                    replacement = markup.replace('æ–‡æœ¬', selectedText);
                                } else if (markup.includes('é“¾æ¥æ–‡æœ¬')) {
                                    replacement = markup.replace('é“¾æ¥æ–‡æœ¬', selectedText);
                                } else if (markup.includes('ä»£ç ') && !markup.includes('ä»£ç å—')) {
                                    replacement = markup.replace('ä»£ç ', selectedText);
                                } else if (markup.includes('ä»£ç å—')) {
                                    replacement = "```\n" + selectedText + "\n```";
                                } else if (markup.includes('å¼•ç”¨æ–‡æœ¬')) {
                                    replacement = markup.replace('å¼•ç”¨æ–‡æœ¬', selectedText);
                                } else if (markup.includes('æ ‡é¢˜')) {
                                    if (markup.includes('# æ ‡é¢˜1')) {
                                        replacement = "# " + selectedText;
                                    } else if (markup.includes('## æ ‡é¢˜2')) {
                                        replacement = "## " + selectedText;
                                    } else if (markup.includes('### æ ‡é¢˜3')) {
                                        replacement = "### " + selectedText;
                                    }
                                } else if (markup.includes('åˆ—è¡¨é¡¹')) {
                                    // å¤„ç†åˆ—è¡¨é¡¹ï¼Œä¸ºæ¯è¡Œå‰é¢æ·»åŠ ç›¸åº”çš„æ ‡è®°
                                    const lines = selectedText.split('\n');
                                    if (markup.startsWith('-')) {
                                        replacement = lines.map(line => `- ${line}`).join('\n');
                                    } else if (markup.startsWith('1.')) {
                                        replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                                    }
                                }
                            }
                            
                            // æ’å…¥å†…å®¹
                            editor.focus();
                            document.execCommand('insertText', false, replacement);
                            
                            // æ›´æ–°é¢„è§ˆ
                            try {
                                preview.innerHTML = window.renderMarkdown(editor.value);
                            } catch (error) {
                                console.error('é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                            }
                        }
                        
                        // æ·»åŠ åˆ°å®¹å™¨
                        contentArea.appendChild(editor);
                        contentArea.appendChild(preview);
                        markdownContainer.appendChild(contentArea);
                        
                        // å°†Markdownç¼–è¾‘å™¨æ·»åŠ åˆ°å“åº”å…ƒç´ 
                        responseElement.appendChild(markdownContainer);
                        
                        // å¦‚æœæœ‰æ¨ç†å…ƒç´ ï¼Œä¹Ÿåº”ç”¨åŒæ ·çš„å¤„ç†
                        if (reasoningElement) {
                            const reasoningOriginalContent = reasoningElement.innerHTML;
                            // æ¸…ç©ºåŸå§‹å†…å®¹
                            reasoningElement.innerHTML = '';
                            
                            // åˆ›å»ºMarkdownç¼–è¾‘å™¨å®¹å™¨
                            const reasoningMarkdownContainer = document.createElement('div');
                            reasoningMarkdownContainer.className = 'markdown-container';
                            
                            // å¤åˆ¶å·¥å…·æ 
                            const reasoningToolbar = toolbar.cloneNode(true);
                            // é‡æ–°æ·»åŠ äº‹ä»¶
                            reasoningToolbar.querySelectorAll('button[data-markup]').forEach(btn => {
                                btn.addEventListener('click', (e) => {
                                    const reasoningEditor = reasoningMarkdownContainer.querySelector('.markdown-editor');
                                    insertReasoningMarkup(e.target.closest('button').dataset.markup, reasoningEditor);
                                });
                            });
                            
                            // å¤„ç†è§†å›¾åˆ‡æ¢æŒ‰é’®
                            const reasoningViewBtns = reasoningToolbar.querySelectorAll('.markdown-view-options button');
                            reasoningViewBtns.forEach(btn => {
                                btn.addEventListener('click', function() {
                                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeç±»
                                    reasoningViewBtns.forEach(b => b.classList.remove('active'));
                                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeç±»
                                    this.classList.add('active');
                                    
                                    // æ ¹æ®é€‰æ‹©çš„è§†å›¾è°ƒæ•´ç¼–è¾‘å™¨å’Œé¢„è§ˆåŒºåŸŸ
                                    const view = this.dataset.view;
                                    const editor = reasoningMarkdownContainer.querySelector('.markdown-editor');
                                    const preview = reasoningMarkdownContainer.querySelector('.markdown-preview');
                                    
                                    if (view === 'edit') {
                                        editor.classList.remove('hidden');
                                        editor.classList.add('full-width');
                                        preview.classList.add('hidden');
                                        preview.classList.remove('full-width');
                                    } else if (view === 'preview') {
                                        editor.classList.add('hidden');
                                        editor.classList.remove('full-width');
                                        preview.classList.remove('hidden');
                                        preview.classList.add('full-width');
                                    } else { // split
                                        editor.classList.remove('hidden', 'full-width');
                                        preview.classList.remove('hidden', 'full-width');
                                    }
                                });
                            });
                            
                            reasoningMarkdownContainer.appendChild(reasoningToolbar);
                            
                            // åˆ›å»ºç¼–è¾‘å’Œé¢„è§ˆåŒºåŸŸ
                            const reasoningContentArea = document.createElement('div');
                            reasoningContentArea.className = 'markdown-content-area';
                            
                            // åˆ›å»ºç¼–è¾‘å™¨
                            const reasoningEditor = document.createElement('textarea');
                            reasoningEditor.className = 'markdown-editor';
                            reasoningEditor.placeholder = 'è¾“å…¥æ¨ç†è¿‡ç¨‹çš„Markdownæ–‡æœ¬...';
                            // è®¾ç½®åˆå§‹æ–‡æœ¬
                            reasoningEditor.value = reasoningOriginalContent.replace(/<[^>]*>/g, ''); // ç®€å•å»é™¤HTMLæ ‡ç­¾
                            
                            // åˆ›å»ºé¢„è§ˆåŒº
                            const reasoningPreview = document.createElement('div');
                            reasoningPreview.className = 'markdown-preview';
                            // è®¾ç½®åˆå§‹é¢„è§ˆå†…å®¹
                            try {
                                reasoningPreview.innerHTML = window.renderMarkdown(reasoningEditor.value);
                            } catch (error) {
                                reasoningPreview.innerHTML = '<p>é¢„è§ˆåŠ è½½å¤±è´¥</p>';
                                console.error('æ¨ç†é¢„è§ˆåŠ è½½å¤±è´¥:', error);
                            }
                            
                            // å½“ç¼–è¾‘å™¨å†…å®¹å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
                            reasoningEditor.addEventListener('input', function() {
                                try {
                                    const markdown = this.value;
                                    reasoningPreview.innerHTML = window.renderMarkdown(markdown);
                                } catch (error) {
                                    reasoningPreview.innerHTML = '<p>é¢„è§ˆåŠ è½½å¤±è´¥</p>';
                                    console.error('æ¨ç†é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                                }
                            });
                            
                            // æ’å…¥æ ‡è®°çš„å‡½æ•°
                            function insertReasoningMarkup(markup, editor) {
                                const start = editor.selectionStart;
                                const end = editor.selectionEnd;
                                const selectedText = editor.value.substring(start, end);
                                
                                let replacement = markup;
                                if (selectedText) {
                                    // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œæ›¿æ¢æ‰æ ‡è®°ä¸­çš„å ä½ç¬¦
                                    if (markup.includes('æ–‡æœ¬')) {
                                        replacement = markup.replace('æ–‡æœ¬', selectedText);
                                    } else if (markup.includes('é“¾æ¥æ–‡æœ¬')) {
                                        replacement = markup.replace('é“¾æ¥æ–‡æœ¬', selectedText);
                                    } else if (markup.includes('ä»£ç ') && !markup.includes('ä»£ç å—')) {
                                        replacement = markup.replace('ä»£ç ', selectedText);
                                    } else if (markup.includes('ä»£ç å—')) {
                                        replacement = "```\n" + selectedText + "\n```";
                                    } else if (markup.includes('å¼•ç”¨æ–‡æœ¬')) {
                                        replacement = markup.replace('å¼•ç”¨æ–‡æœ¬', selectedText);
                                    } else if (markup.includes('æ ‡é¢˜')) {
                                        if (markup.includes('# æ ‡é¢˜1')) {
                                            replacement = "# " + selectedText;
                                        } else if (markup.includes('## æ ‡é¢˜2')) {
                                            replacement = "## " + selectedText;
                                        } else if (markup.includes('### æ ‡é¢˜3')) {
                                            replacement = "### " + selectedText;
                                        }
                                    } else if (markup.includes('åˆ—è¡¨é¡¹')) {
                                        // å¤„ç†åˆ—è¡¨é¡¹ï¼Œä¸ºæ¯è¡Œå‰é¢æ·»åŠ ç›¸åº”çš„æ ‡è®°
                                        const lines = selectedText.split('\n');
                                        if (markup.startsWith('-')) {
                                            replacement = lines.map(line => `- ${line}`).join('\n');
                                        } else if (markup.startsWith('1.')) {
                                            replacement = lines.map((line, index) => `${index + 1}. ${line}`).join('\n');
                                        }
                                    }
                                }
                                
                                // æ’å…¥å†…å®¹
                                editor.focus();
                                document.execCommand('insertText', false, replacement);
                                
                                // æ›´æ–°é¢„è§ˆ
                                try {
                                    reasoningPreview.innerHTML = window.renderMarkdown(editor.value);
                                } catch (error) {
                                    console.error('æ¨ç†é¢„è§ˆæ›´æ–°å¤±è´¥:', error);
                                }
                            }
                            
                            // æ·»åŠ åˆ°å®¹å™¨
                            reasoningContentArea.appendChild(reasoningEditor);
                            reasoningContentArea.appendChild(reasoningPreview);
                            reasoningMarkdownContainer.appendChild(reasoningContentArea);
                            
                            // å°†Markdownç¼–è¾‘å™¨æ·»åŠ åˆ°æ¨ç†å…ƒç´ 
                            reasoningElement.appendChild(reasoningMarkdownContainer);
                        }
                    }
                }
                
                return messageContainer;
            };
            
            // ä¿®æ”¹getStreamingResponseå‡½æ•°ï¼Œä½¿å…¶æ”¯æŒMarkdownç¼–è¾‘å™¨
            const originalGetStreamingResponse = window.getStreamingResponse;
            window.getStreamingResponse = function(userMessage) {
                console.log("å¼€å§‹è·å–LLMæµå¼å“åº”ï¼ˆå¢å¼ºç‰ˆï¼‰...");
                
                // ç¦ç”¨å‘é€æŒ‰é’®
                const sendButton = document.getElementById('sendButton');
                if (sendButton) sendButton.disabled = true;
                
                // æ‰¾åˆ°å“åº”å’Œæ¨ç†å…ƒç´ 
                const responseElement = document.querySelector('#currentResponse');
                const reasoningElement = window.lastReasoningContainer ? 
                    window.lastReasoningContainer.querySelector('.reasoning-content') : null;
                
                if (!responseElement) {
                    console.error("æ‰¾ä¸åˆ°å“åº”å…ƒç´  #currentResponse");
                    return;
                }
                
                // æŸ¥æ‰¾Markdownç¼–è¾‘å™¨å…ƒç´ 
                const responseEditor = responseElement.querySelector('.markdown-editor');
                const responsePreview = responseElement.querySelector('.markdown-preview');
                const reasoningEditor = reasoningElement ? reasoningElement.querySelector('.markdown-editor') : null;
                const reasoningPreview = reasoningElement ? reasoningElement.querySelector('.markdown-preview') : null;
                
                // åˆ›å»ºEventSourceå¯¹è±¡
                const url = `/api/chat?prompt=${encodeURIComponent(userMessage)}`;
                console.log("è¿æ¥åˆ°SSE API: ", url);
                const eventSource = new EventSource(url);
                
                let currentReasoningText = '';
                let currentResponseText = '';
                
                // ç›‘å¬æ¶ˆæ¯
                eventSource.onmessage = function(event) {
                    console.log("æ”¶åˆ°SSEæ¶ˆæ¯:", event.data);
                    try {
                        const data = JSON.parse(event.data);
                        
                        // å¤„ç†æ¨ç†å†…å®¹
                        if (data.type === "reasoning" && data.content) {
                            currentReasoningText += data.content;
                            
                            // å¦‚æœæœ‰Markdownç¼–è¾‘å™¨ï¼Œæ›´æ–°ç¼–è¾‘å™¨å†…å®¹å’Œé¢„è§ˆ
                            if (reasoningEditor && reasoningPreview) {
                                try {
                                    reasoningEditor.value = currentReasoningText;
                                    reasoningPreview.innerHTML = window.renderMarkdown(currentReasoningText);
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“æ¨ç†å†…å®¹æ—¶å‡ºé”™:", renderError);
                                    reasoningPreview.textContent = currentReasoningText;
                                }
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                reasoningEditor.scrollTop = reasoningEditor.scrollHeight;
                                reasoningPreview.scrollTop = reasoningPreview.scrollHeight;
                            } 
                            // å¦åˆ™ä½¿ç”¨åŸå§‹æ–¹æ³•æ›´æ–°æ¨ç†å†…å®¹
                            else if (reasoningElement) {
                                try {
                                    reasoningElement.innerHTML = window.renderMarkdown(currentReasoningText);
                                    if (reasoningElement.scrollHeight) {
                                        reasoningElement.scrollTop = reasoningElement.scrollHeight;
                                    }
                                    
                                    // ç¡®ä¿æ¨ç†å†…å®¹å®¹å™¨å¯è§
                                    if (reasoningElement.classList.contains('collapsed')) {
                                        reasoningElement.classList.remove('collapsed');
                                    }
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“æ¨ç†å†…å®¹æ—¶å‡ºé”™:", renderError);
                                    reasoningElement.textContent = currentReasoningText;
                                }
                            }
                        } 
                        // å½“æ”¶åˆ°åˆ†éš”ç¬¦ï¼Œè¡¨ç¤ºæ¨ç†ç»“æŸï¼Œå¼€å§‹ç”Ÿæˆå›ç­”
                        else if (data.type === "separator") {
                            console.log("æ¨ç†ç»“æŸï¼Œå¼€å§‹ç”Ÿæˆå›ç­”");
                            // æ¸…é™¤åŠ è½½åŠ¨ç”»
                            if (!responseEditor && responseElement) {
                                responseElement.innerHTML = '';
                            }
                        } 
                        // å¤„ç†å›ç­”å†…å®¹
                        else if (data.type === "content" && data.content) {
                            currentResponseText += data.content;
                            
                            // å¦‚æœæœ‰Markdownç¼–è¾‘å™¨ï¼Œæ›´æ–°ç¼–è¾‘å™¨å†…å®¹å’Œé¢„è§ˆ
                            if (responseEditor && responsePreview) {
                                try {
                                    responseEditor.value = currentResponseText;
                                    responsePreview.innerHTML = window.renderMarkdown(currentResponseText);
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“å›ç­”å†…å®¹æ—¶å‡ºé”™:", renderError);
                                    responsePreview.textContent = currentResponseText;
                                }
                                
                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                responseEditor.scrollTop = responseEditor.scrollHeight;
                                responsePreview.scrollTop = responsePreview.scrollHeight;
                            }
                            // å¦åˆ™ä½¿ç”¨åŸå§‹æ–¹æ³•æ›´æ–°å“åº”å†…å®¹
                            else if (responseElement) {
                                try {
                                    responseElement.innerHTML = window.renderMarkdown(currentResponseText);
                                    const chatContent = document.getElementById('chatContent');
                                    if (chatContent && chatContent.scrollHeight) {
                                        chatContent.scrollTop = chatContent.scrollHeight;
                                    }
                                } catch (renderError) {
                                    console.log("æ¸²æŸ“å›ç­”å†…å®¹æ—¶å‡ºé”™:", renderError);
                                    responseElement.textContent = currentResponseText; // å›é€€åˆ°çº¯æ–‡æœ¬
                                }
                            }
                        }
                        // å¤„ç†çŸ¥è¯†å›¾è°±æ•°æ®
                        else if (data.type === "graph_data" && data.content) {
                            console.log("æ”¶åˆ°çŸ¥è¯†å›¾è°±æ•°æ®ï¼Œå‡†å¤‡æ¸²æŸ“");
                            try {
                                // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤º
                                graphLoading.classList.remove('d-none');
                                
                                // æ¸²æŸ“æ–°çš„çŸ¥è¯†å›¾è°±
                                renderGraph(data.content);
                                
                                // éšè—åŠ è½½æŒ‡ç¤º
                                graphLoading.classList.add('d-none');
                            } catch (graphError) {
                                console.error("å¤„ç†çŸ¥è¯†å›¾è°±æ•°æ®æ—¶å‡ºé”™:", graphError);
                                graphLoading.classList.add('d-none');
                            }
                        }
                        // å¤„ç†çŠ¶æ€æ¶ˆæ¯
                        else if (data.type === "status" && data.content) {
                            console.log("æ”¶åˆ°çŠ¶æ€æ¶ˆæ¯:", data.content);
                            // å¯ä»¥é€‰æ‹©å°†çŠ¶æ€æ¶ˆæ¯æ·»åŠ åˆ°æ¨ç†å†…å®¹æˆ–å…¶ä»–åœ°æ–¹
                        }
                        // å¤„ç†æµç»“æŸäº‹ä»¶
                        else if (data.type === "end") {
                            console.log("æµå¼å“åº”ç»“æŸ");
                            eventSource.close();
                            sendButton.disabled = false;
                            
                            // æå–åå¥½å¹¶è·å–è·¯çº¿æ•°æ®
                            try {
                                if (typeof window.extractPreferencesAndGetRoutes === 'function') {
                                    window.extractPreferencesAndGetRoutes(userMessage);
                                } else if (typeof extractPreferencesAndGetRoutes === 'function') {
                                    extractPreferencesAndGetRoutes(userMessage);
                                }
                            } catch (routeError) {
                                console.log("æå–åå¥½æˆ–è·å–è·¯çº¿æ—¶å‡ºé”™:", routeError);
                            }
                        }
                    } catch (error) {
                        console.error("è§£æäº‹ä»¶æ•°æ®å‡ºé”™:", error, "åŸå§‹æ•°æ®:", event.data);
                        
                        // å¦‚æœæœ‰Markdownç¼–è¾‘å™¨ï¼Œæ›´æ–°é”™è¯¯ä¿¡æ¯
                        if (responseEditor && responsePreview) {
                            responseEditor.value = "è§£æå“åº”æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚";
                            responsePreview.innerHTML = "<p>è§£æå“åº”æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚</p>";
                        }
                        // å¦åˆ™ä½¿ç”¨åŸå§‹æ–¹æ³•æ˜¾ç¤ºé”™è¯¯
                        else if (responseElement) {
                            responseElement.innerHTML = "è§£æå“åº”æ—¶å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚";
                        }
                        
                        eventSource.close();
                        if (sendButton) sendButton.disabled = false;
                    }
                };
                
                // è¿æ¥æ‰“å¼€æ—¶çš„å¤„ç†
                eventSource.onopen = function(event) {
                    console.log("SSEè¿æ¥å·²æ‰“å¼€");
                };
                
                // é”™è¯¯å¤„ç†
                eventSource.onerror = function(event) {
                    console.error("EventSourceé”™è¯¯:", event);
                    eventSource.close();
                    
                    // å¦‚æœæœ‰Markdownç¼–è¾‘å™¨ï¼Œæ›´æ–°é”™è¯¯ä¿¡æ¯
                    if (responseEditor && responsePreview) {
                        if (currentResponseText) {
                            responseEditor.value = currentResponseText;
                            try {
                                responsePreview.innerHTML = window.renderMarkdown(currentResponseText);
                            } catch (error) {
                                responsePreview.textContent = currentResponseText;
                            }
                        } else {
                            responseEditor.value = "è¿æ¥åˆ°æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚";
                            responsePreview.innerHTML = "<p>è¿æ¥åˆ°æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚</p>";
                        }
                    }
                    // å¦åˆ™ä½¿ç”¨åŸå§‹æ–¹æ³•æ˜¾ç¤ºé”™è¯¯
                    else if (responseElement) {
                        if (currentResponseText) {
                            try {
                                responseElement.innerHTML = window.renderMarkdown(currentResponseText);
                            } catch (error) {
                                responseElement.textContent = currentResponseText;
                            }
                        } else {
                            responseElement.innerHTML = "è¿æ¥åˆ°æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•ã€‚";
                        }
                    }
                    
                    if (sendButton) sendButton.disabled = false;
                };
            };
            
            console.log("Markdownç¼–è¾‘å™¨å¢å¼ºåŠŸèƒ½å·²åŠ è½½");
        }

        // åˆå§‹åŒ–å‡½æ•°
        function initMarkdownEditor() {
            // ç¡®ä¿DOMå·²åŠ è½½
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', enhanceMarkdownDisplay);
            } else {
                enhanceMarkdownDisplay();
            }
        }

        // è¿è¡Œåˆå§‹åŒ–
        initMarkdownEditor();
    </script>
</body>
</html> 